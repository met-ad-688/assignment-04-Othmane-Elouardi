<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Othmane Elouardi">
<meta name="dcterms.date" content="2025-10-08">

<title>Assignment 04 — Lab 04 Machine Learning on Scale – Othmane Elouardi Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-bb1cd4028f63a369ab283e072cb7d572.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-54c8f25464f32f8783bd446cee98020d.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-bb1cd4028f63a369ab283e072cb7d572.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-a5c3f9e00af77bef687d190550e7831c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-cd90aeab666e973ce113bdbdde63629d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-a5c3f9e00af77bef687d190550e7831c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
</script>
<script type="module">import "https://cdn.plot.ly/plotly-3.1.1.min"</script>



<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Othmane Elouardi Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assignment-04" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assignment 04</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assignment-04">    
        <li>
    <a class="dropdown-item" href="./assignment04-Lab01-othmane.html">
 <span class="dropdown-text">Lab 01 — Visual Reporting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./assignment04-Lab02-othmane.html">
 <span class="dropdown-text">Lab 02 — Insights &amp; Visualizations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./assignment04-Lab03-othmane.html">
 <span class="dropdown-text">Lab 03 — Regression Modeling on Employment Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./assignment04-Lab04-othmane.html">
 <span class="dropdown-text">Lab 04 – Machine Learning on Scale</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#load-the-dataset" id="toc-load-the-dataset" class="nav-link" data-scroll-target="#load-the-dataset"><span class="header-section-number">2</span> Load the Dataset</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering"><span class="header-section-number">3</span> Feature Engineering</a></li>
  <li><a href="#traintest-split" id="toc-traintest-split" class="nav-link" data-scroll-target="#traintest-split"><span class="header-section-number">4</span> Train/Test Split</a></li>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression"><span class="header-section-number">5</span> Linear Regression</a>
  <ul class="collapse">
  <li><a href="#generalized-linear-regression-summary" id="toc-generalized-linear-regression-summary" class="nav-link" data-scroll-target="#generalized-linear-regression-summary"><span class="header-section-number">5.1</span> Generalized Linear Regression Summary</a>
  <ul class="collapse">
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">5.1.1</span> Interpretation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#random-forest-regressor" id="toc-random-forest-regressor" class="nav-link" data-scroll-target="#random-forest-regressor"><span class="header-section-number">6</span> Random Forest Regressor</a>
  <ul class="collapse">
  <li><a href="#feature-importance-plot" id="toc-feature-importance-plot" class="nav-link" data-scroll-target="#feature-importance-plot"><span class="header-section-number">6.1</span> Feature Importance Plot</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Assignment 04 — Lab 04 Machine Learning on Scale</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Causal and Predictive Analytics in Spark</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Othmane Elouardi </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Boston University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 8, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>PySpark is applied to large-scale employment data from the Lightcast Job Postings dataset to develop and evaluate salary prediction models. The workflow involves engineering key features from structured columns, training a Linear Regression model, and assessing performance using RMSE and R² metrics. Visual diagnostic plots are generated to interpret model accuracy and residual patterns. The final analysis is documented, version-controlled, and submitted via GitHub, demonstrating end-to-end data processing and predictive modeling on a distributed computing platform.</p>
</section>
<section id="load-the-dataset" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Load the Dataset</h1>
<p><strong>PySpark</strong> is used to load the <em>Lightcast Job Postings</em> dataset into a Spark DataFrame.<br>
This approach enables us to efficiently handle large datasets within the EC2 environment before proceeding with feature engineering and regression analysis.</p>
<div id="a5651d19" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load the Lightcast dataset with PySpark</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># Initialize Spark session </span></span>
<span id="cb1-7"><a href="#cb1-7"></a>spark <span class="op">=</span> (</span>
<span id="cb1-8"><a href="#cb1-8"></a>    SparkSession.builder</span>
<span id="cb1-9"><a href="#cb1-9"></a>    .appName(<span class="st">"LightcastData"</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a>    .config(<span class="st">"spark.driver.memory"</span>, <span class="st">"1g"</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a>    .getOrCreate()</span>
<span id="cb1-12"><a href="#cb1-12"></a>)</span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># Define dataset path</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>csv_path <span class="op">=</span> <span class="st">"data/lightcast_job_postings.csv"</span></span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># Check path validity</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(csv_path):</span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"❌ Could not find </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">. Please ensure the file exists in the data/ folder."</span>)</span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co"># Load dataset</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>df <span class="op">=</span> (</span>
<span id="cb1-23"><a href="#cb1-23"></a>    spark.read</span>
<span id="cb1-24"><a href="#cb1-24"></a>    .option(<span class="st">"header"</span>, <span class="st">"true"</span>)       <span class="co"># First row as headers</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>    .option(<span class="st">"inferSchema"</span>, <span class="st">"true"</span>)  <span class="co"># Auto-detect data types</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>    .option(<span class="st">"multiLine"</span>, <span class="st">"true"</span>)    <span class="co"># Handle multi-line text fields</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>    .option(<span class="st">"escape"</span>, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>)         <span class="co"># Handle embedded quotes</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>    .csv(csv_path)</span>
<span id="cb1-29"><a href="#cb1-29"></a>)</span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co"># Confirm load success</span></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="bu">print</span>(<span class="st">"✅ Dataset successfully loaded!"</span>)</span>
<span id="cb1-33"><a href="#cb1-33"></a>df.printSchema()</span>
<span id="cb1-34"><a href="#cb1-34"></a>df.show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Dataset successfully loaded!
root
 |-- ID: string (nullable = true)
 |-- LAST_UPDATED_DATE: string (nullable = true)
 |-- LAST_UPDATED_TIMESTAMP: timestamp (nullable = true)
 |-- DUPLICATES: integer (nullable = true)
 |-- POSTED: string (nullable = true)
 |-- EXPIRED: string (nullable = true)
 |-- DURATION: integer (nullable = true)
 |-- SOURCE_TYPES: string (nullable = true)
 |-- SOURCES: string (nullable = true)
 |-- URL: string (nullable = true)
 |-- ACTIVE_URLS: string (nullable = true)
 |-- ACTIVE_SOURCES_INFO: string (nullable = true)
 |-- TITLE_RAW: string (nullable = true)
 |-- BODY: string (nullable = true)
 |-- MODELED_EXPIRED: string (nullable = true)
 |-- MODELED_DURATION: integer (nullable = true)
 |-- COMPANY: integer (nullable = true)
 |-- COMPANY_NAME: string (nullable = true)
 |-- COMPANY_RAW: string (nullable = true)
 |-- COMPANY_IS_STAFFING: boolean (nullable = true)
 |-- EDUCATION_LEVELS: string (nullable = true)
 |-- EDUCATION_LEVELS_NAME: string (nullable = true)
 |-- MIN_EDULEVELS: integer (nullable = true)
 |-- MIN_EDULEVELS_NAME: string (nullable = true)
 |-- MAX_EDULEVELS: integer (nullable = true)
 |-- MAX_EDULEVELS_NAME: string (nullable = true)
 |-- EMPLOYMENT_TYPE: integer (nullable = true)
 |-- EMPLOYMENT_TYPE_NAME: string (nullable = true)
 |-- MIN_YEARS_EXPERIENCE: integer (nullable = true)
 |-- MAX_YEARS_EXPERIENCE: integer (nullable = true)
 |-- IS_INTERNSHIP: boolean (nullable = true)
 |-- SALARY: integer (nullable = true)
 |-- REMOTE_TYPE: integer (nullable = true)
 |-- REMOTE_TYPE_NAME: string (nullable = true)
 |-- ORIGINAL_PAY_PERIOD: string (nullable = true)
 |-- SALARY_TO: integer (nullable = true)
 |-- SALARY_FROM: integer (nullable = true)
 |-- LOCATION: string (nullable = true)
 |-- CITY: string (nullable = true)
 |-- CITY_NAME: string (nullable = true)
 |-- COUNTY: integer (nullable = true)
 |-- COUNTY_NAME: string (nullable = true)
 |-- MSA: integer (nullable = true)
 |-- MSA_NAME: string (nullable = true)
 |-- STATE: integer (nullable = true)
 |-- STATE_NAME: string (nullable = true)
 |-- COUNTY_OUTGOING: integer (nullable = true)
 |-- COUNTY_NAME_OUTGOING: string (nullable = true)
 |-- COUNTY_INCOMING: integer (nullable = true)
 |-- COUNTY_NAME_INCOMING: string (nullable = true)
 |-- MSA_OUTGOING: integer (nullable = true)
 |-- MSA_NAME_OUTGOING: string (nullable = true)
 |-- MSA_INCOMING: integer (nullable = true)
 |-- MSA_NAME_INCOMING: string (nullable = true)
 |-- NAICS2: integer (nullable = true)
 |-- NAICS2_NAME: string (nullable = true)
 |-- NAICS3: integer (nullable = true)
 |-- NAICS3_NAME: string (nullable = true)
 |-- NAICS4: integer (nullable = true)
 |-- NAICS4_NAME: string (nullable = true)
 |-- NAICS5: integer (nullable = true)
 |-- NAICS5_NAME: string (nullable = true)
 |-- NAICS6: integer (nullable = true)
 |-- NAICS6_NAME: string (nullable = true)
 |-- TITLE: string (nullable = true)
 |-- TITLE_NAME: string (nullable = true)
 |-- TITLE_CLEAN: string (nullable = true)
 |-- SKILLS: string (nullable = true)
 |-- SKILLS_NAME: string (nullable = true)
 |-- SPECIALIZED_SKILLS: string (nullable = true)
 |-- SPECIALIZED_SKILLS_NAME: string (nullable = true)
 |-- CERTIFICATIONS: string (nullable = true)
 |-- CERTIFICATIONS_NAME: string (nullable = true)
 |-- COMMON_SKILLS: string (nullable = true)
 |-- COMMON_SKILLS_NAME: string (nullable = true)
 |-- SOFTWARE_SKILLS: string (nullable = true)
 |-- SOFTWARE_SKILLS_NAME: string (nullable = true)
 |-- ONET: string (nullable = true)
 |-- ONET_NAME: string (nullable = true)
 |-- ONET_2019: string (nullable = true)
 |-- ONET_2019_NAME: string (nullable = true)
 |-- CIP6: string (nullable = true)
 |-- CIP6_NAME: string (nullable = true)
 |-- CIP4: string (nullable = true)
 |-- CIP4_NAME: string (nullable = true)
 |-- CIP2: string (nullable = true)
 |-- CIP2_NAME: string (nullable = true)
 |-- SOC_2021_2: string (nullable = true)
 |-- SOC_2021_2_NAME: string (nullable = true)
 |-- SOC_2021_3: string (nullable = true)
 |-- SOC_2021_3_NAME: string (nullable = true)
 |-- SOC_2021_4: string (nullable = true)
 |-- SOC_2021_4_NAME: string (nullable = true)
 |-- SOC_2021_5: string (nullable = true)
 |-- SOC_2021_5_NAME: string (nullable = true)
 |-- LOT_CAREER_AREA: integer (nullable = true)
 |-- LOT_CAREER_AREA_NAME: string (nullable = true)
 |-- LOT_OCCUPATION: integer (nullable = true)
 |-- LOT_OCCUPATION_NAME: string (nullable = true)
 |-- LOT_SPECIALIZED_OCCUPATION: integer (nullable = true)
 |-- LOT_SPECIALIZED_OCCUPATION_NAME: string (nullable = true)
 |-- LOT_OCCUPATION_GROUP: integer (nullable = true)
 |-- LOT_OCCUPATION_GROUP_NAME: string (nullable = true)
 |-- LOT_V6_SPECIALIZED_OCCUPATION: integer (nullable = true)
 |-- LOT_V6_SPECIALIZED_OCCUPATION_NAME: string (nullable = true)
 |-- LOT_V6_OCCUPATION: integer (nullable = true)
 |-- LOT_V6_OCCUPATION_NAME: string (nullable = true)
 |-- LOT_V6_OCCUPATION_GROUP: integer (nullable = true)
 |-- LOT_V6_OCCUPATION_GROUP_NAME: string (nullable = true)
 |-- LOT_V6_CAREER_AREA: integer (nullable = true)
 |-- LOT_V6_CAREER_AREA_NAME: string (nullable = true)
 |-- SOC_2: string (nullable = true)
 |-- SOC_2_NAME: string (nullable = true)
 |-- SOC_3: string (nullable = true)
 |-- SOC_3_NAME: string (nullable = true)
 |-- SOC_4: string (nullable = true)
 |-- SOC_4_NAME: string (nullable = true)
 |-- SOC_5: string (nullable = true)
 |-- SOC_5_NAME: string (nullable = true)
 |-- LIGHTCAST_SECTORS: string (nullable = true)
 |-- LIGHTCAST_SECTORS_NAME: string (nullable = true)
 |-- NAICS_2022_2: integer (nullable = true)
 |-- NAICS_2022_2_NAME: string (nullable = true)
 |-- NAICS_2022_3: integer (nullable = true)
 |-- NAICS_2022_3_NAME: string (nullable = true)
 |-- NAICS_2022_4: integer (nullable = true)
 |-- NAICS_2022_4_NAME: string (nullable = true)
 |-- NAICS_2022_5: integer (nullable = true)
 |-- NAICS_2022_5_NAME: string (nullable = true)
 |-- NAICS_2022_6: integer (nullable = true)
 |-- NAICS_2022_6_NAME: string (nullable = true)
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+----------------------------------------+-----------------+-----------------------+----------+--------+---------+--------+----------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+-------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+----------------+--------+-----------------------+-----------+-------------------+----------------+-----------------------------+-------------+-------------------+-------------+------------------+---------------+----------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+-------------------------------------------------+--------------------+-------------+------+--------------+-----+-------------------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+-------------------------------+------------+-------------------------------+------+------------------------------------------------------------------------+------+--------------------------------------------+------+------------------------------------------------------------+------+------------------------------------------+------+------------------------------------------+------------------+-------------------+-------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------+----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+----------+------------------------------+----------+------------------------------+-------------------------------+-------------------------------------------------------+---------------------------+-------------------------------------+---------------------+----------------------------------------------------------+----------+-------------------------------------+----------+--------------------------------+----------+---------------+----------+---------------+---------------+-------------------------------------------+--------------+-----------------------------+--------------------------+--------------------------------+--------------------+-----------------------------+-----------------------------+----------------------------------+-----------------+-----------------------------+-----------------------+-----------------------------+------------------+-------------------------------------------+-------+-------------------------------------+-------+--------------------------------+-------+---------------+-------+---------------+-----------------+---------------------------------+------------+------------------------------------------------------------------------+------------+--------------------------------------------+------------+------------------------------------------------------------+------------+------------------------------------------+------------+------------------------------------------+
|ID                                      |LAST_UPDATED_DATE|LAST_UPDATED_TIMESTAMP |DUPLICATES|POSTED  |EXPIRED  |DURATION|SOURCE_TYPES          |SOURCES                                      |URL                                                                                                                                                                                                                     |ACTIVE_URLS|ACTIVE_SOURCES_INFO|TITLE_RAW                                                   |BODY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |MODELED_EXPIRED|MODELED_DURATION|COMPANY |COMPANY_NAME           |COMPANY_RAW|COMPANY_IS_STAFFING|EDUCATION_LEVELS|EDUCATION_LEVELS_NAME        |MIN_EDULEVELS|MIN_EDULEVELS_NAME |MAX_EDULEVELS|MAX_EDULEVELS_NAME|EMPLOYMENT_TYPE|EMPLOYMENT_TYPE_NAME  |MIN_YEARS_EXPERIENCE|MAX_YEARS_EXPERIENCE|IS_INTERNSHIP|SALARY|REMOTE_TYPE|REMOTE_TYPE_NAME|ORIGINAL_PAY_PERIOD|SALARY_TO|SALARY_FROM|LOCATION                                         |CITY                |CITY_NAME    |COUNTY|COUNTY_NAME   |MSA  |MSA_NAME                       |STATE|STATE_NAME|COUNTY_OUTGOING|COUNTY_NAME_OUTGOING|COUNTY_INCOMING|COUNTY_NAME_INCOMING|MSA_OUTGOING|MSA_NAME_OUTGOING              |MSA_INCOMING|MSA_NAME_INCOMING              |NAICS2|NAICS2_NAME                                                             |NAICS3|NAICS3_NAME                                 |NAICS4|NAICS4_NAME                                                 |NAICS5|NAICS5_NAME                               |NAICS6|NAICS6_NAME                               |TITLE             |TITLE_NAME         |TITLE_CLEAN                                |SKILLS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |SKILLS_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |SPECIALIZED_SKILLS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |SPECIALIZED_SKILLS_NAME                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |CERTIFICATIONS                |CERTIFICATIONS_NAME         |COMMON_SKILLS                                                                                                                                                                                                                                                                                                                          |COMMON_SKILLS_NAME                                                                                                                                                                                                                                                  |SOFTWARE_SKILLS                                                                                                |SOFTWARE_SKILLS_NAME                                                                                                        |ONET      |ONET_NAME                     |ONET_2019 |ONET_2019_NAME                |CIP6                           |CIP6_NAME                                              |CIP4                       |CIP4_NAME                            |CIP2                 |CIP2_NAME                                                 |SOC_2021_2|SOC_2021_2_NAME                      |SOC_2021_3|SOC_2021_3_NAME                 |SOC_2021_4|SOC_2021_4_NAME|SOC_2021_5|SOC_2021_5_NAME|LOT_CAREER_AREA|LOT_CAREER_AREA_NAME                       |LOT_OCCUPATION|LOT_OCCUPATION_NAME          |LOT_SPECIALIZED_OCCUPATION|LOT_SPECIALIZED_OCCUPATION_NAME |LOT_OCCUPATION_GROUP|LOT_OCCUPATION_GROUP_NAME    |LOT_V6_SPECIALIZED_OCCUPATION|LOT_V6_SPECIALIZED_OCCUPATION_NAME|LOT_V6_OCCUPATION|LOT_V6_OCCUPATION_NAME       |LOT_V6_OCCUPATION_GROUP|LOT_V6_OCCUPATION_GROUP_NAME |LOT_V6_CAREER_AREA|LOT_V6_CAREER_AREA_NAME                    |SOC_2  |SOC_2_NAME                           |SOC_3  |SOC_3_NAME                      |SOC_4  |SOC_4_NAME     |SOC_5  |SOC_5_NAME     |LIGHTCAST_SECTORS|LIGHTCAST_SECTORS_NAME           |NAICS_2022_2|NAICS_2022_2_NAME                                                       |NAICS_2022_3|NAICS_2022_3_NAME                           |NAICS_2022_4|NAICS_2022_4_NAME                                           |NAICS_2022_5|NAICS_2022_5_NAME                         |NAICS_2022_6|NAICS_2022_6_NAME                         |
+----------------------------------------+-----------------+-----------------------+----------+--------+---------+--------+----------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+-------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+----------------+--------+-----------------------+-----------+-------------------+----------------+-----------------------------+-------------+-------------------+-------------+------------------+---------------+----------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+-------------------------------------------------+--------------------+-------------+------+--------------+-----+-------------------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+-------------------------------+------------+-------------------------------+------+------------------------------------------------------------------------+------+--------------------------------------------+------+------------------------------------------------------------+------+------------------------------------------+------+------------------------------------------+------------------+-------------------+-------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------+----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+----------+------------------------------+----------+------------------------------+-------------------------------+-------------------------------------------------------+---------------------------+-------------------------------------+---------------------+----------------------------------------------------------+----------+-------------------------------------+----------+--------------------------------+----------+---------------+----------+---------------+---------------+-------------------------------------------+--------------+-----------------------------+--------------------------+--------------------------------+--------------------+-----------------------------+-----------------------------+----------------------------------+-----------------+-----------------------------+-----------------------+-----------------------------+------------------+-------------------------------------------+-------+-------------------------------------+-------+--------------------------------+-------+---------------+-------+---------------+-----------------+---------------------------------+------------+------------------------------------------------------------------------+------------+--------------------------------------------+------------+------------------------------------------------------------+------------+------------------------------------------+------------+------------------------------------------+
|1f57d95acf4dc67ed2819eb12f049f6a5c11782c|9/6/2024         |2024-09-06 20:32:57.352|0         |6/2/2024|6/8/2024 |6       |[\n  "Company"\n]     |[\n  "brassring.com"\n]                      |[\n  "https://sjobs.brassring.com/TGnewUI/Search/home/HomeWithPreLoad?partnerid=25450&amp;siteid=5588&amp;PageType=JobDetails&amp;jobid=3542033"\n]                                                                                 |[]         |NULL               |Enterprise Analyst (II-III)                                 |31-May-2024\n\nEnterprise Analyst (II-III)\n\nMerchandising\n\nEl Dorado\n\nArkansas\n\nJob Posting\n\nGENERAL DESCRIPTION OF POSITION\nPerforms business analysis using various techniques, e.g. statistical analysis, explanatory and predictive modeling, data mining. Identifies trends and patterns in data and can explain business drivers or the why behind the data. Skills typically attained in a four-year degree plus the understanding and application of analytical tools and techniques that come with 2-5 years of experience including advanced MS office skills, advanced SQL, PowerBI, and exporting/building data models.\n\nESSENTIAL DUTIES AND RESPONSIBILITIES\n1. Gathers insight and performs routine and ad hoc reporting using various techniques (statistical analysis, data mining).\n2. Frames unstructured problems\n3. Performs data extraction/gathering, reconciling ambiguous data, and executes the hypothesis-driven approach.\n4. Develops fact-based and actionable recommendations/presentations.\n5. Analyze data for trends and patterns, and interpret data with a clear objective in mind\n6. Proficiently design and develop algorithms and models to use against large datasets to create business insights\n7. Make appropriate selection, utilization and interpretation of advanced analytical methodologies\n8. Effectively communicate insights and recommendations to both technical and non-technical leaders and business customers/partners including preparing reports, updates and/or presentations related to progress made on a project or solution\n9. Work with project teams and business partners to determine project goals and deliver productionized models and tools\n10. Effectively develop trust and collaboration with internal customers and cross-functional teams\n\n\nQUALIFICATIONS\nTo perform this job successfully, an individual must be able to perform each essential duty mentioned satisfactorily. The requirements listed below are representative of the knowledge, skill, and/or ability required.\n\nEDUCATION AND EXPERIENCE\nBroad knowledge of such fields as economics, statistics, business administration, finance, math, science etc. Equivalent to a four-year college degree, plus 2-5 years related experience and/or training, or equivalent combination of education and experience.\n\nAuto req ID\n\n181767BR\n\nStore Number/Dept Number\n\n299900055000 - Strat Plan Perform Mgmt\n\nStore Address\n\n200 E Peach St\n\nStore Zip\n\n71730                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |6/8/2024       |6               |894731  |Murphy USA             |Murphy USA |false              |[\n  2\n]       |[\n  "Bachelor's degree"\n]  |2            |Bachelor's degree  |NULL         |NULL              |1              |Full-time (&gt; 32 hours)|2                   |2                   |false        |NULL  |0          |[None]          |NULL               |NULL     |NULL       |{\n  "lat": 33.20763,\n  "lon": -92.6662674\n}   |RWwgRG9yYWRvLCBBUg==|El Dorado, AR|5139  |Union, AR     |20980|El Dorado, AR                  |5    |Arkansas  |5139           |Union, AR           |5139           |Union, AR           |20980       |El Dorado, AR                  |20980       |El Dorado, AR                  |44    |Retail Trade                                                            |441   |Motor Vehicle and Parts Dealers             |4413  |Automotive Parts, Accessories, and Tire Retailers           |44133 |Automotive Parts and Accessories Retailers|441330|Automotive Parts and Accessories Retailers|ET29C073C03D1F86B4|Enterprise Analysts|enterprise analyst ii iii                  |[\n  "KS126DB6T061MHD7RTGQ",\n  "KS126706DPFD3354M7YK",\n  "KS1280B68GD79P4WMVYW",\n  "KS128006L3V0HM2B26N5",\n  "KS122PM76DCYL9WC89Y7",\n  "ESB17C5AF46AFE08157D",\n  "KS122P063X6NGMHLP002",\n  "BGSB4E1D5CA81759D758",\n  "KS122PL70D99VRWMFM2T",\n  "KS1218C6C8TX2Y1KRN37",\n  "KS123MC78KV644P5DDZ0",\n  "KS120D96FHL88PZDKZKH",\n  "KS440Y975RD841M02V3S",\n  "KS440W865GC4VRBW6LJP",\n  "BGS1ADAA36DB65721AA3",\n  "BGS4CDA2E23CE451E247",\n  "KS13USA80NE38XJHA2TL",\n  "KS128HP65N6N70YV5ZM7",\n  "KS1239W6QZKL1H0TF1TJ",\n  "KS1218B62M9QRBY8WRSK"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |[\n  "Merchandising",\n  "Mathematics",\n  "Presentations",\n  "Predictive Modeling",\n  "Data Modeling",\n  "Advanced Analytics",\n  "Data Extraction",\n  "Statistical Analysis",\n  "Data Mining",\n  "Business Analysis",\n  "Finance",\n  "Algorithms",\n  "Statistics",\n  "SQL (Programming Language)",\n  "Report Writing",\n  "Ad Hoc Reporting",\n  "Power BI",\n  "Relationship Building",\n  "Economics",\n  "Business Administration"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |[\n  "KS126DB6T061MHD7RTGQ",\n  "KS128006L3V0HM2B26N5",\n  "KS122PM76DCYL9WC89Y7",\n  "ESB17C5AF46AFE08157D",\n  "KS122P063X6NGMHLP002",\n  "BGSB4E1D5CA81759D758",\n  "KS122PL70D99VRWMFM2T",\n  "KS1218C6C8TX2Y1KRN37",\n  "KS123MC78KV644P5DDZ0",\n  "KS120D96FHL88PZDKZKH",\n  "KS440Y975RD841M02V3S",\n  "KS440W865GC4VRBW6LJP",\n  "BGS4CDA2E23CE451E247",\n  "KS13USA80NE38XJHA2TL",\n  "KS1239W6QZKL1H0TF1TJ"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |[\n  "Merchandising",\n  "Predictive Modeling",\n  "Data Modeling",\n  "Advanced Analytics",\n  "Data Extraction",\n  "Statistical Analysis",\n  "Data Mining",\n  "Business Analysis",\n  "Finance",\n  "Algorithms",\n  "Statistics",\n  "SQL (Programming Language)",\n  "Ad Hoc Reporting",\n  "Power BI",\n  "Economics"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |[]                            |[]                          |[\n  "KS126706DPFD3354M7YK",\n  "KS1280B68GD79P4WMVYW",\n  "BGS1ADAA36DB65721AA3",\n  "KS128HP65N6N70YV5ZM7",\n  "KS1218B62M9QRBY8WRSK"\n]                                                                                                                                                                                             |[\n  "Mathematics",\n  "Presentations",\n  "Report Writing",\n  "Relationship Building",\n  "Business Administration"\n]                                                                                                                                            |[\n  "KS440W865GC4VRBW6LJP",\n  "KS13USA80NE38XJHA2TL"\n]                                                      |[\n  "SQL (Programming Language)",\n  "Power BI"\n]                                                                         |15-2051.01|Business Intelligence Analysts|15-2051.01|Business Intelligence Analysts|[\n  "45.0601",\n  "27.0101"\n]|[\n  "Economics, General",\n  "Mathematics, General"\n]|[\n  "45.06",\n  "27.01"\n]|[\n  "Economics",\n  "Mathematics"\n]|[\n  "45",\n  "27"\n]|[\n  "Social Sciences",\n  "Mathematics and Statistics"\n]|15-0000   |Computer and Mathematical Occupations|15-2000   |Mathematical Science Occupations|15-2050   |Data Scientists|15-2051   |Data Scientists|23             |Information Technology and Computer Science|231010        |Business Intelligence Analyst|23101011                  |General ERP Analyst / Consultant|2310                |Business Intelligence        |23101011                     |General ERP Analyst / Consultant  |231010           |Business Intelligence Analyst|2310                   |Business Intelligence        |23                |Information Technology and Computer Science|15-0000|Computer and Mathematical Occupations|15-2000|Mathematical Science Occupations|15-2050|Data Scientists|15-2051|Data Scientists|[\n  7\n]        |[\n  "Artificial Intelligence"\n]|44          |Retail Trade                                                            |441         |Motor Vehicle and Parts Dealers             |4413        |Automotive Parts, Accessories, and Tire Retailers           |44133       |Automotive Parts and Accessories Retailers|441330      |Automotive Parts and Accessories Retailers|
|0cb072af26757b6c4ea9464472a50a443af681ac|8/2/2024         |2024-08-02 17:08:58.838|0         |6/2/2024|8/1/2024 |NULL    |[\n  "Job Board"\n]   |[\n  "maine.gov"\n]                          |[\n  "https://joblink.maine.gov/jobs/1085740"\n]                                                                                                                                                                        |[]         |NULL               |Oracle Consultant - Reports (3592)                          |Oracle Consultant - Reports (3592)\n\nat SMX in Augusta, Maine, United States\n\nJob Description\n\nOracle Consultant - Reports (3592)at SMX (https://www.smxtech.com/careers/)\n\nUnited States\n\nCreoal has recently become a proud subsidiary of SMX, marking an exciting collaboration that enhances our collective capabilities to deliver cutting-edge digital transformation solutions.SMX has a growing Oracle Cloud Practice, focusing on Commercial and Public Sector customers.\n\nSMX/Creoal drives digital transformation through innovative solutions that leverage Oracle, Salesforce, and leading-edge technologies for Federal, public sector, and commercial organizations across the globe. We employ a holistic approach of People, Process, and Technology.\n\nThe value of our organization is rooted in our team, whose experience across a wide range of technologies delivers tangible results to our clients. SMX/Creoal's skilled professional resources represent the industry's most respected digital transformation experts.\n\nWe are looking for an Oracle Consultant to support our client in this 100% remote role.\n\nEssential Duties and Responsibilities for the Oracle Consultant include:\n\n+ Providing direction and specialist knowledge in utilizing the following tools:\n\n+ Oracle Analytics Cloud (OAC)\n\n+ Oracle Transactional Business Intelligence (OTBI)\n\n+ Oracle Business Intelligence Publisher (BI Publisher)\n\n+ Developing reports and other business intelligence solutions to meet customers' needs in the following domains/fields:\n\n+ Financials\n\n+ Supply Chain\n\n+ Procurement\n\n+ Project Accounting\n\n+ Development of reusable reports using tools such as OTBI, Financial Reporting Studio, and OAC\n\nRequired Skills and Experience:\n\n+ Clearance Required: None\n\n+ US Citizenship is required for work on this contract. Applicant must be residing in the United States.\n\n+ 3-5 years of experience is required in the following toolsets:\n\n+ OAC\n\n+ OTBI\n\n+ BI Publisher\n\n+ PL/SQL\n\n+ Exposure to large-scale implementation projects, principally Oracle Fusion Cloud\n\nDesired Qualifications:\n\n+ Familiarity with Oracle Integration Cloud (OIC) is a plus\n\n+ Past background with Oracle's EBusiness Suite (EBS) product\n\n\#cjpost #LI-REMOTE #LI-JJ1\n\nAt SMX, we are a team of technical and domain experts dedicated to enabling your mission. From priority national security initiatives for the DoD to highly assured and compliant solutions for healthcare, we understand that digital transformation is key to your future success.\n\nWe share your vision for the future and strive to accelerate your impact on the world. We bring both cutting edge technology and an expansive view of what's possible to every engagement. Our delivery model and unique approaches harness our deep technical and domain knowledge, providing forward-looking insights and practical solutions to power secure mission acceleration.\n\nSMX is committed to hiring and retaining a diverse workforce. All qualified candidates will receive consideration for employment without regard to disability status, protected veteran status, race, color, age, religion, national origin, citizenship, marital status, sex, sexual orientation, gender identity or expression, pregnancy or genetic information. SMX is an Equal Opportunity/Affirmative Action employer including disability and veterans.\n\nSelected applicant will be subject to a background investigation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |8/1/2024       |NULL            |133098  |Smx Corporation Limited|SMX        |true               |[\n  99\n]      |[\n  "No Education Listed"\n]|99           |No Education Listed|NULL         |NULL              |1              |Full-time (&gt; 32 hours)|3                   |3                   |false        |NULL  |1          |Remote          |NULL               |NULL     |NULL       |{\n  "lat": 44.3106241,\n  "lon": -69.7794897\n} |QXVndXN0YSwgTUU=    |Augusta, ME  |23011 |Kennebec, ME  |12300|Augusta-Waterville, ME         |23   |Maine     |23011          |Kennebec, ME        |23011          |Kennebec, ME        |12300       |Augusta-Waterville, ME         |12300       |Augusta-Waterville, ME         |56    |Administrative and Support and Waste Management and Remediation Services|561   |Administrative and Support Services         |5613  |Employment Services                                         |56132 |Temporary Help Services                   |561320|Temporary Help Services                   |ET21DDA63780A7DC09|Oracle Consultants |oracle consultant reports                  |[\n  "KS122626T550SLQ7QZ1C",\n  "KS123YJ6KVWC91BTMB4R",\n  "BGSBF3F508F7F46312E3",\n  "ESEA839CED37833AA298",\n  "KS127HT6PY61NVMR3PWG",\n  "ES72D57E1BC4BB22BBB0",\n  "KS120ZX7019J4V8DHBTM",\n  "KS440YT6CGVX2WD4DLMR",\n  "KS128456FPN85WYD0SH8"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |[\n  "Procurement",\n  "Financial Statements",\n  "Oracle Business Intelligence (BI) / OBIA",\n  "Oracle E-Business Suite",\n  "PL/SQL",\n  "Supply Chain",\n  "Business Intelligence",\n  "Oracle Fusion Middleware",\n  "Project Accounting"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |[\n  "KS122626T550SLQ7QZ1C",\n  "KS123YJ6KVWC91BTMB4R",\n  "BGSBF3F508F7F46312E3",\n  "ESEA839CED37833AA298",\n  "KS127HT6PY61NVMR3PWG",\n  "ES72D57E1BC4BB22BBB0",\n  "KS120ZX7019J4V8DHBTM",\n  "KS440YT6CGVX2WD4DLMR",\n  "KS128456FPN85WYD0SH8"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |[\n  "Procurement",\n  "Financial Statements",\n  "Oracle Business Intelligence (BI) / OBIA",\n  "Oracle E-Business Suite",\n  "PL/SQL",\n  "Supply Chain",\n  "Business Intelligence",\n  "Oracle Fusion Middleware",\n  "Project Accounting"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |[]                            |[]                          |[]                                                                                                                                                                                                                                                                                                                                     |[]                                                                                                                                                                                                                                                                  |[\n  "BGSBF3F508F7F46312E3",\n  "ESEA839CED37833AA298",\n  "KS127HT6PY61NVMR3PWG",\n  "KS440YT6CGVX2WD4DLMR"\n]|[\n  "Oracle Business Intelligence (BI) / OBIA",\n  "Oracle E-Business Suite",\n  "PL/SQL",\n  "Oracle Fusion Middleware"\n]|15-2051.01|Business Intelligence Analysts|15-2051.01|Business Intelligence Analysts|[]                             |[]                                                     |[]                         |[]                                   |[]                   |[]                                                        |15-0000   |Computer and Mathematical Occupations|15-2000   |Mathematical Science Occupations|15-2050   |Data Scientists|15-2051   |Data Scientists|23             |Information Technology and Computer Science|231010        |Business Intelligence Analyst|23101012                  |Oracle Consultant / Analyst     |2310                |Business Intelligence        |23101012                     |Oracle Consultant / Analyst       |231010           |Business Intelligence Analyst|2310                   |Business Intelligence        |23                |Information Technology and Computer Science|15-0000|Computer and Mathematical Occupations|15-2000|Mathematical Science Occupations|15-2050|Data Scientists|15-2051|Data Scientists|NULL             |NULL                             |56          |Administrative and Support and Waste Management and Remediation Services|561         |Administrative and Support Services         |5613        |Employment Services                                         |56132       |Temporary Help Services                   |561320      |Temporary Help Services                   |
|85318b12b3331fa490d32ad014379df01855c557|9/6/2024         |2024-09-06 20:32:57.352|1         |6/2/2024|7/7/2024 |35      |[\n  "Job Board"\n]   |[\n  "dejobs.org"\n]                         |[\n  "https://dejobs.org/dallas-tx/data-analyst/AB20D7C0DBB740F2BBF4F98CC806D12E/job/",\n  "https://dejobs.org/dallas-tx/data-analyst/486581AFD4964ECD9DD36951AD84C0C5/job/"\n]                                         |[]         |NULL               |Data Analyst                                                |Taking care of people is at the heart of everything we do, and we start by taking care of you, our valued colleague. A career at Sedgwick means experiencing our culture of caring. It means having flexibility and time for all the things that are important to you. It's an opportunity to do something meaningful, each and every day. It's having support for your mental, physical, financial and professional needs. It means sharpening your skills and growing your career. And it means working in an environment that celebrates diversity and is fair and inclusive.\n\nA career at Sedgwick is where passion meets purpose to make a positive impact on the world through the people and organizations we serve. If you are someone who is driven to make a difference, who enjoys a challenge and above all, if you're someone who cares, there's a place for you here. Join us and contribute to Sedgwick being a great place to work.\n\nGreat Place to Work\n\nMost Loved Workplace\n\nForbes Best-in-State Employer\n\nData Analyst\n\nPRIMARY PURPOSE To collect, analyze and report data; to be responsible for the data integrity; and to generate reports verifying and ensuring data integrity and accuracy.\n\nESSENTIAL FUNCTIONS and RESPONSIBILITIES\n\nCompiles data; prepares and distributes reports; and analyzes results.\n\nEnsures data integrity; develops and produces reports utilized in measuring data accuracy.\n\nMay assist in the completion of appropriate client set-up and maintenance (parameter) forms.\n\nSupports internal and external users including reports, installation, screen, etc.\n\nCreates exception reports to identify fields of incorrect data.\n\nGenerates custom reports for internal and external client.\n\nADDITIONAL FUNCTIONS and RESPONSIBILITIES\n\nPerforms other duties as assigned.\n\nSupports the organization's quality program(s).\n\nQUALIFICATIONS\n\nEducation &amp; Licensing\n\nBachelor's degree from an accredited college or university preferred.\n\nExperience\n\nFive (5) years of related experience or equivalent combination of education and experience required. Two (2) years of query and report writing experience strongly preferred.\n\nSkills &amp; Knowledge\n\nStrong knowledge of query and report writing\n\nExcellent oral and written communication, including presentation skills\n\nPC literate, including Microsoft Office products\n\nAnalytical and interpretive skills\n\nStrong organizational skills\n\nExcellent interpersonal skills\n\nExcellent negotiation skills\n\nAbility to meet or exceed Performance Competencies\n\nWORK ENVIRONMENT\n\nWhen applicable and appropriate, consideration will be given to reasonable accommodations.\n\nMental : Clear and conceptual thinking ability; excellent judgment, troubleshooting, problem solving, analysis, and discretion; ability to handle work-related stress; ability to handle multiple priorities simultaneously; and ability to meet deadlines\n\nPhysical : Computer keyboarding, travel as required\n\nAuditory/Visual : Hearing, vision and talking\n\nNOTE : Credit security clearance, confirmed via a background credit check, is required for this position.\n\nThe statements contained in this document are intended to describe the general nature and level of work being performed by a colleague assigned to this description. They are not intended to constitute a comprehensive list of functions, duties, or local variances. Management retains the discretion to add or to change the duties of the position at any time.\n\nSedgwick is an Equal Opportunity Employer and a Drug-Free Workplace.\n\nIf you're excited about this role but your experience doesn't align perfectly with every qualification in the job description, consider applying for it anyway! Sedgwick is building a diverse, equitable, and inclusive workplace and recognizes that each person possesses a unique combination of skills, knowledge, and experience. You may be just the right candidate for this or other roles.\n\nTaking care of people is at the heart of everything we do. Caring counts\n\nSedgwick is a leading global provider of technology-enabled risk, benefits and integrated business solutions. Every day, in every time zone, the most well-known and respected organizations place their trust in us to help their employees regain health and productivity, guide their consumers through the claims process, protect their brand and minimize business interruptions. Our more than 30,000 colleagues across 80 countries embrace our shared purpose and values as they demonstrate what it means to work for an organization committed to doing the right thing - one where caring counts. Watch this video to learn more about us. (https://www.youtube.com/watch?v=ywxedjBGSfA)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |6/10/2024      |8               |39063746|Sedgwick               |Sedgwick   |false              |[\n  2\n]       |[\n  "Bachelor's degree"\n]  |2            |Bachelor's degree  |NULL         |NULL              |1              |Full-time (&gt; 32 hours)|5                   |NULL                |false        |NULL  |0          |[None]          |NULL               |NULL     |NULL       |{\n  "lat": 32.7766642,\n  "lon": -96.7969879\n} |RGFsbGFzLCBUWA==    |Dallas, TX   |48113 |Dallas, TX    |19100|Dallas-Fort Worth-Arlington, TX|48   |Texas     |48113          |Dallas, TX          |48113          |Dallas, TX          |19100       |Dallas-Fort Worth-Arlington, TX|19100       |Dallas-Fort Worth-Arlington, TX|52    |Finance and Insurance                                                   |524   |Insurance Carriers and Related Activities   |5242  |Agencies, Brokerages, and Other Insurance Related Activities|52429 |Other Insurance Related Activities        |524291|Claims Adjusting                          |ET3037E0C947A02404|Data Analysts      |data analyst                               |[\n  "KS1218W78FGVPVP2KXPX",\n  "ESF3939CE1F80C10C327",\n  "BGS1ADAA36DB65721AA3",\n  "KS683TN76T77DQDVBZ1B",\n  "KS1259D6L30YYG3XR3VL",\n  "ES9BD12EB76B360E0E89",\n  "KS1280B68GD79P4WMVYW",\n  "KS4425C7820LCHZS7VGX",\n  "KS120GV6C72JMSZKMTD7",\n  "ES8B03DAD3B526316ED9",\n  "KS126X663B21NB77ZHSP",\n  "KS122P86NZFH1GP38G15",\n  "KS126HY6YLTB9R7XJC4Z"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |[\n  "Management",\n  "Exception Reporting",\n  "Report Writing",\n  "Security Clearance",\n  "Interpersonal Communications",\n  "Ability To Meet Deadlines",\n  "Presentations",\n  "Writing",\n  "Data Analysis",\n  "Organizational Skills",\n  "Negotiation",\n  "Data Integrity",\n  "Microsoft Office"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |[\n  "ESF3939CE1F80C10C327",\n  "KS120GV6C72JMSZKMTD7",\n  "KS122P86NZFH1GP38G15"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |[\n  "Exception Reporting",\n  "Data Analysis",\n  "Data Integrity"\n]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |[\n  "KS683TN76T77DQDVBZ1B"\n]|[\n  "Security Clearance"\n]|[\n  "KS1218W78FGVPVP2KXPX",\n  "BGS1ADAA36DB65721AA3",\n  "KS1259D6L30YYG3XR3VL",\n  "ES9BD12EB76B360E0E89",\n  "KS1280B68GD79P4WMVYW",\n  "KS4425C7820LCHZS7VGX",\n  "ES8B03DAD3B526316ED9",\n  "KS126X663B21NB77ZHSP",\n  "KS126HY6YLTB9R7XJC4Z"\n]                                                                                 |[\n  "Management",\n  "Report Writing",\n  "Interpersonal Communications",\n  "Ability To Meet Deadlines",\n  "Presentations",\n  "Writing",\n  "Organizational Skills",\n  "Negotiation",\n  "Microsoft Office"\n]                                                 |[\n  "KS126HY6YLTB9R7XJC4Z"\n]                                                                                 |[\n  "Microsoft Office"\n]                                                                                                  |15-2051.01|Business Intelligence Analysts|15-2051.01|Business Intelligence Analysts|[]                             |[]                                                     |[]                         |[]                                   |[]                   |[]                                                        |15-0000   |Computer and Mathematical Occupations|15-2000   |Mathematical Science Occupations|15-2050   |Data Scientists|15-2051   |Data Scientists|23             |Information Technology and Computer Science|231113        |Data / Data Mining Analyst   |23111310                  |Data Analyst                    |2311                |Data Analysis and Mathematics|23111310                     |Data Analyst                      |231113           |Data / Data Mining Analyst   |2311                   |Data Analysis and Mathematics|23                |Information Technology and Computer Science|15-0000|Computer and Mathematical Occupations|15-2000|Mathematical Science Occupations|15-2050|Data Scientists|15-2051|Data Scientists|NULL             |NULL                             |52          |Finance and Insurance                                                   |524         |Insurance Carriers and Related Activities   |5242        |Agencies, Brokerages, and Other Insurance Related Activities|52429       |Other Insurance Related Activities        |524291      |Claims Adjusting                          |
|1b5c3941e54a1889ef4f8ae55b401a550708a310|9/6/2024         |2024-09-06 20:32:57.352|1         |6/2/2024|7/20/2024|48      |[\n  "Job Board"\n]   |[\n  "disabledperson.com",\n  "dejobs.org"\n]|[\n  "https://www.disabledperson.com/jobs/59489810-sr-lead-data-mgmt-analyst-sas-product-owner",\n  "https://dejobs.org/phoenix-az/sr-lead-data-mgmt-analyst-sas-product-owner/6A4BD3E7D6C749D2A255335632C587B2/job/"\n]|[]         |NULL               |Sr. Lead Data Mgmt. Analyst - SAS Product Owner             |About this role:\n\nWells Fargo is looking for a SAS Platform and Tools L2 Product Owner with a specialization in migrating from SAS 9 Grid to SAS Viya 4 on Google Cloud (SaaS). This key position involves leading the development and enhancement of our SAS-based analytics platform while orchestrating a seamless transition to the next-generation SAS Viya 4 environment.\n\nIn this role, you will:\n\nAct as an advisor to leadership to develop or influence objectives, plans, specifications, resources, and long-term goals for highly complex business and technical needs\n\nLead the strategy and resolution of highly complex and unique challenges requiring in-depth evaluation across multiple areas or the enterprise, delivering solutions that are long-term, large-scale and require vision, creativity, innovation, advanced analytical and inductive thinking\n\nProvide vision, direction, and expertise to senior leadership on implementing innovative and significant business solutions\n\nRecommend remediation of process or control gaps that align to management strategy\n\nStrategically engage with all levels of professionals and managers across the enterprise and serve as an expert advisor to leadership\n\nRepresent client in cross-functional groups to develop companywide data governance strategies\n\nPartner with groups companywide to coordinate and drive collaboration on solution design and remediation execution\n\nProduct Vision and Strategy:\n\nDefine and articulate a clear product vision and strategy for both SAS Platform and Tools and the migration to SAS Viya 4.\n\nCollaborate with stakeholders to align technical solutions with organizational goals.\n\nRoadmap Development:\n\nDevelop and maintain a comprehensive product roadmap for SAS Platform and Tools, prioritizing features and enhancements based on business value.\n\nPlan and execute the migration roadmap from SAS 9 Grid to SAS Viya 4, ensuring a phased and efficient transition.\n\nMigration Strategy: SAS 9 Grid to SAS Viya 4:\n\nAssess the existing SAS 9 Grid environment, identifying workloads, dependencies, and hardware configurations.\n\nDevelop a migration plan, including data migration, re-engineering SAS 9 Grid workloads, and establishing parallel operations for a smooth transition.\n\nCross-functional Collaboration:\n\nCollaborate with development teams, data scientists, and other stakeholders to ensure successful implementation of product features and migration processes.\n\nAct as a liaison between technical and non-technical teams, fostering a collaborative environment.\n\nRequirements Gathering:\n\nCollect and analyze user feedback, market trends, and competitive intelligence to inform product decisions.\n\nDefine detailed product requirements, user stories, and acceptance criteria for SAS Platform and the migration to SAS Viya 4.\n\nManage on-prem SAS products:\n\nEffectively manage BAU (Business As Usual) product backlog and priorities\n\nDrive Data Center Exit strategy for SAS products\n\nQuality Assurance:\n\nCoordinate with QA teams to define and execute test plans, ensuring the reliability and performance of both SAS Platform and SAS Viya 4.\n\nConduct thorough testing during the migration process to identify and rectify any issues.\n\nUser Training and Support:\n\nDevelop and deliver training programs for end-users on SAS Platform and Tools as well as SAS Viya 4.\n\nProvide ongoing support and troubleshooting assistance during and post-migration.\n\nMonitoring and Optimization:\n\nEstablish monitoring mechanisms for SAS Platform and Tools and SAS Viya 4, tracking performance and optimizing configurations.\n\nContinuously improve SAS Viya 4 configurations based on performance data.\n\nRequired Qualification\n\n7+ years of Data Management, Business Analysis, Analytics, or Project Management experience, or equivalent demonstrated through one or a combination of the following: work experience, training, military experience, education\n\n3+ years of experience in platform/tool operations, architecture and strategy\n\n1+ years of Agile experience\n\nDesired Qualification:\n\nExperience with Cloud Data Platforms\n\nPrior experience in migrating on-prem SAS to Cloud\n\nManaged SAS platform with operational responsibilities\n\nExperience with design of multi-tenant data architecture and its configuration spanning across both on-prem, cloud and hybrid environments\n\nExperience in data architecture, strategy, implementing user journeys within the data domain for large enterprise strength platforms.\n\nProven experience of leading development of products (data related), strong demonstration of managing SDLC and delivering outcomes.\n\nDemonstrate past work experience of organizing and enabling teams in a scaled Agile environment.\n\nGoogle Cloud certification is desired.\n\nExperience creating and implementing strategic plans and roadmaps at the executive level for enterprise-wide business initiatives\n\nJob Expectations:\n\nAbility to travel up to 10%\n\nThis position offers a hybrid work schedule\n\nWillingness to work on-site in one of the listed locations\n\nVisa sponsorship is not available for this position\n\nLocations: Charlotte, NC; Phoenix, AZ; Addison, TX; West Des Moines, IA\n\n401 S. Tryon St. Charlotte, NC\n\n1525 W WT Harris Blvd. Charlotte, NC\n\n11601 N Black Canyon Hwy. Phoenix, AZ\n\n5080 Spectrum Dr. Addison, TX\n\n800 S. Jordan Creek Pkwy. West Des Moines, IA\n\nNote: Job posting may come down early due to volume of applicants.\n\nPosting End Date:\n\n3 Jun 2024\n\n*Job posting may come down early due to volume of applicants.\n\nWe Value Diversity\n\nAt Wells Fargo, we believe in diversity, equity and inclusion in the workplace; accordingly, we welcome applications for employment from all qualified candidates, regardless of race, color, gender, national origin, religion, age, sexual orientation, gender identity, gender expression, genetic information, individuals with disabilities, pregnancy, marital status, status as a protected veteran or any other status protected by applicable law.\n\nEmployees support our focus on building strong customer relationships balanced with a strong risk mitigating and compliance-driven culture which firmly establishes those disciplines as critical to the success of our customers and company. They are accountable for execution of all applicable risk programs (Credit, Market, Financial Crimes, Operational, Regulatory Compliance), which includes effectively following and adhering to applicable Wells Fargo policies and procedures, appropriately fulfilling risk and compliance obligations, timely and effective escalation and remediation of issues, and making sound risk decisions. There is emphasis on proactive monitoring, governance, risk identification and escalation, as well as making sound risk decisions commensurate with the business unit's risk appetite and all risk and compliance program requirements.\n\nCandidates applying to job openings posted in US: All qualified applicants will receive consideration for employment without regard to race, color, religion, sex, sexual orientation, gender identity, national origin, disability, status as a protected veteran, or any other legally protected characteristic.\n\nCandidates applying to job openings posted in Canada: Applications for employment are encouraged from all qualified candidates, including women, persons with disabilities, aboriginal peoples and visible minorities. Accommodation for applicants with disabilities is available upon request in connection with the recruitment process.\n\nApplicants with Disabilities\n\nTo request a medical accommodation during the application or interview process, visit Disability Inclusion at Wells Fargo .\n\nDrug and Alcohol Policy\n\nWells Fargo maintains a drug free workplace. Please see our Drug and Alcohol Policy to learn more.\n\nCompany: WELLS FARGO BANK\n\nReq Number: R-372422-3\n\nUpdated: Sun Jun 02 04:15:06 UTC 2024\n\nLocation: PHOENIX,Arizona|6/12/2024      |10              |37615159|Wells Fargo            |Wells Fargo|false              |[\n  99\n]      |[\n  "No Education Listed"\n]|99           |No Education Listed|NULL         |NULL              |1              |Full-time (&gt; 32 hours)|3                   |NULL                |false        |NULL  |0          |[None]          |NULL               |NULL     |NULL       |{\n  "lat": 33.4483771,\n  "lon": -112.0740373\n}|UGhvZW5peCwgQVo=    |Phoenix, AZ  |4013  |Maricopa, AZ  |38060|Phoenix-Mesa-Chandler, AZ      |4    |Arizona   |4013           |Maricopa, AZ        |4013           |Maricopa, AZ        |38060       |Phoenix-Mesa-Chandler, AZ      |38060       |Phoenix-Mesa-Chandler, AZ      |52    |Finance and Insurance                                                   |522   |Credit Intermediation and Related Activities|5221  |Depository Credit Intermediation                            |52211 |Commercial Banking                        |522110|Commercial Banking                        |ET2114E0404BA30075|Management Analysts|sr lead data mgmt analyst sas product owner|[\n  "KS123QX62QYTC4JF38H8",\n  "KS7G6NP6R6L1H1SKFTSY",\n  "KS441PQ64HT13P34T8T5",\n  "KS1218W78FGVPVP2KXPX",\n  "KS1219261TYVPMGX8KVQ",\n  "BGSBA798A49DA3AB544A",\n  "KSRGLA2SD4T20RIP6ORS",\n  "KS120B874P2P6BK1MQ0T",\n  "ES4C039C261C048676A2",\n  "ESB17C5AF46AFE08157D",\n  "KS128DV723HFCBV6JTH1",\n  "KS440726NL4QJRHCMR43",\n  "ES29C56D2465C253FC1D",\n  "KS4400X68616V0QJL5M8",\n  "KS1218C6C8TX2Y1KRN37",\n  "KS122PG64BT2BT6X15HF",\n  "KS122NM6B8TWBGL2X18F",\n  "ES20CECA4FF83ECE8196",\n  "KS1265F71V3PY4KH0JW5",\n  "KS1219D70RKFPH4CC8KN",\n  "KS122HK6LN2MZHFY69GJ",\n  "KS1253H61TTR1FZWSRH4",\n  "KS124G66QWSYM012SWS5",\n  "KS1284G6MK1552WHSZ32",\n  "KS124JB619VXG6RQ810C",\n  "KS441BJ6LNS1QCJHRMTW",\n  "KSNX20VIRD1IZABQZI8U",\n  "KS1282N6NQMZ95M1HJ7L",\n  "KS1267F6MSPN366LX7ST",\n  "KS127D361PF0FTXDZ7C4",\n  "KS122PL6Y7WHFNZ54RQJ",\n  "KS1226L6XYT1N27WRYJM",\n  "ES6C7324B9377A38E0D5",\n  "KS4409D76NW1S5LNCL18",\n  "KS441K2756CXYXBG990G",\n  "KS128866SHL94J005TTG",\n  "KS1220G68PD5STH2DL2W",\n  "KS122NW5YB08NCH9P98B",\n  "ES7A5D0AD38AB0F9D6C6",\n  "KS122P378DGNVX4NKQKN",\n  "KS1226460LSTKGW59TDX",\n  "KS127D36JHBK1S5F8NMB",\n  "KS4403H60RHC7598V94K",\n  "ESC7869CF7378283E0AA",\n  "KSUMUUUWH2LGA7IKVOX7"\n]|[\n  "Exit Strategies",\n  "Reliability",\n  "User Story",\n  "Management",\n  "Strategic Planning",\n  "Hardware Configuration Management",\n  "On Prem",\n  "Agile Methodology",\n  "Solution Design",\n  "Advanced Analytics",\n  "Reengineering",\n  "Safety Assurance",\n  "Cross-Functional Collaboration",\n  "Requirements Elicitation",\n  "Business Analysis",\n  "Data Management",\n  "Data Architecture",\n  "Influencing Skills",\n  "Market Trend",\n  "Business Valuation",\n  "Creativity",\n  "Innovation",\n  "Governance",\n  "Systems Development Life Cycle",\n  "Leadership",\n  "Test Planning",\n  "Multi-Tenant Cloud Environments",\n  "Scrum (Software Development)",\n  "Project Management",\n  "Operations",\n  "Data Migration",\n  "Regulatory Compliance",\n  "Product Roadmaps",\n  "SAS (Software)",\n  "Troubleshooting (Problem Solving)",\n  "Quality Assurance",\n  "Software As A Service (SaaS)",\n  "Data Domain",\n  "Product Requirements",\n  "Data Governance",\n  "Competitive Intelligence",\n  "Operations Architecture",\n  "Risk Appetite",\n  "Google Cloud Platform (GCP)",\n  "User Feedback"\n]|[\n  "KS123QX62QYTC4JF38H8",\n  "KS441PQ64HT13P34T8T5",\n  "BGSBA798A49DA3AB544A",\n  "KSRGLA2SD4T20RIP6ORS",\n  "KS120B874P2P6BK1MQ0T",\n  "ES4C039C261C048676A2",\n  "ESB17C5AF46AFE08157D",\n  "KS128DV723HFCBV6JTH1",\n  "ES29C56D2465C253FC1D",\n  "KS4400X68616V0QJL5M8",\n  "KS1218C6C8TX2Y1KRN37",\n  "KS122PG64BT2BT6X15HF",\n  "KS122NM6B8TWBGL2X18F",\n  "KS1265F71V3PY4KH0JW5",\n  "KS1219D70RKFPH4CC8KN",\n  "KS1284G6MK1552WHSZ32",\n  "KS441BJ6LNS1QCJHRMTW",\n  "KSNX20VIRD1IZABQZI8U",\n  "KS1282N6NQMZ95M1HJ7L",\n  "KS1267F6MSPN366LX7ST",\n  "KS122PL6Y7WHFNZ54RQJ",\n  "KS1226L6XYT1N27WRYJM",\n  "ES6C7324B9377A38E0D5",\n  "KS4409D76NW1S5LNCL18",\n  "KS1220G68PD5STH2DL2W",\n  "KS122NW5YB08NCH9P98B",\n  "ES7A5D0AD38AB0F9D6C6",\n  "KS122P378DGNVX4NKQKN",\n  "KS1226460LSTKGW59TDX",\n  "KS127D36JHBK1S5F8NMB",\n  "KS4403H60RHC7598V94K",\n  "ESC7869CF7378283E0AA",\n  "KSUMUUUWH2LGA7IKVOX7"\n]|[\n  "Exit Strategies",\n  "User Story",\n  "Hardware Configuration Management",\n  "On Prem",\n  "Agile Methodology",\n  "Solution Design",\n  "Advanced Analytics",\n  "Reengineering",\n  "Cross-Functional Collaboration",\n  "Requirements Elicitation",\n  "Business Analysis",\n  "Data Management",\n  "Data Architecture",\n  "Market Trend",\n  "Business Valuation",\n  "Systems Development Life Cycle",\n  "Test Planning",\n  "Multi-Tenant Cloud Environments",\n  "Scrum (Software Development)",\n  "Project Management",\n  "Data Migration",\n  "Regulatory Compliance",\n  "Product Roadmaps",\n  "SAS (Software)",\n  "Software As A Service (SaaS)",\n  "Data Domain",\n  "Product Requirements",\n  "Data Governance",\n  "Competitive Intelligence",\n  "Operations Architecture",\n  "Risk Appetite",\n  "Google Cloud Platform (GCP)",\n  "User Feedback"\n]|[]                            |[]                          |[\n  "KS7G6NP6R6L1H1SKFTSY",\n  "KS1218W78FGVPVP2KXPX",\n  "KS1219261TYVPMGX8KVQ",\n  "KS440726NL4QJRHCMR43",\n  "ES20CECA4FF83ECE8196",\n  "KS122HK6LN2MZHFY69GJ",\n  "KS1253H61TTR1FZWSRH4",\n  "KS124G66QWSYM012SWS5",\n  "KS124JB619VXG6RQ810C",\n  "KS127D361PF0FTXDZ7C4",\n  "KS441K2756CXYXBG990G",\n  "KS128866SHL94J005TTG"\n]|[\n  "Reliability",\n  "Management",\n  "Strategic Planning",\n  "Safety Assurance",\n  "Influencing Skills",\n  "Creativity",\n  "Innovation",\n  "Governance",\n  "Leadership",\n  "Operations",\n  "Troubleshooting (Problem Solving)",\n  "Quality Assurance"\n]|[\n  "KS4409D76NW1S5LNCL18",\n  "ESC7869CF7378283E0AA"\n]                                                      |[\n  "SAS (Software)",\n  "Google Cloud Platform (GCP)"\n]                                                                  |15-2051.01|Business Intelligence Analysts|15-2051.01|Business Intelligence Analysts|[]                             |[]                                                     |[]                         |[]                                   |[]                   |[]                                                        |15-0000   |Computer and Mathematical Occupations|15-2000   |Mathematical Science Occupations|15-2050   |Data Scientists|15-2051   |Data Scientists|23             |Information Technology and Computer Science|231113        |Data / Data Mining Analyst   |23111310                  |Data Analyst                    |2311                |Data Analysis and Mathematics|23111310                     |Data Analyst                      |231113           |Data / Data Mining Analyst   |2311                   |Data Analysis and Mathematics|23                |Information Technology and Computer Science|15-0000|Computer and Mathematical Occupations|15-2000|Mathematical Science Occupations|15-2050|Data Scientists|15-2051|Data Scientists|[\n  6\n]        |[\n  "Data Privacy/Protection"\n]|52          |Finance and Insurance                                                   |522         |Credit Intermediation and Related Activities|5221        |Depository Credit Intermediation                            |52211       |Commercial Banking                        |522110      |Commercial Banking                        |
|cb5ca25f02bdf25c13edfede7931508bfd9e858f|6/19/2024        |2024-06-19 07:00:00    |0         |6/2/2024|6/17/2024|15      |[\n  "FreeJobBoard"\n]|[\n  "craigslist.org"\n]                     |[\n  "https://modesto.craigslist.org/sls/7747584269.html"\n]                                                                                                                                                            |[]         |NULL               |Comisiones de $1000 - $3000 por semana... Comiensa Rapido!!!|Comisiones de $1000 - $3000 por semana... Comiensa Rapido!!! (MODESTO AND SURROUNDING AREAS) LH/GM compensation: COMMISSION EASY SALES employment type: job title: SALES Comisiones de $1000 - $3000 por semana... Comiensa Rapido!!! No tengas miedo de Comisiones este trabajo es facil nada mas tienes que aprenderlo con nuestro excelente entrenamiento y empiesas aser dinero Rapido. Company / Compania Lincoln Heritage Life Insurance Co. More than 60 years in business! TENEMOS MAS DE 60 ANOS EN NEGOCIO!!!!! Agency / Agencia GOLDEN MEMORIAL AGENCY #1 Final Expense Agency in the Country Que vendemos? Seguro de vida: solo un Producto Gastos Finales Planes Funerales" What do we Sell? Small whole life policies Necesito Experiencia? No se ocupa nada de experiencia, Solo ganas de Aprender ! Do I need Experience? No. All you need is work ethic to grow with a Winning Team!!! SI No tienes seguro social No te preocupes, si noms tienes un ITIN es suficiente para sacar la licencia del estado. Cuesta el entrenamiento? No !!! Entrenamiento es Gratis . Tenemos Videos EN INGLES Y ESPANOL................. Online Training..............In person Class Training...........&amp;.......Field Training with a Manager. Que se ocupa para tener xito y hacer dinero ? Presntate cada da con una actitud positiva y listo para trabajar al 100. 100% comisin How much money can you make in a year? Our Agents are making from $35,000 to $150,000 Annually, Managers are making from $200,000 to over 1 Million Annually. What makes our Final Expense Company a Great Company to work for? 1. We get paid in 24hrs. Sell a plan and submit a application with a 1st payment Check, you get paid within 24hrs direct deposit into your bank account. 2. We give coverage to 98% of people regardless of their Health conditions. 3. We pay out claims within 24 to 48hrs 4. We give coverage to people who Do Not have a social security number. 4. We have a Accidental, Death &amp; Dismemberment Rider for $5.00 ($100,000 additional coverage) 5. We have a Child Rider $4 per child $10,000 coverage 6. Our Clients receive a Free Membership to Funeral Consumer Guardian Society, which helps the customer plan their final wishes and Funeral exactly as they choose. (This Free membership to FCGS can save them up to $4000 on a Traditional Funeral and $600 on a Cremation) Down below are the Qualifications to work on our Team Full Time &amp; Part Time Must Follow our Training System. Give me a call and leave me a brief message. Gracias!!!!! Thanks!!!! IF YOU HAVE MORE QUESTIONS TEXT OR CALL ME SO I CAN EMAIL YOU MORE INFORMATION TO GET YOU STARTED. CALL OR TEXT ME TODAY 800-307-1269 Please leave a message!!! Llmame Hoy !! 800-307-1269 Porfavor deja su mensaje!!! CALL OR TEXT ME TODAY 800-307-1269 Please leave a message!!! Llmame Hoy !! 800-307-1269 Porfavor deja su mensaje!!! Oscar 800-307-1269 Porfavor deja su mensaje Principals only. Recruiters, please don't contact this job poster. post id: 7747584269 updated: [ ]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |6/17/2024      |15              |0       |Unclassified           |LH/GM      |false              |[\n  99\n]      |[\n  "No Education Listed"\n]|99           |No Education Listed|NULL         |NULL              |3              |Part-time / full-time |NULL                |NULL                |false        |92500 |0          |[None]          |year               |150000   |35000      |{\n  "lat": 37.6392595,\n  "lon": -120.9970014\n}|TW9kZXN0bywgQ0E=    |Modesto, CA  |6099  |Stanislaus, CA|33700|Modesto, CA                    |6    |California|6099           |Stanislaus, CA      |6099           |Stanislaus, CA      |33700       |Modesto, CA                    |33700       |Modesto, CA                    |99    |Unclassified Industry                                                   |999   |Unclassified Industry                       |9999  |Unclassified Industry                                       |99999 |Unclassified Industry                     |999999|Unclassified Industry                     |ET0000000000000000|Unclassified       |comisiones de por semana comiensa rapido   |[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |[]                            |[]                          |[]                                                                                                                                                                                                                                                                                                                                     |[]                                                                                                                                                                                                                                                                  |[]                                                                                                             |[]                                                                                                                          |15-2051.01|Business Intelligence Analysts|15-2051.01|Business Intelligence Analysts|[]                             |[]                                                     |[]                         |[]                                   |[]                   |[]                                                        |15-0000   |Computer and Mathematical Occupations|15-2000   |Mathematical Science Occupations|15-2050   |Data Scientists|15-2051   |Data Scientists|23             |Information Technology and Computer Science|231010        |Business Intelligence Analyst|23101012                  |Oracle Consultant / Analyst     |2310                |Business Intelligence        |23101012                     |Oracle Consultant / Analyst       |231010           |Business Intelligence Analyst|2310                   |Business Intelligence        |23                |Information Technology and Computer Science|15-0000|Computer and Mathematical Occupations|15-2000|Mathematical Science Occupations|15-2050|Data Scientists|15-2051|Data Scientists|NULL             |NULL                             |99          |Unclassified Industry                                                   |999         |Unclassified Industry                       |9999        |Unclassified Industry                                       |99999       |Unclassified Industry                     |999999      |Unclassified Industry                     |
+----------------------------------------+-----------------+-----------------------+----------+--------+---------+--------+----------------------+---------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+-------------------+------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------+----------------+--------+-----------------------+-----------+-------------------+----------------+-----------------------------+-------------+-------------------+-------------+------------------+---------------+----------------------+--------------------+--------------------+-------------+------+-----------+----------------+-------------------+---------+-----------+-------------------------------------------------+--------------------+-------------+------+--------------+-----+-------------------------------+-----+----------+---------------+--------------------+---------------+--------------------+------------+-------------------------------+------------+-------------------------------+------+------------------------------------------------------------------------+------+--------------------------------------------+------+------------------------------------------------------------+------+------------------------------------------+------+------------------------------------------+------------------+-------------------+-------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------+----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------+----------+------------------------------+----------+------------------------------+-------------------------------+-------------------------------------------------------+---------------------------+-------------------------------------+---------------------+----------------------------------------------------------+----------+-------------------------------------+----------+--------------------------------+----------+---------------+----------+---------------+---------------+-------------------------------------------+--------------+-----------------------------+--------------------------+--------------------------------+--------------------+-----------------------------+-----------------------------+----------------------------------+-----------------+-----------------------------+-----------------------+-----------------------------+------------------+-------------------------------------------+-------+-------------------------------------+-------+--------------------------------+-------+---------------+-------+---------------+-----------------+---------------------------------+------------+------------------------------------------------------------------------+------------+--------------------------------------------+------------+------------------------------------------------------------+------------+------------------------------------------+------------+------------------------------------------+
only showing top 5 rows</code></pre>
</div>
</div>
</section>
<section id="feature-engineering" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Feature Engineering</h1>
<p>Feature engineering is a crucial step in preparing the dataset for machine learning.<br>
This section cleans the data, encodes categorical variables, and constructs feature vectors for model training.</p>
<div id="af6ed388" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># ======================================================</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># FEATURE ENGINEERING</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># ======================================================</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer, OneHotEncoder, VectorAssembler</span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># 1. Drop rows with missing target or key features</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>df_clean <span class="op">=</span> df.dropna(subset<span class="op">=</span>[</span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="st">"SALARY"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>, <span class="st">"MAX_YEARS_EXPERIENCE"</span>,</span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="st">"EMPLOYMENT_TYPE_NAME"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS_NAME"</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>])</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="bu">print</span>(<span class="ss">f"✅ Rows after dropping nulls: </span><span class="sc">{</span>df_clean<span class="sc">.</span>count()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co"># 2. Create new feature: MIN_YEARS_EXPERIENCE_SQ</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>df_clean <span class="op">=</span> df_clean.withColumn(</span>
<span id="cb4-22"><a href="#cb4-22"></a>    <span class="st">"MIN_YEARS_EXPERIENCE_SQ"</span>,</span>
<span id="cb4-23"><a href="#cb4-23"></a>    F.<span class="bu">pow</span>(F.col(<span class="st">"MIN_YEARS_EXPERIENCE"</span>), <span class="dv">2</span>)</span>
<span id="cb4-24"><a href="#cb4-24"></a>)</span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co"># 3. Encode categorical variables</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>cat_cols <span class="op">=</span> [<span class="st">"EMPLOYMENT_TYPE_NAME"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS_NAME"</span>]</span>
<span id="cb4-30"><a href="#cb4-30"></a></span>
<span id="cb4-31"><a href="#cb4-31"></a>indexers <span class="op">=</span> [</span>
<span id="cb4-32"><a href="#cb4-32"></a>    StringIndexer(inputCol<span class="op">=</span>c, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_IDX"</span>, handleInvalid<span class="op">=</span><span class="st">"keep"</span>)</span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="cf">for</span> c <span class="kw">in</span> cat_cols</span>
<span id="cb4-34"><a href="#cb4-34"></a>]</span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a>encoders <span class="op">=</span> [</span>
<span id="cb4-37"><a href="#cb4-37"></a>    OneHotEncoder(inputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_IDX"</span>, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_OHE"</span>)</span>
<span id="cb4-38"><a href="#cb4-38"></a>    <span class="cf">for</span> c <span class="kw">in</span> cat_cols</span>
<span id="cb4-39"><a href="#cb4-39"></a>]</span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co"># Apply indexers sequentially</span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="cf">for</span> idx <span class="kw">in</span> indexers:</span>
<span id="cb4-43"><a href="#cb4-43"></a>    df_clean <span class="op">=</span> idx.fit(df_clean).transform(df_clean)</span>
<span id="cb4-44"><a href="#cb4-44"></a></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="co"># Apply one-hot encoders sequentially</span></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="cf">for</span> enc <span class="kw">in</span> encoders:</span>
<span id="cb4-47"><a href="#cb4-47"></a>    df_clean <span class="op">=</span> enc.fit(df_clean).transform(df_clean)</span>
<span id="cb4-48"><a href="#cb4-48"></a></span>
<span id="cb4-49"><a href="#cb4-49"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="co"># 4. Assemble final features</span></span>
<span id="cb4-51"><a href="#cb4-51"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>numeric_cols <span class="op">=</span> [</span>
<span id="cb4-53"><a href="#cb4-53"></a>    <span class="st">"MIN_YEARS_EXPERIENCE"</span>, </span>
<span id="cb4-54"><a href="#cb4-54"></a>    <span class="st">"MAX_YEARS_EXPERIENCE"</span>, </span>
<span id="cb4-55"><a href="#cb4-55"></a>    <span class="st">"MIN_YEARS_EXPERIENCE_SQ"</span></span>
<span id="cb4-56"><a href="#cb4-56"></a>]</span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a>ohe_cols <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_OHE"</span> <span class="cf">for</span> c <span class="kw">in</span> cat_cols]</span>
<span id="cb4-59"><a href="#cb4-59"></a></span>
<span id="cb4-60"><a href="#cb4-60"></a>assembler <span class="op">=</span> VectorAssembler(</span>
<span id="cb4-61"><a href="#cb4-61"></a>    inputCols<span class="op">=</span>numeric_cols <span class="op">+</span> ohe_cols,</span>
<span id="cb4-62"><a href="#cb4-62"></a>    outputCol<span class="op">=</span><span class="st">"features"</span></span>
<span id="cb4-63"><a href="#cb4-63"></a>)</span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>df_fe <span class="op">=</span> assembler.transform(df_clean)</span>
<span id="cb4-66"><a href="#cb4-66"></a></span>
<span id="cb4-67"><a href="#cb4-67"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="co"># 5. Show sample of processed data</span></span>
<span id="cb4-69"><a href="#cb4-69"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb4-70"><a href="#cb4-70"></a>df_fe.select(</span>
<span id="cb4-71"><a href="#cb4-71"></a>    <span class="st">"SALARY"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"features"</span></span>
<span id="cb4-72"><a href="#cb4-72"></a>).show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Rows after dropping nulls: 3,756</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+------+--------------------+-----------+----------------------------------------------+
|SALARY|MIN_YEARS_EXPERIENCE|STATE_NAME |features                                      |
+------+--------------------+-----------+----------------------------------------------+
|92962 |2                   |New York   |(63,[0,1,2,3,7,57],[2.0,2.0,4.0,1.0,1.0,1.0]) |
|75026 |2                   |Mississippi|(63,[0,1,2,3,27,57],[2.0,2.0,4.0,1.0,1.0,1.0])|
|60923 |1                   |New York   |(63,[0,1,2,3,7,57],[1.0,1.0,1.0,1.0,1.0,1.0]) |
|131100|2                   |Arizona    |(63,[0,1,2,3,21,57],[2.0,2.0,4.0,1.0,1.0,1.0])|
|136950|3                   |Maine      |(63,[0,1,2,3,46,57],[3.0,3.0,9.0,1.0,1.0,1.0])|
+------+--------------------+-----------+----------------------------------------------+
only showing top 5 rows</code></pre>
</div>
</div>
</section>
<section id="traintest-split" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Train/Test Split</h1>
<p>Splitting the data into training and testing sets ensures that the model is evaluated on unseen data, which helps measure its generalization performance.<br>
Here an <strong>80/20 split</strong> is used, a common practice that provides a large enough training set while reserving sufficient data for evaluation.</p>
<div id="2ba79ce9" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># ======================================================</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># TRAIN / </span><span class="al">TEST</span><span class="co"> SPLIT</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># ======================================================</span></span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># Perform random split with reproducibility</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>train_df, test_df <span class="op">=</span> df_fe.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co"># Display record counts for each subset</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>train_count <span class="op">=</span> train_df.count()</span>
<span id="cb7-10"><a href="#cb7-10"></a>test_count <span class="op">=</span> test_df.count()</span>
<span id="cb7-11"><a href="#cb7-11"></a>total_count <span class="op">=</span> df_fe.count()</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="bu">print</span>(<span class="ss">f"✅ Total records: </span><span class="sc">{</span>total_count<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="bu">print</span>(<span class="ss">f"🧠 Training set: </span><span class="sc">{</span>train_count<span class="sc">:,}</span><span class="ss"> rows (</span><span class="sc">{</span>train_count<span class="op">/</span>total_count<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="bu">print</span>(<span class="ss">f"🧾 Testing set:  </span><span class="sc">{</span>test_count<span class="sc">:,}</span><span class="ss"> rows (</span><span class="sc">{</span>test_count<span class="op">/</span>total_count<span class="sc">:.1%}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Total records: 3,756
🧠 Training set: 3,060 rows (81.5%)
🧾 Testing set:  696 rows (18.5%)</code></pre>
</div>
</div>
</section>
<section id="linear-regression" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Linear Regression</h1>
<p>Zero-variance features to restore full rank, train a Linear Regression model for prediction, and assemble a coefficient table with <strong>SE, t, p, 95% CI</strong> using LR/GLR or a bootstrap fallback when analytic standard errors are unavailable.</p>
<div id="091d653a" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># ======================================================</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># LINEAR REGRESSION with robust &amp; fast inference</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#   - zero-variance pruning (Summarizer.variance)</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#   - LR (L-BFGS + tiny ridge) metrics on test set</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#   - LR -&gt; GLR -&gt; Bootstrap fallback for SE/t/p</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co"># ======================================================</span></span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression, GeneralizedLinearRegression</span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorSlicer</span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="im">from</span> pyspark.ml.stat <span class="im">import</span> Summarizer</span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="im">import</span> math, numpy <span class="im">as</span> np</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co"># ---- Speed / stability toggles ----</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>DO_BOOTSTRAP <span class="op">=</span> <span class="va">False</span>       <span class="co"># turn ON only if you really need SEs; this saves lots of time</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>B <span class="op">=</span> <span class="dv">8</span>                      <span class="co"># bootstrap iterations if enabled</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>BOOTSTRAP_FRACTION <span class="op">=</span> <span class="fl">0.85</span>  <span class="co"># subsample per bootstrap to speed up</span></span>
<span id="cb9-19"><a href="#cb9-19"></a>RIDGE <span class="op">=</span> <span class="fl">1e-4</span>               <span class="co"># tiny L2 to avoid singularities</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>MAXITER_LR <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>MAXITER_GLR <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>TOL <span class="op">=</span> <span class="fl">1e-5</span></span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="co"># -----------------------------</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="co"># Helpers</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="co"># -----------------------------</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb9-28"><a href="#cb9-28"></a>    <span class="co">"""Read feature names from Vector metadata; fallback to generic names."""</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb9-30"><a href="#cb9-30"></a>    <span class="cf">try</span>:</span>
<span id="cb9-31"><a href="#cb9-31"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb9-32"><a href="#cb9-32"></a>        names <span class="op">=</span> []</span>
<span id="cb9-33"><a href="#cb9-33"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb9-34"><a href="#cb9-34"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb9-35"><a href="#cb9-35"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb9-36"><a href="#cb9-36"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb9-37"><a href="#cb9-37"></a>        <span class="cf">return</span> names</span>
<span id="cb9-38"><a href="#cb9-38"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb9-39"><a href="#cb9-39"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).head().n</span>
<span id="cb9-40"><a href="#cb9-40"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb9-41"><a href="#cb9-41"></a></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="kw">def</span> normal_pvalue_from_t(t):</span>
<span id="cb9-43"><a href="#cb9-43"></a>    <span class="co">"""Two-sided p-value from z/t using normal approx."""</span></span>
<span id="cb9-44"><a href="#cb9-44"></a>    <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> t <span class="op">!=</span> t:</span>
<span id="cb9-45"><a href="#cb9-45"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb9-46"><a href="#cb9-46"></a>    <span class="cf">return</span> <span class="fl">2.0</span> <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> math.erf(<span class="bu">abs</span>(<span class="bu">float</span>(t))<span class="op">/</span>math.sqrt(<span class="dv">2</span>))))</span>
<span id="cb9-47"><a href="#cb9-47"></a></span>
<span id="cb9-48"><a href="#cb9-48"></a><span class="kw">def</span> safe_ci(beta, se, z<span class="op">=</span><span class="fl">1.96</span>):</span>
<span id="cb9-49"><a href="#cb9-49"></a>    <span class="cf">try</span>:</span>
<span id="cb9-50"><a href="#cb9-50"></a>        <span class="cf">if</span> se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> se <span class="op">!=</span> se:</span>
<span id="cb9-51"><a href="#cb9-51"></a>            <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>), <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb9-52"><a href="#cb9-52"></a>        <span class="cf">return</span> <span class="bu">float</span>(beta <span class="op">-</span> z<span class="op">*</span>se), <span class="bu">float</span>(beta <span class="op">+</span> z<span class="op">*</span>se)</span>
<span id="cb9-53"><a href="#cb9-53"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb9-54"><a href="#cb9-54"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>), <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb9-55"><a href="#cb9-55"></a></span>
<span id="cb9-56"><a href="#cb9-56"></a><span class="kw">def</span> build_table(coefs, ses, names, intercept<span class="op">=</span><span class="va">None</span>, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>)):</span>
<span id="cb9-57"><a href="#cb9-57"></a>    <span class="co"># Align lengths</span></span>
<span id="cb9-58"><a href="#cb9-58"></a>    <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">!=</span> <span class="bu">len</span>(coefs):</span>
<span id="cb9-59"><a href="#cb9-59"></a>        <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">&gt;</span> <span class="bu">len</span>(coefs):</span>
<span id="cb9-60"><a href="#cb9-60"></a>            names <span class="op">=</span> names[:<span class="bu">len</span>(coefs)]</span>
<span id="cb9-61"><a href="#cb9-61"></a>        <span class="cf">else</span>:</span>
<span id="cb9-62"><a href="#cb9-62"></a>            names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(names), <span class="bu">len</span>(coefs))]</span>
<span id="cb9-63"><a href="#cb9-63"></a></span>
<span id="cb9-64"><a href="#cb9-64"></a>    rows <span class="op">=</span> []</span>
<span id="cb9-65"><a href="#cb9-65"></a>    <span class="cf">for</span> n, b, se <span class="kw">in</span> <span class="bu">zip</span>(names, coefs, ses):</span>
<span id="cb9-66"><a href="#cb9-66"></a>        t <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>) <span class="cf">if</span> (se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> se <span class="op">!=</span> se <span class="kw">or</span> se <span class="op">==</span> <span class="fl">0.0</span>) <span class="cf">else</span> <span class="bu">float</span>(b <span class="op">/</span> se)</span>
<span id="cb9-67"><a href="#cb9-67"></a>        p <span class="op">=</span> normal_pvalue_from_t(t)</span>
<span id="cb9-68"><a href="#cb9-68"></a>        lo, hi <span class="op">=</span> safe_ci(b, se)</span>
<span id="cb9-69"><a href="#cb9-69"></a>        rows.append((n, <span class="bu">float</span>(b), <span class="bu">float</span>(se) <span class="cf">if</span> se <span class="op">==</span> se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>), t, p, lo, hi))</span>
<span id="cb9-70"><a href="#cb9-70"></a></span>
<span id="cb9-71"><a href="#cb9-71"></a>    coef_df <span class="op">=</span> spark.createDataFrame(rows, [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>])</span>
<span id="cb9-72"><a href="#cb9-72"></a></span>
<span id="cb9-73"><a href="#cb9-73"></a>    <span class="co"># Intercept row (if provided)</span></span>
<span id="cb9-74"><a href="#cb9-74"></a>    <span class="cf">if</span> intercept <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-75"><a href="#cb9-75"></a>        t_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>) <span class="cf">if</span> (intercept_se <span class="op">!=</span> intercept_se <span class="kw">or</span> intercept_se <span class="op">==</span> <span class="fl">0.0</span>) <span class="cf">else</span> <span class="bu">float</span>(intercept <span class="op">/</span> intercept_se)</span>
<span id="cb9-76"><a href="#cb9-76"></a>        p_i <span class="op">=</span> normal_pvalue_from_t(t_i)</span>
<span id="cb9-77"><a href="#cb9-77"></a>        lo_i, hi_i <span class="op">=</span> safe_ci(intercept, intercept_se)</span>
<span id="cb9-78"><a href="#cb9-78"></a>        irow <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb9-79"><a href="#cb9-79"></a>            [(<span class="st">"Intercept"</span>, <span class="bu">float</span>(intercept), <span class="bu">float</span>(intercept_se), t_i, p_i, lo_i, hi_i)],</span>
<span id="cb9-80"><a href="#cb9-80"></a>            [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>]</span>
<span id="cb9-81"><a href="#cb9-81"></a>        )</span>
<span id="cb9-82"><a href="#cb9-82"></a>        coef_df <span class="op">=</span> irow.unionByName(coef_df)</span>
<span id="cb9-83"><a href="#cb9-83"></a></span>
<span id="cb9-84"><a href="#cb9-84"></a>    <span class="cf">return</span> coef_df</span>
<span id="cb9-85"><a href="#cb9-85"></a></span>
<span id="cb9-86"><a href="#cb9-86"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-87"><a href="#cb9-87"></a><span class="co"># 1) Zero-variance pruning on TRAIN (robust)</span></span>
<span id="cb9-88"><a href="#cb9-88"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-89"><a href="#cb9-89"></a>feat_names_full <span class="op">=</span> extract_feature_names(train_df, <span class="st">"features"</span>)</span>
<span id="cb9-90"><a href="#cb9-90"></a></span>
<span id="cb9-91"><a href="#cb9-91"></a>var_row <span class="op">=</span> train_df.select(</span>
<span id="cb9-92"><a href="#cb9-92"></a>    Summarizer.variance(train_df[<span class="st">"features"</span>]).alias(<span class="st">"var"</span>)</span>
<span id="cb9-93"><a href="#cb9-93"></a>).first()</span>
<span id="cb9-94"><a href="#cb9-94"></a></span>
<span id="cb9-95"><a href="#cb9-95"></a><span class="co"># Convert variance vector to 1-D numpy safely</span></span>
<span id="cb9-96"><a href="#cb9-96"></a>variances <span class="op">=</span> var_row[<span class="st">"var"</span>].toArray() <span class="cf">if</span> <span class="bu">hasattr</span>(var_row[<span class="st">"var"</span>], <span class="st">"toArray"</span>) <span class="cf">else</span> np.array(var_row[<span class="st">"var"</span>]).ravel()</span>
<span id="cb9-97"><a href="#cb9-97"></a></span>
<span id="cb9-98"><a href="#cb9-98"></a>keep_idx <span class="op">=</span> [<span class="bu">int</span>(i) <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(variances) <span class="cf">if</span> (v <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>) <span class="kw">and</span> <span class="kw">not</span> np.isnan(v) <span class="kw">and</span> v <span class="op">&gt;</span> <span class="fl">1e-12</span>]</span>
<span id="cb9-99"><a href="#cb9-99"></a><span class="cf">if</span> <span class="kw">not</span> keep_idx:  <span class="co"># safety fallback</span></span>
<span id="cb9-100"><a href="#cb9-100"></a>    keep_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(variances)))</span>
<span id="cb9-101"><a href="#cb9-101"></a></span>
<span id="cb9-102"><a href="#cb9-102"></a>removed <span class="op">=</span> <span class="bu">len</span>(variances) <span class="op">-</span> <span class="bu">len</span>(keep_idx)</span>
<span id="cb9-103"><a href="#cb9-103"></a><span class="bu">print</span>(<span class="ss">f"ℹ️ Removed </span><span class="sc">{</span>removed<span class="sc">}</span><span class="ss"> zero-variance feature(s)."</span> <span class="cf">if</span> removed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"ℹ️ No zero-variance features found."</span>)</span>
<span id="cb9-104"><a href="#cb9-104"></a></span>
<span id="cb9-105"><a href="#cb9-105"></a>slicer <span class="op">=</span> VectorSlicer(inputCol<span class="op">=</span><span class="st">"features"</span>, outputCol<span class="op">=</span><span class="st">"features_nz"</span>, indices<span class="op">=</span>keep_idx)</span>
<span id="cb9-106"><a href="#cb9-106"></a>train_nz <span class="op">=</span> slicer.transform(train_df).drop(<span class="st">"features"</span>).withColumnRenamed(<span class="st">"features_nz"</span>, <span class="st">"features"</span>)</span>
<span id="cb9-107"><a href="#cb9-107"></a>test_nz  <span class="op">=</span> slicer.transform(test_df ).drop(<span class="st">"features"</span>).withColumnRenamed(<span class="st">"features_nz"</span>, <span class="st">"features"</span>)</span>
<span id="cb9-108"><a href="#cb9-108"></a></span>
<span id="cb9-109"><a href="#cb9-109"></a>feat_names <span class="op">=</span> [feat_names_full[i] <span class="cf">for</span> i <span class="kw">in</span> keep_idx] <span class="cf">if</span> keep_idx <span class="cf">else</span> feat_names_full</span>
<span id="cb9-110"><a href="#cb9-110"></a></span>
<span id="cb9-111"><a href="#cb9-111"></a><span class="co"># Cache &amp; materialize once to avoid recomputation across fits</span></span>
<span id="cb9-112"><a href="#cb9-112"></a>train_nz <span class="op">=</span> train_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb9-113"><a href="#cb9-113"></a>test_nz  <span class="op">=</span> test_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb9-114"><a href="#cb9-114"></a>_ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb9-115"><a href="#cb9-115"></a></span>
<span id="cb9-116"><a href="#cb9-116"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-117"><a href="#cb9-117"></a><span class="co"># 2) Fit Linear Regression (fast/stable) + </span><span class="al">TEST</span><span class="co"> metrics</span></span>
<span id="cb9-118"><a href="#cb9-118"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-119"><a href="#cb9-119"></a>lr <span class="op">=</span> LinearRegression(</span>
<span id="cb9-120"><a href="#cb9-120"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb9-121"><a href="#cb9-121"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb9-122"><a href="#cb9-122"></a>    predictionCol<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb9-123"><a href="#cb9-123"></a>    fitIntercept<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-124"><a href="#cb9-124"></a>    regParam<span class="op">=</span>RIDGE,             <span class="co"># tiny L2 prevents singularities</span></span>
<span id="cb9-125"><a href="#cb9-125"></a>    elasticNetParam<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb9-126"><a href="#cb9-126"></a>    solver<span class="op">=</span><span class="st">"l-bfgs"</span>,            <span class="co"># faster &amp; avoids Cholesky path</span></span>
<span id="cb9-127"><a href="#cb9-127"></a>    maxIter<span class="op">=</span>MAXITER_LR,</span>
<span id="cb9-128"><a href="#cb9-128"></a>    tol<span class="op">=</span>TOL,</span>
<span id="cb9-129"><a href="#cb9-129"></a>    standardization<span class="op">=</span><span class="va">True</span></span>
<span id="cb9-130"><a href="#cb9-130"></a>)</span>
<span id="cb9-131"><a href="#cb9-131"></a>lr_model <span class="op">=</span> lr.fit(train_nz)</span>
<span id="cb9-132"><a href="#cb9-132"></a>lr_sum   <span class="op">=</span> lr_model.summary</span>
<span id="cb9-133"><a href="#cb9-133"></a></span>
<span id="cb9-134"><a href="#cb9-134"></a>e_rmse <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"rmse"</span>)</span>
<span id="cb9-135"><a href="#cb9-135"></a>e_r2   <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb9-136"><a href="#cb9-136"></a>e_mae  <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"mae"</span>)</span>
<span id="cb9-137"><a href="#cb9-137"></a></span>
<span id="cb9-138"><a href="#cb9-138"></a>pred_test <span class="op">=</span> lr_model.transform(test_nz).cache()</span>
<span id="cb9-139"><a href="#cb9-139"></a>rmse_test <span class="op">=</span> e_rmse.evaluate(pred_test)</span>
<span id="cb9-140"><a href="#cb9-140"></a>r2_test   <span class="op">=</span> e_r2.evaluate(pred_test)</span>
<span id="cb9-141"><a href="#cb9-141"></a>mae_test  <span class="op">=</span> e_mae.evaluate(pred_test)</span>
<span id="cb9-142"><a href="#cb9-142"></a></span>
<span id="cb9-143"><a href="#cb9-143"></a><span class="bu">print</span>(<span class="ss">f"✅ Test RMSE: </span><span class="sc">{</span>rmse_test<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-144"><a href="#cb9-144"></a><span class="bu">print</span>(<span class="ss">f"✅ Test MAE : </span><span class="sc">{</span>mae_test<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-145"><a href="#cb9-145"></a><span class="bu">print</span>(<span class="ss">f"✅ Test R²  : </span><span class="sc">{</span>r2_test<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-146"><a href="#cb9-146"></a></span>
<span id="cb9-147"><a href="#cb9-147"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Training Metrics (reference) ---"</span>)</span>
<span id="cb9-148"><a href="#cb9-148"></a><span class="bu">print</span>(<span class="ss">f"RMSE: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>rootMeanSquaredError<span class="sc">:,.2f}</span><span class="ss"> | MAE: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>meanAbsoluteError<span class="sc">:,.2f}</span><span class="ss"> | R²: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>r2<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-149"><a href="#cb9-149"></a></span>
<span id="cb9-150"><a href="#cb9-150"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-151"><a href="#cb9-151"></a><span class="co"># 3) Inference: LR -&gt; GLR -&gt; Bootstrap fallback</span></span>
<span id="cb9-152"><a href="#cb9-152"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb9-153"><a href="#cb9-153"></a>coef_df_out <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-154"><a href="#cb9-154"></a>got_inference <span class="op">=</span> <span class="va">False</span></span>
<span id="cb9-155"><a href="#cb9-155"></a></span>
<span id="cb9-156"><a href="#cb9-156"></a><span class="co"># (a) Try LR analytic inference (may be unavailable)</span></span>
<span id="cb9-157"><a href="#cb9-157"></a><span class="cf">try</span>:</span>
<span id="cb9-158"><a href="#cb9-158"></a>    ses_lr   <span class="op">=</span> <span class="bu">list</span>(lr_sum.coefficientStandardErrors)</span>
<span id="cb9-159"><a href="#cb9-159"></a>    coefs_lr <span class="op">=</span> <span class="bu">list</span>(lr_model.coefficients.toArray())</span>
<span id="cb9-160"><a href="#cb9-160"></a>    coef_df_out <span class="op">=</span> build_table(coefs_lr, ses_lr, feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb9-161"><a href="#cb9-161"></a>    got_inference <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-162"><a href="#cb9-162"></a>    <span class="bu">print</span>(<span class="st">"ℹ️ Using LR analytic standard errors."</span>)</span>
<span id="cb9-163"><a href="#cb9-163"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb9-164"><a href="#cb9-164"></a>    <span class="cf">pass</span></span>
<span id="cb9-165"><a href="#cb9-165"></a></span>
<span id="cb9-166"><a href="#cb9-166"></a><span class="co"># (b) GLR fallback (Gaussian/identity) with tiny ridge and L-BFGS</span></span>
<span id="cb9-167"><a href="#cb9-167"></a><span class="cf">if</span> <span class="kw">not</span> got_inference:</span>
<span id="cb9-168"><a href="#cb9-168"></a>    <span class="cf">try</span>:</span>
<span id="cb9-169"><a href="#cb9-169"></a>        glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb9-170"><a href="#cb9-170"></a>            featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_glr"</span>,</span>
<span id="cb9-171"><a href="#cb9-171"></a>            family<span class="op">=</span><span class="st">"gaussian"</span>, link<span class="op">=</span><span class="st">"identity"</span>,</span>
<span id="cb9-172"><a href="#cb9-172"></a>            fitIntercept<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-173"><a href="#cb9-173"></a>            regParam<span class="op">=</span>RIDGE,</span>
<span id="cb9-174"><a href="#cb9-174"></a>            maxIter<span class="op">=</span>MAXITER_GLR,</span>
<span id="cb9-175"><a href="#cb9-175"></a>            tol<span class="op">=</span>TOL</span>
<span id="cb9-176"><a href="#cb9-176"></a>        )</span>
<span id="cb9-177"><a href="#cb9-177"></a>        glr_model <span class="op">=</span> glr.fit(train_nz)</span>
<span id="cb9-178"><a href="#cb9-178"></a>        glr_sum   <span class="op">=</span> glr_model.summary</span>
<span id="cb9-179"><a href="#cb9-179"></a></span>
<span id="cb9-180"><a href="#cb9-180"></a>        ses_all <span class="op">=</span> <span class="bu">list</span>(glr_sum.coefficientStandardErrors)  <span class="co"># may include intercept as last element</span></span>
<span id="cb9-181"><a href="#cb9-181"></a>        coefs_g <span class="op">=</span> <span class="bu">list</span>(glr_model.coefficients.toArray())</span>
<span id="cb9-182"><a href="#cb9-182"></a></span>
<span id="cb9-183"><a href="#cb9-183"></a>        <span class="co"># Intercept SE often appears as the last element</span></span>
<span id="cb9-184"><a href="#cb9-184"></a>        intercept_se <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb9-185"><a href="#cb9-185"></a>        <span class="cf">if</span> <span class="bu">len</span>(ses_all) <span class="op">==</span> <span class="bu">len</span>(coefs_g) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb9-186"><a href="#cb9-186"></a>            intercept_se <span class="op">=</span> <span class="bu">float</span>(ses_all[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb9-187"><a href="#cb9-187"></a>            ses_g <span class="op">=</span> ses_all[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-188"><a href="#cb9-188"></a>        <span class="cf">else</span>:</span>
<span id="cb9-189"><a href="#cb9-189"></a>            ses_g <span class="op">=</span> ses_all</span>
<span id="cb9-190"><a href="#cb9-190"></a></span>
<span id="cb9-191"><a href="#cb9-191"></a>        coef_df_out <span class="op">=</span> build_table(coefs_g, ses_g, feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span>intercept_se)</span>
<span id="cb9-192"><a href="#cb9-192"></a>        got_inference <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-193"><a href="#cb9-193"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Using GLR analytic standard errors."</span>)</span>
<span id="cb9-194"><a href="#cb9-194"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb9-195"><a href="#cb9-195"></a>        <span class="cf">pass</span></span>
<span id="cb9-196"><a href="#cb9-196"></a></span>
<span id="cb9-197"><a href="#cb9-197"></a><span class="co"># (c) Bootstrap fallback (lightweight) if analytic SEs are unavailable</span></span>
<span id="cb9-198"><a href="#cb9-198"></a><span class="cf">if</span> <span class="kw">not</span> got_inference:</span>
<span id="cb9-199"><a href="#cb9-199"></a>    <span class="cf">if</span> DO_BOOTSTRAP:</span>
<span id="cb9-200"><a href="#cb9-200"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Analytic SE unavailable — running bootstrap (B=</span><span class="sc">{</span>B<span class="sc">}</span><span class="ss">)."</span>)</span>
<span id="cb9-201"><a href="#cb9-201"></a>        coef_mat <span class="op">=</span> []</span>
<span id="cb9-202"><a href="#cb9-202"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(B):</span>
<span id="cb9-203"><a href="#cb9-203"></a>            samp <span class="op">=</span> train_nz.sample(withReplacement<span class="op">=</span><span class="va">True</span>, fraction<span class="op">=</span>BOOTSTRAP_FRACTION, seed<span class="op">=</span><span class="dv">2025</span> <span class="op">+</span> b)</span>
<span id="cb9-204"><a href="#cb9-204"></a>            m <span class="op">=</span> lr.fit(samp)</span>
<span id="cb9-205"><a href="#cb9-205"></a>            coef_mat.append(m.coefficients.toArray())</span>
<span id="cb9-206"><a href="#cb9-206"></a>        coef_mat <span class="op">=</span> np.array(coef_mat)  <span class="co"># [B, p]</span></span>
<span id="cb9-207"><a href="#cb9-207"></a>        coefs <span class="op">=</span> lr_model.coefficients.toArray()</span>
<span id="cb9-208"><a href="#cb9-208"></a>        ses   <span class="op">=</span> np.std(coef_mat, axis<span class="op">=</span><span class="dv">0</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-209"><a href="#cb9-209"></a>        coef_df_out <span class="op">=</span> build_table(<span class="bu">list</span>(coefs), <span class="bu">list</span>(ses), feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb9-210"><a href="#cb9-210"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Bootstrap SE computed."</span>)</span>
<span id="cb9-211"><a href="#cb9-211"></a>    <span class="cf">else</span>:</span>
<span id="cb9-212"><a href="#cb9-212"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Skipping bootstrap; reporting coefficients without SE."</span>)</span>
<span id="cb9-213"><a href="#cb9-213"></a>        coefs <span class="op">=</span> lr_model.coefficients.toArray()</span>
<span id="cb9-214"><a href="#cb9-214"></a>        ses   <span class="op">=</span> [<span class="bu">float</span>(<span class="st">"nan"</span>)] <span class="op">*</span> <span class="bu">len</span>(coefs)</span>
<span id="cb9-215"><a href="#cb9-215"></a>        coef_df_out <span class="op">=</span> build_table(<span class="bu">list</span>(coefs), ses, feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb9-216"><a href="#cb9-216"></a></span>
<span id="cb9-217"><a href="#cb9-217"></a><span class="co"># Order and display</span></span>
<span id="cb9-218"><a href="#cb9-218"></a>coef_df_out <span class="op">=</span> coef_df_out.withColumn(<span class="st">"abs_t"</span>, F.<span class="bu">abs</span>(F.col(<span class="st">"t"</span>))).orderBy(F.desc_nulls_last(<span class="st">"abs_t"</span>))</span>
<span id="cb9-219"><a href="#cb9-219"></a></span>
<span id="cb9-220"><a href="#cb9-220"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 25 coefficients by |t| ---"</span>)</span>
<span id="cb9-221"><a href="#cb9-221"></a>coef_df_out.select(<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>).show(<span class="dv">25</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-222"><a href="#cb9-222"></a></span>
<span id="cb9-223"><a href="#cb9-223"></a><span class="co"># save the full table</span></span>
<span id="cb9-224"><a href="#cb9-224"></a>coef_df_out.coalesce(<span class="dv">1</span>).write.mode(<span class="st">"overwrite"</span>).option(<span class="st">"header"</span>, <span class="va">True</span>).csv(<span class="st">"output/linear_coef_table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ℹ️ No zero-variance features found.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Test RMSE: 28,611.48
✅ Test MAE : 21,746.31
✅ Test R²  : 0.3894

--- Training Metrics (reference) ---
RMSE: 28,132.08 | MAE: 21,423.03 | R²: 0.3984
ℹ️ Using GLR analytic standard errors.

--- Top 25 coefficients by |t| ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------------------------------------------+-------------------+--------------------+----------------------+----------------------+---------------------+--------------------+
|feature                                            |coef               |se                  |t                     |p                     |ci_lo                |ci_hi               |
+---------------------------------------------------+-------------------+--------------------+----------------------+----------------------+---------------------+--------------------+
|EMPLOYMENT_TYPE_NAME_OHE_Part-time / full-time     |-436.9080972892671 |69.3292813946319    |-6.301927389126183    |2.9396685086169327E-10|-572.7934888227456   |-301.0227057557886  |
|EMPLOYMENT_TYPE_NAME_OHE_Full-time (&gt; 32 hours)    |6258.360496747176  |2905898.0293275653  |0.002153675192172996  |0.9982816171435818    |-5689301.77698528    |5701818.497978775   |
|EMPLOYMENT_TYPE_NAME_OHE_Part-time (â‰¤ 32 hours)  |6258.359688950314  |2905898.029327563   |0.0021536749141877237 |0.9982816173653815    |-5689301.777793073   |5701818.4971709745  |
|MIN_YEARS_EXPERIENCE_SQ                            |29150.376482729233 |1.5582061749502098E7|0.0018707650471004385 |0.9985073463226843    |-3.0511690652541384E7|3.056999140550684E7 |
|MIN_EDULEVELS_NAME_OHE_Ph.D. or professional degree|-29043.691507795553|1.5582053274124946E7|-0.001863919407593386 |0.9985128083432329    |-3.056986810879269E7 |3.05117807257771E7  |
|Intercept                                          |68743.68355159911  |3.80093837310353E7  |0.0018085976883510674 |0.9985569486144708    |-7.442964842927758E7 |7.456713579638077E7 |
|STATE_NAME_OHE_Connecticut                         |-17663.860244489424|1.0020132309091674E7|-0.0017628370264594494|0.9985934602818689    |-1.9657123186064173E7|1.9621795465575192E7|
|MIN_YEARS_EXPERIENCE                               |-18109.66911516427 |1.5582053498943115E7|-0.0011622132549084494|0.9990726881963077    |-3.0558934527043667E7|3.052271518881334E7 |
|STATE_NAME_OHE_Montana                             |-11072.044985321862|1.002013396778095E7 |-0.0011049797358920809|0.9991183539081439    |-1.965053462183598E7 |1.962839053186534E7 |
|MIN_EDULEVELS_NAME_OHE_No Education Listed         |-10346.395199394145|1.0020134384535242E7|-0.0010325605228770627|0.9991761360470999    |-1.964980978888847E7 |1.9629116998489678E7|
|MIN_EDULEVELS_NAME_OHE_High school or GED          |-9930.584453449697 |1.0020135761275373E7|-9.910628648194804E-4 |0.9992092463708226    |-1.964939667655318E7 |1.962953550764628E7 |
|STATE_NAME_OHE_Alabama                             |-9872.895277691941 |1.002013351335754E7 |-9.853057610989594E-4 |0.9992138398727533    |-1.9649334581458468E7|1.9629588790903088E7|
|MAX_YEARS_EXPERIENCE                               |14766.767394301196 |1.558205356555894E7 |9.47677873919021E-4   |0.9992438625689659    |-3.052605822110122E7 |3.055559175588982E7 |
|STATE_NAME_OHE_Nebraska                            |-8887.928397715923 |1.002013351242271E7 |-8.870069831601438E-4 |0.9992922709156169    |-1.9648349612746228E7|1.9630573755950797E7|
|STATE_NAME_OHE_Minnesota                           |-8101.750517520038 |1.0020132306329196E7|-8.085472596407318E-4 |0.9993548726951451    |-1.9647561070922747E7|1.9631357569887705E7|
|STATE_NAME_OHE_Indiana                             |7428.369292534769  |1.0020132096442766E7|7.413444474621152E-4  |0.9994084927653142    |-1.9632030539735287E7|1.9646887278320357E7|
|STATE_NAME_OHE_New Hampshire                       |-7188.149221746073 |1.0020132767674806E7|-7.173706564982072E-4 |0.9994276210779001    |-1.9646648373864364E7|1.9632272075420875E7|
|STATE_NAME_OHE_Delaware                            |-7108.928165080312 |1.0020132661882797E7|-7.094644756673845E-4 |0.9994339292959145    |-1.9646568945455365E7|1.96323510891252E7  |
|STATE_NAME_OHE_North Dakota                        |-6703.722634366267 |1.0020133393589491E7|-6.690252884911751E-4 |0.9994661950913475    |-1.964616517406977E7 |1.9632757728801034E7|
|STATE_NAME_OHE_Kansas                              |-6695.740085623626 |1.0020132304784678E7|-6.682287101564884E-4 |0.9994668306687602    |-1.9646155057463594E7|1.9632763577292345E7|
|STATE_NAME_OHE_South Carolina                      |6328.584750063926  |1.002013239144552E7 |6.315869394566906E-4  |0.9994960665657062    |-1.9633130902483154E7|1.964578807198328E7 |
|STATE_NAME_OHE_Florida                             |6324.89565066107   |1.0020131386711804E7|6.312188340213612E-4  |0.9994963602712912    |-1.9633132622304473E7|1.9645782413605798E7|
|STATE_NAME_OHE_Arkansas                            |-6263.40939733072  |1.002013196744128E7 |-6.25082525627667E-4  |0.9995012563360528    |-1.964572206558224E7 |1.9633195246787578E7|
|STATE_NAME_OHE_Iowa                                |-5958.1185109991575|1.0020132953483095E7|-5.946147160580397E-4 |0.9995255661263884    |-1.9645418707337864E7|1.9633502470315866E7|
|STATE_NAME_OHE_Pennsylvania                        |-5819.495197114991 |1.002013172388838E7 |-5.807803088297822E-4 |0.9995366043844174    |-1.964527767401834E7 |1.963363868362411E7 |
+---------------------------------------------------+-------------------+--------------------+----------------------+----------------------+---------------------+--------------------+
only showing top 25 rows</code></pre>
</div>
</div>
<section id="generalized-linear-regression-summary" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="generalized-linear-regression-summary"><span class="header-section-number">5.1</span> Generalized Linear Regression Summary</h2>
<div id="573b389f" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># ======================================================</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co"># GLR SUMMARY (defensive, with bootstrap fallback)</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co"># ======================================================</span></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GeneralizedLinearRegression</span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="im">import</span> math, numpy <span class="im">as</span> np</span>
<span id="cb13-8"><a href="#cb13-8"></a></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co"># ---------- safety: cache the pruned datasets ----------</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="cf">try</span>:</span>
<span id="cb13-11"><a href="#cb13-11"></a>    train_nz <span class="op">=</span> train_nz.cache()<span class="op">;</span> test_nz <span class="op">=</span> test_nz.cache()</span>
<span id="cb13-12"><a href="#cb13-12"></a>    _ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb13-14"><a href="#cb13-14"></a>    <span class="co"># If you haven't run the train/test split + pruning cells yet</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the Train/Test Split cell first."</span>)</span>
<span id="cb13-16"><a href="#cb13-16"></a></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co"># ---------- settings (tweakable) ----------</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>DO_BOOTSTRAP <span class="op">=</span> <span class="va">True</span></span>
<span id="cb13-19"><a href="#cb13-19"></a>B <span class="op">=</span> <span class="dv">8</span>                    <span class="co"># keep modest for speed</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>BOOTSTRAP_FRACTION <span class="op">=</span> <span class="fl">0.85</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>Z_95 <span class="op">=</span> <span class="fl">1.96</span></span>
<span id="cb13-22"><a href="#cb13-22"></a></span>
<span id="cb13-23"><a href="#cb13-23"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb13-25"><a href="#cb13-25"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb13-26"><a href="#cb13-26"></a>    <span class="cf">try</span>:</span>
<span id="cb13-27"><a href="#cb13-27"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb13-28"><a href="#cb13-28"></a>        names <span class="op">=</span> []</span>
<span id="cb13-29"><a href="#cb13-29"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb13-30"><a href="#cb13-30"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb13-31"><a href="#cb13-31"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb13-32"><a href="#cb13-32"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb13-33"><a href="#cb13-33"></a>        <span class="cf">return</span> names</span>
<span id="cb13-34"><a href="#cb13-34"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb13-35"><a href="#cb13-35"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb13-36"><a href="#cb13-36"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb13-37"><a href="#cb13-37"></a></span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="kw">def</span> normal_pvalue_from_t(t):</span>
<span id="cb13-39"><a href="#cb13-39"></a>    <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> (<span class="bu">isinstance</span>(t, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(t)):</span>
<span id="cb13-40"><a href="#cb13-40"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb13-41"><a href="#cb13-41"></a>    z <span class="op">=</span> <span class="bu">abs</span>(<span class="bu">float</span>(t))</span>
<span id="cb13-42"><a href="#cb13-42"></a>    <span class="cf">return</span> <span class="fl">2.0</span> <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> math.erf(z <span class="op">/</span> math.sqrt(<span class="dv">2</span>))))</span>
<span id="cb13-43"><a href="#cb13-43"></a></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="kw">def</span> build_table(coefs, ses, names, intercept<span class="op">=</span><span class="va">None</span>, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>)):</span>
<span id="cb13-45"><a href="#cb13-45"></a>    <span class="co"># align lengths</span></span>
<span id="cb13-46"><a href="#cb13-46"></a>    <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">!=</span> <span class="bu">len</span>(coefs):</span>
<span id="cb13-47"><a href="#cb13-47"></a>        <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">&gt;</span> <span class="bu">len</span>(coefs):</span>
<span id="cb13-48"><a href="#cb13-48"></a>            names <span class="op">=</span> names[:<span class="bu">len</span>(coefs)]</span>
<span id="cb13-49"><a href="#cb13-49"></a>        <span class="cf">else</span>:</span>
<span id="cb13-50"><a href="#cb13-50"></a>            names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(names), <span class="bu">len</span>(coefs))]</span>
<span id="cb13-51"><a href="#cb13-51"></a></span>
<span id="cb13-52"><a href="#cb13-52"></a>    rows <span class="op">=</span> []</span>
<span id="cb13-53"><a href="#cb13-53"></a>    <span class="cf">for</span> n, b, se <span class="kw">in</span> <span class="bu">zip</span>(names, coefs, ses):</span>
<span id="cb13-54"><a href="#cb13-54"></a>        <span class="cf">if</span> se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> (<span class="bu">isinstance</span>(se, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(se)) <span class="kw">or</span> se <span class="op">==</span> <span class="fl">0.0</span>:</span>
<span id="cb13-55"><a href="#cb13-55"></a>            t <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> p <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> lo <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> hi <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb13-56"><a href="#cb13-56"></a>        <span class="cf">else</span>:</span>
<span id="cb13-57"><a href="#cb13-57"></a>            t <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">/</span> <span class="bu">float</span>(se)</span>
<span id="cb13-58"><a href="#cb13-58"></a>            p <span class="op">=</span> normal_pvalue_from_t(t)</span>
<span id="cb13-59"><a href="#cb13-59"></a>            lo <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">-</span> Z_95<span class="op">*</span><span class="bu">float</span>(se)</span>
<span id="cb13-60"><a href="#cb13-60"></a>            hi <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">+</span> Z_95<span class="op">*</span><span class="bu">float</span>(se)</span>
<span id="cb13-61"><a href="#cb13-61"></a>        rows.append((n, <span class="bu">float</span>(b), <span class="bu">float</span>(se) <span class="cf">if</span> se <span class="op">==</span> se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>), t, p, lo, hi))</span>
<span id="cb13-62"><a href="#cb13-62"></a></span>
<span id="cb13-63"><a href="#cb13-63"></a>    coef_df <span class="op">=</span> spark.createDataFrame(rows, [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>])</span>
<span id="cb13-64"><a href="#cb13-64"></a></span>
<span id="cb13-65"><a href="#cb13-65"></a>    <span class="co"># intercept row (optional)</span></span>
<span id="cb13-66"><a href="#cb13-66"></a>    <span class="cf">if</span> intercept <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-67"><a href="#cb13-67"></a>        <span class="cf">if</span> (intercept_se <span class="kw">is</span> <span class="va">None</span>) <span class="kw">or</span> (<span class="bu">isinstance</span>(intercept_se, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(intercept_se)) <span class="kw">or</span> intercept_se <span class="op">==</span> <span class="fl">0.0</span>:</span>
<span id="cb13-68"><a href="#cb13-68"></a>            t_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> p_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> lo_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> hi_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb13-69"><a href="#cb13-69"></a>        <span class="cf">else</span>:</span>
<span id="cb13-70"><a href="#cb13-70"></a>            t_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">/</span> <span class="bu">float</span>(intercept_se)</span>
<span id="cb13-71"><a href="#cb13-71"></a>            p_i <span class="op">=</span> normal_pvalue_from_t(t_i)</span>
<span id="cb13-72"><a href="#cb13-72"></a>            lo_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">-</span> Z_95<span class="op">*</span><span class="bu">float</span>(intercept_se)</span>
<span id="cb13-73"><a href="#cb13-73"></a>            hi_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">+</span> Z_95<span class="op">*</span><span class="bu">float</span>(intercept_se)</span>
<span id="cb13-74"><a href="#cb13-74"></a>        irow <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb13-75"><a href="#cb13-75"></a>            [(<span class="st">"Intercept"</span>, <span class="bu">float</span>(intercept), <span class="bu">float</span>(intercept_se) <span class="cf">if</span> intercept_se<span class="op">==</span>intercept_se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>),</span>
<span id="cb13-76"><a href="#cb13-76"></a>              t_i, p_i, lo_i, hi_i)],</span>
<span id="cb13-77"><a href="#cb13-77"></a>            [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>]</span>
<span id="cb13-78"><a href="#cb13-78"></a>        )</span>
<span id="cb13-79"><a href="#cb13-79"></a>        coef_df <span class="op">=</span> irow.unionByName(coef_df)</span>
<span id="cb13-80"><a href="#cb13-80"></a></span>
<span id="cb13-81"><a href="#cb13-81"></a>    <span class="cf">return</span> coef_df</span>
<span id="cb13-82"><a href="#cb13-82"></a></span>
<span id="cb13-83"><a href="#cb13-83"></a><span class="co"># ---------- 1) Fit GLR and print model metrics (all getattr-guarded) ----------</span></span>
<span id="cb13-84"><a href="#cb13-84"></a>glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb13-85"><a href="#cb13-85"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_glr"</span>,</span>
<span id="cb13-86"><a href="#cb13-86"></a>    family<span class="op">=</span><span class="st">"gaussian"</span>, link<span class="op">=</span><span class="st">"identity"</span>, fitIntercept<span class="op">=</span><span class="va">True</span>, regParam<span class="op">=</span><span class="fl">0.0</span>, maxIter<span class="op">=</span><span class="dv">100</span></span>
<span id="cb13-87"><a href="#cb13-87"></a>)</span>
<span id="cb13-88"><a href="#cb13-88"></a>glr_model <span class="op">=</span> glr.fit(train_nz)</span>
<span id="cb13-89"><a href="#cb13-89"></a>glr_sum   <span class="op">=</span> glr_model.summary</span>
<span id="cb13-90"><a href="#cb13-90"></a></span>
<span id="cb13-91"><a href="#cb13-91"></a><span class="bu">print</span>(<span class="st">"✅ GLR Model Summary"</span>)</span>
<span id="cb13-92"><a href="#cb13-92"></a><span class="bu">print</span>(<span class="ss">f"AIC: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'aic'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-93"><a href="#cb13-93"></a><span class="bu">print</span>(<span class="ss">f"Deviance: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'deviance'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-94"><a href="#cb13-94"></a><span class="bu">print</span>(<span class="ss">f"Dispersion: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'dispersion'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb13-95"><a href="#cb13-95"></a><span class="bu">print</span>(<span class="ss">f"Null Deviance: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'nullDeviance'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-96"><a href="#cb13-96"></a><span class="bu">print</span>(<span class="ss">f"Residual DF: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'residualDegreeOfFreedom'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-97"><a href="#cb13-97"></a></span>
<span id="cb13-98"><a href="#cb13-98"></a>feat_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb13-99"><a href="#cb13-99"></a>coefs <span class="op">=</span> <span class="bu">list</span>(glr_model.coefficients.toArray())</span>
<span id="cb13-100"><a href="#cb13-100"></a></span>
<span id="cb13-101"><a href="#cb13-101"></a><span class="co"># ---------- 2) Try analytic SE; else bootstrap; else NA ----------</span></span>
<span id="cb13-102"><a href="#cb13-102"></a>coef_df_glr <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-103"><a href="#cb13-103"></a>intercept_se <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb13-104"><a href="#cb13-104"></a></span>
<span id="cb13-105"><a href="#cb13-105"></a><span class="cf">try</span>:</span>
<span id="cb13-106"><a href="#cb13-106"></a>    ses_all <span class="op">=</span> <span class="bu">list</span>(glr_sum.coefficientStandardErrors)  <span class="co"># may include intercept as last element</span></span>
<span id="cb13-107"><a href="#cb13-107"></a>    <span class="cf">if</span> <span class="bu">len</span>(ses_all) <span class="op">==</span> <span class="bu">len</span>(coefs) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb13-108"><a href="#cb13-108"></a>        intercept_se <span class="op">=</span> <span class="bu">float</span>(ses_all[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span> ses <span class="op">=</span> ses_all[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-109"><a href="#cb13-109"></a>    <span class="cf">else</span>:</span>
<span id="cb13-110"><a href="#cb13-110"></a>        ses <span class="op">=</span> ses_all</span>
<span id="cb13-111"><a href="#cb13-111"></a>    coef_df_glr <span class="op">=</span> build_table(coefs, ses, feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span>intercept_se)</span>
<span id="cb13-112"><a href="#cb13-112"></a>    <span class="bu">print</span>(<span class="st">"ℹ️ Using GLR analytic standard errors."</span>)</span>
<span id="cb13-113"><a href="#cb13-113"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb13-114"><a href="#cb13-114"></a>    <span class="bu">print</span>(<span class="st">"⚠️ GLR analytic SE unavailable."</span>)</span>
<span id="cb13-115"><a href="#cb13-115"></a>    <span class="cf">if</span> DO_BOOTSTRAP:</span>
<span id="cb13-116"><a href="#cb13-116"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Running GLR bootstrap (B=</span><span class="sc">{</span>B<span class="sc">}</span><span class="ss">)."</span>)</span>
<span id="cb13-117"><a href="#cb13-117"></a>        coef_mat <span class="op">=</span> []</span>
<span id="cb13-118"><a href="#cb13-118"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(B):</span>
<span id="cb13-119"><a href="#cb13-119"></a>            samp <span class="op">=</span> train_nz.sample(withReplacement<span class="op">=</span><span class="va">True</span>, fraction<span class="op">=</span>BOOTSTRAP_FRACTION, seed<span class="op">=</span><span class="dv">4100</span> <span class="op">+</span> b)</span>
<span id="cb13-120"><a href="#cb13-120"></a>            m <span class="op">=</span> glr.fit(samp)</span>
<span id="cb13-121"><a href="#cb13-121"></a>            coef_mat.append(m.coefficients.toArray())</span>
<span id="cb13-122"><a href="#cb13-122"></a>        coef_mat <span class="op">=</span> np.array(coef_mat)</span>
<span id="cb13-123"><a href="#cb13-123"></a>        ses_bs   <span class="op">=</span> np.std(coef_mat, axis<span class="op">=</span><span class="dv">0</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-124"><a href="#cb13-124"></a>        coef_df_glr <span class="op">=</span> build_table(coefs, <span class="bu">list</span>(ses_bs), feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb13-125"><a href="#cb13-125"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Bootstrap SE computed."</span>)</span>
<span id="cb13-126"><a href="#cb13-126"></a>    <span class="cf">else</span>:</span>
<span id="cb13-127"><a href="#cb13-127"></a>        <span class="co"># As a last resort, output coefficients with NA SE (still a valid table)</span></span>
<span id="cb13-128"><a href="#cb13-128"></a>        coef_df_glr <span class="op">=</span> build_table(coefs, [<span class="bu">float</span>(<span class="st">"nan"</span>)]<span class="op">*</span><span class="bu">len</span>(coefs), feat_names, intercept<span class="op">=</span>glr_model.intercept)</span>
<span id="cb13-129"><a href="#cb13-129"></a></span>
<span id="cb13-130"><a href="#cb13-130"></a><span class="co"># ---------- 3) Order and show ----------</span></span>
<span id="cb13-131"><a href="#cb13-131"></a>coef_df_glr <span class="op">=</span> coef_df_glr.withColumn(<span class="st">"abs_t"</span>, F.<span class="bu">abs</span>(F.col(<span class="st">"t"</span>))).orderBy(F.desc_nulls_last(<span class="st">"abs_t"</span>))</span>
<span id="cb13-132"><a href="#cb13-132"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 25 GLR coefficients by |t| ---"</span>)</span>
<span id="cb13-133"><a href="#cb13-133"></a>coef_df_glr.select(<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>).show(<span class="dv">25</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-134"><a href="#cb13-134"></a></span>
<span id="cb13-135"><a href="#cb13-135"></a><span class="co"># Optional: save</span></span>
<span id="cb13-136"><a href="#cb13-136"></a>coef_df_glr.coalesce(<span class="dv">1</span>).write.mode(<span class="st">"overwrite"</span>).option(<span class="st">"header"</span>, <span class="va">True</span>).csv(<span class="st">"output/glr_coef_table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>✅ GLR Model Summary
AIC: 71511.26
Deviance: 2421727380238.17
Dispersion: 808320220.3732
Null Deviance: 4025242261297.89
Residual DF: 2996
⚠️ GLR analytic SE unavailable.
⚠️ Running GLR bootstrap (B=8).</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>ℹ️ Bootstrap SE computed.

--- Top 25 GLR coefficients by |t| ---
+---------------------------------------------------+-------------------+------------------+-------------------+----------------------+-------------------+-------------------+
|feature                                            |coef               |se                |t                  |p                     |ci_lo              |ci_hi              |
+---------------------------------------------------+-------------------+------------------+-------------------+----------------------+-------------------+-------------------+
|Intercept                                          |68743.77500901464  |NaN               |NaN                |NaN                   |NaN                |NaN                |
|MIN_EDULEVELS_NAME_OHE_Ph.D. or professional degree|-29043.70315924699 |1342.4497631939091|-21.63485290514502 |0.0                   |-31674.904695107052|-26412.50162338693 |
|EMPLOYMENT_TYPE_NAME_OHE_Full-time (&gt; 32 hours)    |6258.360295366977  |454.49521925360943|13.769914468285743 |0.0                   |5367.549665629903  |7149.170925104051  |
|EMPLOYMENT_TYPE_NAME_OHE_Part-time (â‰¤ 32 hours)  |6258.360295366977  |454.49521925360943|13.769914468285743 |0.0                   |5367.549665629903  |7149.170925104051  |
|MIN_EDULEVELS_NAME_OHE_Master's degree             |6799.902817703081  |884.2407010146808 |7.690103848307459  |1.4654943925052066E-14|5066.791043714307  |8533.014591691855  |
|STATE_NAME_OHE_Connecticut                         |-17663.86497159954 |3107.0991000577155|-5.6850021202321575|1.308110375575211E-8  |-23753.779207712665|-11573.950735486418|
|STATE_NAME_OHE_Florida                             |6324.88962145224   |1145.0330526455273|5.523761612679196  |3.31817606724627E-8   |4080.624838267007  |8569.154404637473  |
|STATE_NAME_OHE_Illinois                            |5753.125358216762  |1261.333717155438 |4.561144509155928  |5.087555114524633E-6  |3280.911272592103  |8225.339443841422  |
|STATE_NAME_OHE_Kansas                              |-6695.74692615243  |1513.9528938583474|-4.422691718688915 |9.747878385812925E-6  |-9663.09459811479  |-3728.3992541900693|
|EMPLOYMENT_TYPE_NAME_OHE_Part-time / full-time     |-436.9081242915736 |100.94333146309963|-4.328251484857003 |1.5029779590669534E-5 |-634.7570539592489 |-239.05919462389832|
|MIN_YEARS_EXPERIENCE                               |-18109.684129863697|4268.6014640451995|-4.242533364241927 |2.210106714262139E-5  |-26476.142999392287|-9743.225260335106 |
|STATE_NAME_OHE_New York                            |-5803.566031410265 |2265.805349973469 |-2.5613700803902772|0.010426022853324168  |-10244.544517358265|-1362.5875454622656|
|STATE_NAME_OHE_Alabama                             |-9872.902980979015 |3979.705360045808 |-2.480812544591335 |0.01310832889701441   |-17673.1254866688  |-2072.680475289232 |
|STATE_NAME_OHE_Montana                             |-11072.05254004016 |4659.376454843126 |-2.376294907128928 |0.017487479972304598  |-20204.43039153269 |-1939.6746885476332|
|STATE_NAME_OHE_Minnesota                           |-8101.756874638972 |3659.233168525277 |-2.214058656968311 |0.026824744152868396  |-15273.853884948516|-929.6598643294283 |
|STATE_NAME_OHE_Arizona                             |-5602.609205125748 |2865.2460601445064|-1.955367562687857 |0.050539701884692256  |-11218.49148300898 |13.273072757484442 |
|MAX_YEARS_EXPERIENCE                               |14766.752424825841 |7842.595912946956 |1.8828908933645474 |0.05971515561415819   |-604.7355645501921 |30138.240414201875 |
|MIN_EDULEVELS_NAME_OHE_Associate degree            |1556.2469031492185 |872.038869471156  |1.7846072665235637 |0.07432504193937861   |-152.94928101424716|3265.443087312684  |
|MIN_EDULEVELS_NAME_OHE_High school or GED          |-9930.591776717225 |5701.25180542815  |-1.7418265524182477|0.08153879901529759   |-21105.0453153564  |1243.8617619219494 |
|STATE_NAME_OHE_Arkansas                            |-6263.415624941469 |3667.084593488783 |-1.7080095823430663|0.08763456447389784   |-13450.901428179484|924.0701782965452  |
|STATE_NAME_OHE_Pennsylvania                        |-5819.501636977555 |3427.3976782236673|-1.6979359220414871|0.08951985646358684   |-12537.201086295943|898.1978123408326  |
|STATE_NAME_OHE_Rhode Island                        |-5599.4587120750075|3390.058311193959 |-1.6517293208749881|0.09858974264287057   |-12243.973002015167|1045.0555778651524 |
|STATE_NAME_OHE_Michigan                            |-4349.005564718021 |3027.5110132562504|-1.4364953738154802|0.15086143179646427   |-10282.92715070027 |1584.91602126423   |
|STATE_NAME_OHE_Delaware                            |-7108.936300793899 |5057.751381256516 |-1.4055527377519692|0.15985697868948767   |-17022.12900805667 |2804.2564064688722 |
|STATE_NAME_OHE_North Carolina                      |3764.4294608945975 |2894.8856202916313|1.3003724342364062 |0.19347335300882573   |-1909.5463548769994|9438.405276666195  |
+---------------------------------------------------+-------------------+------------------+-------------------+----------------------+-------------------+-------------------+
only showing top 25 rows</code></pre>
</div>
</div>
<section id="interpretation" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="interpretation"><span class="header-section-number">5.1.1</span> Interpretation</h3>
<p>The Generalized Linear Regression model produced an AIC of approximately 71,000, and the dispersion parameter aligns well with the salary scale. According to bootstrap-based standard errors, employment type and education level have the most significant impact on salary. Specifically, full-time positions and advanced degrees, such as Master’s and Ph.D., considerably increase the predicted salary, while part-time roles and lower education levels lead to a decrease. Geographic factors also play an important role, highlighting the variations in labor markets at the state level. Overall, the model effectively identifies and interprets key relationships while ensuring numerical stability through bootstrapped inference.</p>
</section>
</section>
</section>
<section id="random-forest-regressor" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Random Forest Regressor</h1>
<div id="e6bf7db7" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># ======================================================</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co"># RANDOM FOREST REGRESSOR </span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co">#   - trains on train_nz, evaluates on test_nz</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co">#   - robust feature-name handling for importances</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">#   - caches data to avoid recomputation</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co"># ======================================================</span></span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co"># ----------- Hyperparameters (edit here) -----------</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>NUM_TREES <span class="op">=</span> <span class="dv">200</span>        <span class="co"># 100–500 per instructions</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>MAX_DEPTH <span class="op">=</span> <span class="dv">6</span>          <span class="co"># 4–10 per instructions</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>FEATURE_SUBSET <span class="op">=</span> <span class="st">"sqrt"</span></span>
<span id="cb16-16"><a href="#cb16-16"></a>SUBSAMPLE <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>MAX_BINS <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb16-18"><a href="#cb16-18"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb16-19"><a href="#cb16-19"></a></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="co"># ----------- Safety: ensure train/test exist, cache once -----------</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="cf">try</span>:</span>
<span id="cb16-22"><a href="#cb16-22"></a>    train_nz  <span class="co"># noqa: F401</span></span>
<span id="cb16-23"><a href="#cb16-23"></a>    test_nz   <span class="co"># noqa: F401</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb16-25"><a href="#cb16-25"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the train/test split + feature steps first."</span>)</span>
<span id="cb16-26"><a href="#cb16-26"></a></span>
<span id="cb16-27"><a href="#cb16-27"></a><span class="co"># Cache &amp; materialize to prevent long DAG recomputes</span></span>
<span id="cb16-28"><a href="#cb16-28"></a>train_nz <span class="op">=</span> train_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb16-29"><a href="#cb16-29"></a>test_nz  <span class="op">=</span> test_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb16-30"><a href="#cb16-30"></a>_ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb16-31"><a href="#cb16-31"></a></span>
<span id="cb16-32"><a href="#cb16-32"></a><span class="co"># ----------- Helper: robust feature names -----------</span></span>
<span id="cb16-33"><a href="#cb16-33"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb16-34"><a href="#cb16-34"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb16-35"><a href="#cb16-35"></a>    <span class="cf">try</span>:</span>
<span id="cb16-36"><a href="#cb16-36"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb16-37"><a href="#cb16-37"></a>        names <span class="op">=</span> []</span>
<span id="cb16-38"><a href="#cb16-38"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb16-39"><a href="#cb16-39"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb16-40"><a href="#cb16-40"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb16-41"><a href="#cb16-41"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb16-42"><a href="#cb16-42"></a>        <span class="cf">return</span> names</span>
<span id="cb16-43"><a href="#cb16-43"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb16-44"><a href="#cb16-44"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb16-45"><a href="#cb16-45"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb16-46"><a href="#cb16-46"></a></span>
<span id="cb16-47"><a href="#cb16-47"></a>feature_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb16-48"><a href="#cb16-48"></a></span>
<span id="cb16-49"><a href="#cb16-49"></a><span class="co"># ----------- 1) Train RF -----------</span></span>
<span id="cb16-50"><a href="#cb16-50"></a>rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb16-51"><a href="#cb16-51"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb16-52"><a href="#cb16-52"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb16-53"><a href="#cb16-53"></a>    predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>,</span>
<span id="cb16-54"><a href="#cb16-54"></a>    numTrees<span class="op">=</span>NUM_TREES,</span>
<span id="cb16-55"><a href="#cb16-55"></a>    maxDepth<span class="op">=</span>MAX_DEPTH,</span>
<span id="cb16-56"><a href="#cb16-56"></a>    featureSubsetStrategy<span class="op">=</span>FEATURE_SUBSET,</span>
<span id="cb16-57"><a href="#cb16-57"></a>    subsamplingRate<span class="op">=</span>SUBSAMPLE,</span>
<span id="cb16-58"><a href="#cb16-58"></a>    minInstancesPerNode<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-59"><a href="#cb16-59"></a>    maxBins<span class="op">=</span>MAX_BINS,</span>
<span id="cb16-60"><a href="#cb16-60"></a>    seed<span class="op">=</span>SEED</span>
<span id="cb16-61"><a href="#cb16-61"></a>)</span>
<span id="cb16-62"><a href="#cb16-62"></a>rf_model <span class="op">=</span> rf.fit(train_nz)</span>
<span id="cb16-63"><a href="#cb16-63"></a></span>
<span id="cb16-64"><a href="#cb16-64"></a><span class="co"># ----------- 2) Evaluate on </span><span class="al">TEST</span><span class="co"> -----------</span></span>
<span id="cb16-65"><a href="#cb16-65"></a>pred_rf <span class="op">=</span> rf_model.transform(test_nz).cache()</span>
<span id="cb16-66"><a href="#cb16-66"></a>_ <span class="op">=</span> pred_rf.count()  <span class="co"># materialize once</span></span>
<span id="cb16-67"><a href="#cb16-67"></a></span>
<span id="cb16-68"><a href="#cb16-68"></a>e_rmse <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"rmse"</span>)</span>
<span id="cb16-69"><a href="#cb16-69"></a>e_mae  <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"mae"</span>)</span>
<span id="cb16-70"><a href="#cb16-70"></a>e_r2   <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb16-71"><a href="#cb16-71"></a></span>
<span id="cb16-72"><a href="#cb16-72"></a>rmse_rf <span class="op">=</span> e_rmse.evaluate(pred_rf)</span>
<span id="cb16-73"><a href="#cb16-73"></a>mae_rf  <span class="op">=</span> e_mae.evaluate(pred_rf)</span>
<span id="cb16-74"><a href="#cb16-74"></a>r2_rf   <span class="op">=</span> e_r2.evaluate(pred_rf)</span>
<span id="cb16-75"><a href="#cb16-75"></a></span>
<span id="cb16-76"><a href="#cb16-76"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test RMSE: </span><span class="sc">{</span>rmse_rf<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb16-77"><a href="#cb16-77"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test MAE : </span><span class="sc">{</span>mae_rf<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb16-78"><a href="#cb16-78"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test R²  : </span><span class="sc">{</span>r2_rf<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-79"><a href="#cb16-79"></a></span>
<span id="cb16-80"><a href="#cb16-80"></a><span class="co"># ----------- 3) Feature Importances (robust) -----------</span></span>
<span id="cb16-81"><a href="#cb16-81"></a>imp_vec <span class="op">=</span> rf_model.featureImportances  <span class="co"># SparseVector</span></span>
<span id="cb16-82"><a href="#cb16-82"></a><span class="co"># Convert to dense Python list aligned to the actual vector length</span></span>
<span id="cb16-83"><a href="#cb16-83"></a><span class="cf">try</span>:</span>
<span id="cb16-84"><a href="#cb16-84"></a>    vec_len <span class="op">=</span> pred_rf.selectExpr(<span class="st">"size(features) as n"</span>).first().n</span>
<span id="cb16-85"><a href="#cb16-85"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb16-86"><a href="#cb16-86"></a>    vec_len <span class="op">=</span> <span class="bu">len</span>(feature_names)</span>
<span id="cb16-87"><a href="#cb16-87"></a></span>
<span id="cb16-88"><a href="#cb16-88"></a>importances <span class="op">=</span> [<span class="fl">0.0</span>] <span class="op">*</span> vec_len</span>
<span id="cb16-89"><a href="#cb16-89"></a><span class="cf">for</span> idx, val <span class="kw">in</span> <span class="bu">zip</span>(imp_vec.indices, imp_vec.values):</span>
<span id="cb16-90"><a href="#cb16-90"></a>    <span class="cf">if</span> idx <span class="op">&lt;</span> vec_len:</span>
<span id="cb16-91"><a href="#cb16-91"></a>        importances[<span class="bu">int</span>(idx)] <span class="op">=</span> <span class="bu">float</span>(val)</span>
<span id="cb16-92"><a href="#cb16-92"></a></span>
<span id="cb16-93"><a href="#cb16-93"></a><span class="co"># Align names to the vector length</span></span>
<span id="cb16-94"><a href="#cb16-94"></a><span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">!=</span> vec_len:</span>
<span id="cb16-95"><a href="#cb16-95"></a>    <span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">&gt;</span> vec_len:</span>
<span id="cb16-96"><a href="#cb16-96"></a>        feature_names <span class="op">=</span> feature_names[:vec_len]</span>
<span id="cb16-97"><a href="#cb16-97"></a>    <span class="cf">else</span>:</span>
<span id="cb16-98"><a href="#cb16-98"></a>        feature_names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feature_names), vec_len)]</span>
<span id="cb16-99"><a href="#cb16-99"></a></span>
<span id="cb16-100"><a href="#cb16-100"></a>imp_rows <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(feature_names, importances))</span>
<span id="cb16-101"><a href="#cb16-101"></a>imp_df <span class="op">=</span> spark.createDataFrame(imp_rows, [<span class="st">"feature"</span>, <span class="st">"rf_importance"</span>]).orderBy(F.desc(<span class="st">"rf_importance"</span>))</span>
<span id="cb16-102"><a href="#cb16-102"></a></span>
<span id="cb16-103"><a href="#cb16-103"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 20 Random Forest feature importances ---"</span>)</span>
<span id="cb16-104"><a href="#cb16-104"></a>imp_df.show(<span class="dv">20</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-105"><a href="#cb16-105"></a></span>
<span id="cb16-106"><a href="#cb16-106"></a><span class="co"># Optional: save importances</span></span>
<span id="cb16-107"><a href="#cb16-107"></a><span class="co"># imp_df.coalesce(1).write.mode("overwrite").option("header", True).csv("output/rf_feature_importances")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>🌲 RF Test RMSE: 28,794.11
🌲 RF Test MAE : 21,751.86
🌲 RF Test R²  : 0.3815

--- Top 20 Random Forest feature importances ---
+------------------------------------------------------+---------------------+
|feature                                               |rf_importance        |
+------------------------------------------------------+---------------------+
|EMPLOYMENT_TYPE_NAME_OHE_Full-time (&gt; 32 hours)       |0.32531750870616066  |
|EMPLOYMENT_TYPE_NAME_OHE_Part-time (â‰¤ 32 hours)     |0.2605090618386641   |
|EMPLOYMENT_TYPE_NAME_OHE_Part-time / full-time        |0.22125697278172574  |
|MIN_EDULEVELS_NAME_OHE_Ph.D. or professional degree   |0.062097740142455636 |
|MIN_EDULEVELS_NAME_OHE_Master's degree                |0.015920116072243896 |
|MIN_YEARS_EXPERIENCE                                  |0.01586186633817772  |
|STATE_NAME_OHE_Connecticut                            |0.011374735045655305 |
|MIN_EDULEVELS_NAME_OHE_Associate degree               |0.01089724894728216  |
|MAX_YEARS_EXPERIENCE                                  |0.0071909392938986376|
|STATE_NAME_OHE_New York                               |0.005416450050560545 |
|STATE_NAME_OHE_Florida                                |0.00519205120123702  |
|STATE_NAME_OHE_Virginia                               |0.00485191745133132  |
|STATE_NAME_OHE_Illinois                               |0.004187784773755273 |
|STATE_NAME_OHE_Texas                                  |0.004033979748221235 |
|STATE_NAME_OHE_Louisiana                              |0.0030225561831848   |
|STATE_NAME_OHE_Washington, D.C. (District of Columbia)|0.0028680224967016477|
|STATE_NAME_OHE_New Jersey                             |0.0027521843917058552|
|STATE_NAME_OHE_Minnesota                              |0.002273229602631358 |
|STATE_NAME_OHE_California                             |0.0020320506197399973|
|STATE_NAME_OHE_Tennessee                              |0.0019061576775341769|
+------------------------------------------------------+---------------------+
only showing top 20 rows</code></pre>
</div>
</div>
<section id="feature-importance-plot" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="feature-importance-plot"><span class="header-section-number">6.1</span> Feature Importance Plot</h2>
<div id="0c93346e" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># ======================================================</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co"># Random Forest Feature Importance — Interactive + PNG</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">#  - Robust vector length detection (Vector UDT safe)</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co">#  - Interactive Plotly bar chart</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co">#  - Static PNG saved to ./_output/rf_feature_importance.png</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co"># ======================================================</span></span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="im">from</span> pyspark.ml.functions <span class="im">import</span> vector_to_array</span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="im">import</span> os</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co"># ---------- 0) Safety: ensure train/test exist ----------</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="cf">try</span>:</span>
<span id="cb18-15"><a href="#cb18-15"></a>    _ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb18-17"><a href="#cb18-17"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the RF training cell first."</span>)</span>
<span id="cb18-18"><a href="#cb18-18"></a></span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="co"># ---------- 1) Get (or fit) RF model ----------</span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="cf">try</span>:</span>
<span id="cb18-21"><a href="#cb18-21"></a>    rf_model  <span class="co"># reuse if already trained</span></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb18-23"><a href="#cb18-23"></a>    rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb18-24"><a href="#cb18-24"></a>        featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>,</span>
<span id="cb18-25"><a href="#cb18-25"></a>        numTrees<span class="op">=</span><span class="dv">200</span>, maxDepth<span class="op">=</span><span class="dv">6</span>, featureSubsetStrategy<span class="op">=</span><span class="st">"sqrt"</span>,</span>
<span id="cb18-26"><a href="#cb18-26"></a>        subsamplingRate<span class="op">=</span><span class="fl">0.8</span>, minInstancesPerNode<span class="op">=</span><span class="dv">2</span>, maxBins<span class="op">=</span><span class="dv">64</span>, seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>    )</span>
<span id="cb18-28"><a href="#cb18-28"></a>    rf_model <span class="op">=</span> rf.fit(train_nz)</span>
<span id="cb18-29"><a href="#cb18-29"></a></span>
<span id="cb18-30"><a href="#cb18-30"></a><span class="co"># ---------- 2) Robust feature-name extraction ----------</span></span>
<span id="cb18-31"><a href="#cb18-31"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb18-32"><a href="#cb18-32"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb18-33"><a href="#cb18-33"></a>    <span class="cf">try</span>:</span>
<span id="cb18-34"><a href="#cb18-34"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb18-35"><a href="#cb18-35"></a>        names <span class="op">=</span> []</span>
<span id="cb18-36"><a href="#cb18-36"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb18-37"><a href="#cb18-37"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb18-38"><a href="#cb18-38"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb18-39"><a href="#cb18-39"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb18-40"><a href="#cb18-40"></a>        <span class="cf">return</span> names</span>
<span id="cb18-41"><a href="#cb18-41"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb18-42"><a href="#cb18-42"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb18-43"><a href="#cb18-43"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb18-44"><a href="#cb18-44"></a></span>
<span id="cb18-45"><a href="#cb18-45"></a><span class="cf">try</span>:</span>
<span id="cb18-46"><a href="#cb18-46"></a>    feature_names <span class="op">=</span> feat_names  <span class="co"># reuse from earlier if available</span></span>
<span id="cb18-47"><a href="#cb18-47"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb18-48"><a href="#cb18-48"></a>    feature_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb18-49"><a href="#cb18-49"></a></span>
<span id="cb18-50"><a href="#cb18-50"></a><span class="co"># ---------- 3) Vector length (no AnalysisException) ----------</span></span>
<span id="cb18-51"><a href="#cb18-51"></a><span class="cf">try</span>:</span>
<span id="cb18-52"><a href="#cb18-52"></a>    <span class="co"># Convert Vector UDT -&gt; array, then size()</span></span>
<span id="cb18-53"><a href="#cb18-53"></a>    vec_len <span class="op">=</span> train_nz.select(</span>
<span id="cb18-54"><a href="#cb18-54"></a>        F.size(vector_to_array(F.col(<span class="st">"features"</span>))).alias(<span class="st">"n"</span>)</span>
<span id="cb18-55"><a href="#cb18-55"></a>    ).first().n</span>
<span id="cb18-56"><a href="#cb18-56"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb18-57"><a href="#cb18-57"></a>    <span class="co"># Fallback to the trained model’s importances size</span></span>
<span id="cb18-58"><a href="#cb18-58"></a>    vec_len <span class="op">=</span> <span class="bu">int</span>(<span class="bu">getattr</span>(rf_model.featureImportances, <span class="st">"size"</span>, <span class="bu">len</span>(feature_names)))</span>
<span id="cb18-59"><a href="#cb18-59"></a></span>
<span id="cb18-60"><a href="#cb18-60"></a><span class="co"># Align names to actual vector size</span></span>
<span id="cb18-61"><a href="#cb18-61"></a><span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">!=</span> vec_len:</span>
<span id="cb18-62"><a href="#cb18-62"></a>    <span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">&gt;</span> vec_len:</span>
<span id="cb18-63"><a href="#cb18-63"></a>        feature_names <span class="op">=</span> feature_names[:vec_len]</span>
<span id="cb18-64"><a href="#cb18-64"></a>    <span class="cf">else</span>:</span>
<span id="cb18-65"><a href="#cb18-65"></a>        feature_names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feature_names), vec_len)]</span>
<span id="cb18-66"><a href="#cb18-66"></a></span>
<span id="cb18-67"><a href="#cb18-67"></a><span class="co"># ---------- 4) Build importances table ----------</span></span>
<span id="cb18-68"><a href="#cb18-68"></a>imp_vec <span class="op">=</span> rf_model.featureImportances  <span class="co"># SparseVector</span></span>
<span id="cb18-69"><a href="#cb18-69"></a>importances <span class="op">=</span> [<span class="fl">0.0</span>] <span class="op">*</span> vec_len</span>
<span id="cb18-70"><a href="#cb18-70"></a><span class="cf">for</span> idx, val <span class="kw">in</span> <span class="bu">zip</span>(imp_vec.indices, imp_vec.values):</span>
<span id="cb18-71"><a href="#cb18-71"></a>    <span class="cf">if</span> <span class="bu">int</span>(idx) <span class="op">&lt;</span> vec_len:</span>
<span id="cb18-72"><a href="#cb18-72"></a>        importances[<span class="bu">int</span>(idx)] <span class="op">=</span> <span class="bu">float</span>(val)</span>
<span id="cb18-73"><a href="#cb18-73"></a></span>
<span id="cb18-74"><a href="#cb18-74"></a>imp_rows <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(feature_names, importances))</span>
<span id="cb18-75"><a href="#cb18-75"></a>imp_df <span class="op">=</span> spark.createDataFrame(imp_rows, [<span class="st">"feature"</span>, <span class="st">"rf_importance"</span>]) <span class="op">\</span></span>
<span id="cb18-76"><a href="#cb18-76"></a>              .orderBy(F.desc(<span class="st">"rf_importance"</span>))</span>
<span id="cb18-77"><a href="#cb18-77"></a></span>
<span id="cb18-78"><a href="#cb18-78"></a>topN <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb18-79"><a href="#cb18-79"></a>top_df <span class="op">=</span> imp_df.limit(topN)</span>
<span id="cb18-80"><a href="#cb18-80"></a>top_pd <span class="op">=</span> top_df.toPandas()</span>
<span id="cb18-81"><a href="#cb18-81"></a></span>
<span id="cb18-82"><a href="#cb18-82"></a><span class="co"># ---------- 5) Interactive bar (Plotly) ----------</span></span>
<span id="cb18-83"><a href="#cb18-83"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb18-84"><a href="#cb18-84"></a></span>
<span id="cb18-85"><a href="#cb18-85"></a>fig <span class="op">=</span> px.bar(</span>
<span id="cb18-86"><a href="#cb18-86"></a>    top_pd.sort_values(<span class="st">"rf_importance"</span>, ascending<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb18-87"><a href="#cb18-87"></a>    x<span class="op">=</span><span class="st">"rf_importance"</span>, y<span class="op">=</span><span class="st">"feature"</span>,</span>
<span id="cb18-88"><a href="#cb18-88"></a>    orientation<span class="op">=</span><span class="st">"h"</span>,</span>
<span id="cb18-89"><a href="#cb18-89"></a>    title<span class="op">=</span><span class="ss">f"Top </span><span class="sc">{</span>topN<span class="sc">}</span><span class="ss"> Random Forest Feature Importances"</span>,</span>
<span id="cb18-90"><a href="#cb18-90"></a>    labels<span class="op">=</span>{<span class="st">"rf_importance"</span>: <span class="st">"Importance"</span>, <span class="st">"feature"</span>: <span class="st">"Feature"</span>},</span>
<span id="cb18-91"><a href="#cb18-91"></a>)</span>
<span id="cb18-92"><a href="#cb18-92"></a>fig.update_layout(yaxis<span class="op">=</span><span class="bu">dict</span>(dtick<span class="op">=</span><span class="dv">1</span>), margin<span class="op">=</span><span class="bu">dict</span>(l<span class="op">=</span><span class="dv">10</span>, r<span class="op">=</span><span class="dv">10</span>, t<span class="op">=</span><span class="dv">40</span>, b<span class="op">=</span><span class="dv">10</span>))</span>
<span id="cb18-93"><a href="#cb18-93"></a>fig.show()</span>
<span id="cb18-94"><a href="#cb18-94"></a></span>
<span id="cb18-95"><a href="#cb18-95"></a><span class="co"># ---------- 6) Save static PNG to ./_output/ ----------</span></span>
<span id="cb18-96"><a href="#cb18-96"></a><span class="co"># Use matplotlib (and seaborn if available) to avoid Plotly/kaleido dependency.</span></span>
<span id="cb18-97"><a href="#cb18-97"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-98"><a href="#cb18-98"></a><span class="cf">try</span>:</span>
<span id="cb18-99"><a href="#cb18-99"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb18-100"><a href="#cb18-100"></a>    use_sns <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-101"><a href="#cb18-101"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb18-102"><a href="#cb18-102"></a>    use_sns <span class="op">=</span> <span class="va">False</span></span>
<span id="cb18-103"><a href="#cb18-103"></a></span>
<span id="cb18-104"><a href="#cb18-104"></a>os.makedirs(<span class="st">"_output"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-105"><a href="#cb18-105"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb18-106"><a href="#cb18-106"></a>plot_data <span class="op">=</span> top_pd.sort_values(<span class="st">"rf_importance"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-107"><a href="#cb18-107"></a></span>
<span id="cb18-108"><a href="#cb18-108"></a><span class="cf">if</span> use_sns:</span>
<span id="cb18-109"><a href="#cb18-109"></a>    ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>plot_data, x<span class="op">=</span><span class="st">"rf_importance"</span>, y<span class="op">=</span><span class="st">"feature"</span>)</span>
<span id="cb18-110"><a href="#cb18-110"></a><span class="cf">else</span>:</span>
<span id="cb18-111"><a href="#cb18-111"></a>    ax <span class="op">=</span> plt.barh(plot_data[<span class="st">"feature"</span>], plot_data[<span class="st">"rf_importance"</span>])</span>
<span id="cb18-112"><a href="#cb18-112"></a></span>
<span id="cb18-113"><a href="#cb18-113"></a>plt.xlabel(<span class="st">"Importance"</span>)</span>
<span id="cb18-114"><a href="#cb18-114"></a>plt.ylabel(<span class="st">"Feature"</span>)</span>
<span id="cb18-115"><a href="#cb18-115"></a>plt.title(<span class="ss">f"Top </span><span class="sc">{</span>topN<span class="sc">}</span><span class="ss"> Random Forest Feature Importances"</span>)</span>
<span id="cb18-116"><a href="#cb18-116"></a>plt.tight_layout()</span>
<span id="cb18-117"><a href="#cb18-117"></a>plt.savefig(<span class="st">"_output/rf_feature_importance.png"</span>, dpi<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb18-118"><a href="#cb18-118"></a>plt.close()</span>
<span id="cb18-119"><a href="#cb18-119"></a></span>
<span id="cb18-120"><a href="#cb18-120"></a><span class="bu">print</span>(<span class="st">"✅ Saved static plot to: _output/rf_feature_importance.png"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.1.1.min.js" integrity="sha256-HUEFyfiTnZJxCxur99FjbKYTvKSzwDaD3/x5TqHpFu4=" crossorigin="anonymous"></script>                <div id="318b602f-12b4-45f6-a698-fda3196fed3b" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("318b602f-12b4-45f6-a698-fda3196fed3b")) {                    Plotly.newPlot(                        "318b602f-12b4-45f6-a698-fda3196fed3b",                        [{"hovertemplate":"Importance=%{x}\u003cbr\u003eFeature=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","orientation":"h","showlegend":false,"textposition":"auto","x":{"dtype":"f8","bdata":"YL89PY8vdj\u002fDXYQRP3R9P7xzwv5LUYY\u002frY0sGKNLhz9zOLTUFz6QPyrng+dcTZA\u002fI3wiZkbLrz9AAw4DJlLMPzUoOjMurNA\u002fzWIthwDS1D8="},"xaxis":"x","y":["STATE_NAME_OHE_New York","MAX_YEARS_EXPERIENCE","MIN_EDULEVELS_NAME_OHE_Associate degree","STATE_NAME_OHE_Connecticut","MIN_YEARS_EXPERIENCE","MIN_EDULEVELS_NAME_OHE_Master's degree","MIN_EDULEVELS_NAME_OHE_Ph.D. or professional degree","EMPLOYMENT_TYPE_NAME_OHE_Part-time \u002f full-time","EMPLOYMENT_TYPE_NAME_OHE_Part-time (\u00e2\u2030\u00a4 32 hours)","EMPLOYMENT_TYPE_NAME_OHE_Full-time (\u003e 32 hours)"],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"Importance"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"Feature"},"dtick":1},"legend":{"tracegroupgap":0},"title":{"text":"Top 10 Random Forest Feature Importances"},"barmode":"relative","margin":{"l":10,"r":10,"t":40,"b":10}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('318b602f-12b4-45f6-a698-fda3196fed3b');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };            </script>        </div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Saved static plot to: _output/rf_feature_importance.png</code></pre>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="an">title:</span><span class="co"> "Assignment 04 — Lab 04 Machine Learning on Scale"</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="an">subtitle:</span><span class="co"> "Causal and Predictive Analytics in Spark"</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="an">author:</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co">  - name: "Othmane Elouardi"</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co">    affiliations:</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co">      - id: bu</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co">        name: "Boston University"</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co">        city: "Boston"</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co">        state: "MA"</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="an">date:</span><span class="co"> "2025-10-08"</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="an">format:</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="co">  html:</span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="co">    theme:</span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="co">      light: lux</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="co">      dark: slate</span></span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="co">    toc: true</span></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="co">    toc-location: right</span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="co">    smooth-scroll: true</span></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="co">    code-fold: true</span></span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="co">    code-tools: true</span></span>
<span id="cb20-24"><a href="#cb20-24"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb20-25"><a href="#cb20-25"></a><span class="co">    highlight-style: a11y</span></span>
<span id="cb20-26"><a href="#cb20-26"></a><span class="co">    page-layout: article</span></span>
<span id="cb20-27"><a href="#cb20-27"></a><span class="co">    css: styles.css</span></span>
<span id="cb20-28"><a href="#cb20-28"></a><span class="co">    grid:</span></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="co">      body-width: 900px</span></span>
<span id="cb20-30"><a href="#cb20-30"></a><span class="co">      margin-width: 280px</span></span>
<span id="cb20-31"><a href="#cb20-31"></a><span class="an">execute:</span></span>
<span id="cb20-32"><a href="#cb20-32"></a><span class="co">  echo: true</span></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="co">  warning: false</span></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="co">  error: false</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="co">  freeze: auto</span></span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="an">jupyter:</span><span class="co"> env</span></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="co">---</span></span>
<span id="cb20-38"><a href="#cb20-38"></a></span>
<span id="cb20-39"><a href="#cb20-39"></a></span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="fu"># Introduction</span></span>
<span id="cb20-41"><a href="#cb20-41"></a>PySpark is applied to large-scale employment data from the Lightcast Job Postings dataset to develop and evaluate salary prediction models. The workflow involves engineering key features from structured columns, training a Linear Regression model, and assessing performance using RMSE and R² metrics. Visual diagnostic plots are generated to interpret model accuracy and residual patterns. The final analysis is documented, version-controlled, and submitted via GitHub, demonstrating end-to-end data processing and predictive modeling on a distributed computing platform.</span>
<span id="cb20-42"><a href="#cb20-42"></a></span>
<span id="cb20-43"><a href="#cb20-43"></a><span class="fu"># Load the Dataset</span></span>
<span id="cb20-44"><a href="#cb20-44"></a> **PySpark** is used to load the *Lightcast Job Postings* dataset into a Spark DataFrame.  </span>
<span id="cb20-45"><a href="#cb20-45"></a>This approach enables us to efficiently handle large datasets within the EC2 environment before proceeding with feature engineering and regression analysis.</span>
<span id="cb20-46"><a href="#cb20-46"></a></span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="in">```{python}</span></span>
<span id="cb20-50"><a href="#cb20-50"></a><span class="co"># Load the Lightcast dataset with PySpark</span></span>
<span id="cb20-51"><a href="#cb20-51"></a></span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb20-53"><a href="#cb20-53"></a><span class="im">import</span> os</span>
<span id="cb20-54"><a href="#cb20-54"></a></span>
<span id="cb20-55"><a href="#cb20-55"></a><span class="co"># Initialize Spark session </span></span>
<span id="cb20-56"><a href="#cb20-56"></a>spark <span class="op">=</span> (</span>
<span id="cb20-57"><a href="#cb20-57"></a>    SparkSession.builder</span>
<span id="cb20-58"><a href="#cb20-58"></a>    .appName(<span class="st">"LightcastData"</span>)</span>
<span id="cb20-59"><a href="#cb20-59"></a>    .config(<span class="st">"spark.driver.memory"</span>, <span class="st">"1g"</span>)</span>
<span id="cb20-60"><a href="#cb20-60"></a>    .getOrCreate()</span>
<span id="cb20-61"><a href="#cb20-61"></a>)</span>
<span id="cb20-62"><a href="#cb20-62"></a></span>
<span id="cb20-63"><a href="#cb20-63"></a><span class="co"># Define dataset path</span></span>
<span id="cb20-64"><a href="#cb20-64"></a>csv_path <span class="op">=</span> <span class="st">"data/lightcast_job_postings.csv"</span></span>
<span id="cb20-65"><a href="#cb20-65"></a></span>
<span id="cb20-66"><a href="#cb20-66"></a><span class="co"># Check path validity</span></span>
<span id="cb20-67"><a href="#cb20-67"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(csv_path):</span>
<span id="cb20-68"><a href="#cb20-68"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"❌ Could not find </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">. Please ensure the file exists in the data/ folder."</span>)</span>
<span id="cb20-69"><a href="#cb20-69"></a></span>
<span id="cb20-70"><a href="#cb20-70"></a><span class="co"># Load dataset</span></span>
<span id="cb20-71"><a href="#cb20-71"></a>df <span class="op">=</span> (</span>
<span id="cb20-72"><a href="#cb20-72"></a>    spark.read</span>
<span id="cb20-73"><a href="#cb20-73"></a>    .option(<span class="st">"header"</span>, <span class="st">"true"</span>)       <span class="co"># First row as headers</span></span>
<span id="cb20-74"><a href="#cb20-74"></a>    .option(<span class="st">"inferSchema"</span>, <span class="st">"true"</span>)  <span class="co"># Auto-detect data types</span></span>
<span id="cb20-75"><a href="#cb20-75"></a>    .option(<span class="st">"multiLine"</span>, <span class="st">"true"</span>)    <span class="co"># Handle multi-line text fields</span></span>
<span id="cb20-76"><a href="#cb20-76"></a>    .option(<span class="st">"escape"</span>, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>)         <span class="co"># Handle embedded quotes</span></span>
<span id="cb20-77"><a href="#cb20-77"></a>    .csv(csv_path)</span>
<span id="cb20-78"><a href="#cb20-78"></a>)</span>
<span id="cb20-79"><a href="#cb20-79"></a></span>
<span id="cb20-80"><a href="#cb20-80"></a><span class="co"># Confirm load success</span></span>
<span id="cb20-81"><a href="#cb20-81"></a><span class="bu">print</span>(<span class="st">"✅ Dataset successfully loaded!"</span>)</span>
<span id="cb20-82"><a href="#cb20-82"></a>df.printSchema()</span>
<span id="cb20-83"><a href="#cb20-83"></a>df.show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-84"><a href="#cb20-84"></a><span class="in">```</span></span>
<span id="cb20-85"><a href="#cb20-85"></a></span>
<span id="cb20-86"><a href="#cb20-86"></a></span>
<span id="cb20-87"><a href="#cb20-87"></a></span>
<span id="cb20-88"><a href="#cb20-88"></a><span class="fu"># Feature Engineering</span></span>
<span id="cb20-89"><a href="#cb20-89"></a></span>
<span id="cb20-90"><a href="#cb20-90"></a>Feature engineering is a crucial step in preparing the dataset for machine learning.  </span>
<span id="cb20-91"><a href="#cb20-91"></a>This section cleans the data, encodes categorical variables, and constructs feature vectors for model training.</span>
<span id="cb20-92"><a href="#cb20-92"></a></span>
<span id="cb20-95"><a href="#cb20-95"></a><span class="in">```{python}</span></span>
<span id="cb20-96"><a href="#cb20-96"></a><span class="co"># ======================================================</span></span>
<span id="cb20-97"><a href="#cb20-97"></a><span class="co"># FEATURE ENGINEERING</span></span>
<span id="cb20-98"><a href="#cb20-98"></a><span class="co"># ======================================================</span></span>
<span id="cb20-99"><a href="#cb20-99"></a></span>
<span id="cb20-100"><a href="#cb20-100"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb20-101"><a href="#cb20-101"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer, OneHotEncoder, VectorAssembler</span>
<span id="cb20-102"><a href="#cb20-102"></a></span>
<span id="cb20-103"><a href="#cb20-103"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-104"><a href="#cb20-104"></a><span class="co"># 1. Drop rows with missing target or key features</span></span>
<span id="cb20-105"><a href="#cb20-105"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-106"><a href="#cb20-106"></a>df_clean <span class="op">=</span> df.dropna(subset<span class="op">=</span>[</span>
<span id="cb20-107"><a href="#cb20-107"></a>    <span class="st">"SALARY"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>, <span class="st">"MAX_YEARS_EXPERIENCE"</span>,</span>
<span id="cb20-108"><a href="#cb20-108"></a>    <span class="st">"EMPLOYMENT_TYPE_NAME"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS_NAME"</span></span>
<span id="cb20-109"><a href="#cb20-109"></a>])</span>
<span id="cb20-110"><a href="#cb20-110"></a></span>
<span id="cb20-111"><a href="#cb20-111"></a><span class="bu">print</span>(<span class="ss">f"✅ Rows after dropping nulls: </span><span class="sc">{</span>df_clean<span class="sc">.</span>count()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb20-112"><a href="#cb20-112"></a></span>
<span id="cb20-113"><a href="#cb20-113"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-114"><a href="#cb20-114"></a><span class="co"># 2. Create new feature: MIN_YEARS_EXPERIENCE_SQ</span></span>
<span id="cb20-115"><a href="#cb20-115"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-116"><a href="#cb20-116"></a>df_clean <span class="op">=</span> df_clean.withColumn(</span>
<span id="cb20-117"><a href="#cb20-117"></a>    <span class="st">"MIN_YEARS_EXPERIENCE_SQ"</span>,</span>
<span id="cb20-118"><a href="#cb20-118"></a>    F.<span class="bu">pow</span>(F.col(<span class="st">"MIN_YEARS_EXPERIENCE"</span>), <span class="dv">2</span>)</span>
<span id="cb20-119"><a href="#cb20-119"></a>)</span>
<span id="cb20-120"><a href="#cb20-120"></a></span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-122"><a href="#cb20-122"></a><span class="co"># 3. Encode categorical variables</span></span>
<span id="cb20-123"><a href="#cb20-123"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-124"><a href="#cb20-124"></a>cat_cols <span class="op">=</span> [<span class="st">"EMPLOYMENT_TYPE_NAME"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS_NAME"</span>]</span>
<span id="cb20-125"><a href="#cb20-125"></a></span>
<span id="cb20-126"><a href="#cb20-126"></a>indexers <span class="op">=</span> [</span>
<span id="cb20-127"><a href="#cb20-127"></a>    StringIndexer(inputCol<span class="op">=</span>c, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_IDX"</span>, handleInvalid<span class="op">=</span><span class="st">"keep"</span>)</span>
<span id="cb20-128"><a href="#cb20-128"></a>    <span class="cf">for</span> c <span class="kw">in</span> cat_cols</span>
<span id="cb20-129"><a href="#cb20-129"></a>]</span>
<span id="cb20-130"><a href="#cb20-130"></a></span>
<span id="cb20-131"><a href="#cb20-131"></a>encoders <span class="op">=</span> [</span>
<span id="cb20-132"><a href="#cb20-132"></a>    OneHotEncoder(inputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_IDX"</span>, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_OHE"</span>)</span>
<span id="cb20-133"><a href="#cb20-133"></a>    <span class="cf">for</span> c <span class="kw">in</span> cat_cols</span>
<span id="cb20-134"><a href="#cb20-134"></a>]</span>
<span id="cb20-135"><a href="#cb20-135"></a></span>
<span id="cb20-136"><a href="#cb20-136"></a><span class="co"># Apply indexers sequentially</span></span>
<span id="cb20-137"><a href="#cb20-137"></a><span class="cf">for</span> idx <span class="kw">in</span> indexers:</span>
<span id="cb20-138"><a href="#cb20-138"></a>    df_clean <span class="op">=</span> idx.fit(df_clean).transform(df_clean)</span>
<span id="cb20-139"><a href="#cb20-139"></a></span>
<span id="cb20-140"><a href="#cb20-140"></a><span class="co"># Apply one-hot encoders sequentially</span></span>
<span id="cb20-141"><a href="#cb20-141"></a><span class="cf">for</span> enc <span class="kw">in</span> encoders:</span>
<span id="cb20-142"><a href="#cb20-142"></a>    df_clean <span class="op">=</span> enc.fit(df_clean).transform(df_clean)</span>
<span id="cb20-143"><a href="#cb20-143"></a></span>
<span id="cb20-144"><a href="#cb20-144"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-145"><a href="#cb20-145"></a><span class="co"># 4. Assemble final features</span></span>
<span id="cb20-146"><a href="#cb20-146"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-147"><a href="#cb20-147"></a>numeric_cols <span class="op">=</span> [</span>
<span id="cb20-148"><a href="#cb20-148"></a>    <span class="st">"MIN_YEARS_EXPERIENCE"</span>, </span>
<span id="cb20-149"><a href="#cb20-149"></a>    <span class="st">"MAX_YEARS_EXPERIENCE"</span>, </span>
<span id="cb20-150"><a href="#cb20-150"></a>    <span class="st">"MIN_YEARS_EXPERIENCE_SQ"</span></span>
<span id="cb20-151"><a href="#cb20-151"></a>]</span>
<span id="cb20-152"><a href="#cb20-152"></a></span>
<span id="cb20-153"><a href="#cb20-153"></a>ohe_cols <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_OHE"</span> <span class="cf">for</span> c <span class="kw">in</span> cat_cols]</span>
<span id="cb20-154"><a href="#cb20-154"></a></span>
<span id="cb20-155"><a href="#cb20-155"></a>assembler <span class="op">=</span> VectorAssembler(</span>
<span id="cb20-156"><a href="#cb20-156"></a>    inputCols<span class="op">=</span>numeric_cols <span class="op">+</span> ohe_cols,</span>
<span id="cb20-157"><a href="#cb20-157"></a>    outputCol<span class="op">=</span><span class="st">"features"</span></span>
<span id="cb20-158"><a href="#cb20-158"></a>)</span>
<span id="cb20-159"><a href="#cb20-159"></a></span>
<span id="cb20-160"><a href="#cb20-160"></a>df_fe <span class="op">=</span> assembler.transform(df_clean)</span>
<span id="cb20-161"><a href="#cb20-161"></a></span>
<span id="cb20-162"><a href="#cb20-162"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-163"><a href="#cb20-163"></a><span class="co"># 5. Show sample of processed data</span></span>
<span id="cb20-164"><a href="#cb20-164"></a><span class="co"># ------------------------------------------------------</span></span>
<span id="cb20-165"><a href="#cb20-165"></a>df_fe.select(</span>
<span id="cb20-166"><a href="#cb20-166"></a>    <span class="st">"SALARY"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"features"</span></span>
<span id="cb20-167"><a href="#cb20-167"></a>).show(<span class="dv">5</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-168"><a href="#cb20-168"></a></span>
<span id="cb20-169"><a href="#cb20-169"></a><span class="in">```</span></span>
<span id="cb20-170"><a href="#cb20-170"></a></span>
<span id="cb20-171"><a href="#cb20-171"></a><span class="fu"># Train/Test Split</span></span>
<span id="cb20-172"><a href="#cb20-172"></a></span>
<span id="cb20-173"><a href="#cb20-173"></a>Splitting the data into training and testing sets ensures that the model is evaluated on unseen data, which helps measure its generalization performance.  </span>
<span id="cb20-174"><a href="#cb20-174"></a>Here an **80/20 split** is used, a common practice that provides a large enough training set while reserving sufficient data for evaluation.</span>
<span id="cb20-175"><a href="#cb20-175"></a></span>
<span id="cb20-178"><a href="#cb20-178"></a><span class="in">```{python}</span></span>
<span id="cb20-179"><a href="#cb20-179"></a><span class="co"># ======================================================</span></span>
<span id="cb20-180"><a href="#cb20-180"></a><span class="co"># TRAIN / </span><span class="al">TEST</span><span class="co"> SPLIT</span></span>
<span id="cb20-181"><a href="#cb20-181"></a><span class="co"># ======================================================</span></span>
<span id="cb20-182"><a href="#cb20-182"></a></span>
<span id="cb20-183"><a href="#cb20-183"></a><span class="co"># Perform random split with reproducibility</span></span>
<span id="cb20-184"><a href="#cb20-184"></a>train_df, test_df <span class="op">=</span> df_fe.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb20-185"><a href="#cb20-185"></a></span>
<span id="cb20-186"><a href="#cb20-186"></a><span class="co"># Display record counts for each subset</span></span>
<span id="cb20-187"><a href="#cb20-187"></a>train_count <span class="op">=</span> train_df.count()</span>
<span id="cb20-188"><a href="#cb20-188"></a>test_count <span class="op">=</span> test_df.count()</span>
<span id="cb20-189"><a href="#cb20-189"></a>total_count <span class="op">=</span> df_fe.count()</span>
<span id="cb20-190"><a href="#cb20-190"></a></span>
<span id="cb20-191"><a href="#cb20-191"></a><span class="bu">print</span>(<span class="ss">f"✅ Total records: </span><span class="sc">{</span>total_count<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb20-192"><a href="#cb20-192"></a><span class="bu">print</span>(<span class="ss">f"🧠 Training set: </span><span class="sc">{</span>train_count<span class="sc">:,}</span><span class="ss"> rows (</span><span class="sc">{</span>train_count<span class="op">/</span>total_count<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb20-193"><a href="#cb20-193"></a><span class="bu">print</span>(<span class="ss">f"🧾 Testing set:  </span><span class="sc">{</span>test_count<span class="sc">:,}</span><span class="ss"> rows (</span><span class="sc">{</span>test_count<span class="op">/</span>total_count<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb20-194"><a href="#cb20-194"></a></span>
<span id="cb20-195"><a href="#cb20-195"></a><span class="in">```</span></span>
<span id="cb20-196"><a href="#cb20-196"></a></span>
<span id="cb20-197"><a href="#cb20-197"></a></span>
<span id="cb20-198"><a href="#cb20-198"></a></span>
<span id="cb20-199"><a href="#cb20-199"></a></span>
<span id="cb20-200"><a href="#cb20-200"></a><span class="fu"># Linear Regression</span></span>
<span id="cb20-201"><a href="#cb20-201"></a></span>
<span id="cb20-202"><a href="#cb20-202"></a>Zero-variance features to restore full rank, train a Linear Regression model for</span>
<span id="cb20-203"><a href="#cb20-203"></a>prediction, and assemble a coefficient table with **SE, t, p, 95% CI** using LR/GLR or a</span>
<span id="cb20-204"><a href="#cb20-204"></a>bootstrap fallback when analytic standard errors are unavailable.</span>
<span id="cb20-205"><a href="#cb20-205"></a></span>
<span id="cb20-208"><a href="#cb20-208"></a><span class="in">```{python}</span></span>
<span id="cb20-209"><a href="#cb20-209"></a><span class="co"># ======================================================</span></span>
<span id="cb20-210"><a href="#cb20-210"></a><span class="co"># LINEAR REGRESSION with robust &amp; fast inference</span></span>
<span id="cb20-211"><a href="#cb20-211"></a><span class="co">#   - zero-variance pruning (Summarizer.variance)</span></span>
<span id="cb20-212"><a href="#cb20-212"></a><span class="co">#   - LR (L-BFGS + tiny ridge) metrics on test set</span></span>
<span id="cb20-213"><a href="#cb20-213"></a><span class="co">#   - LR -&gt; GLR -&gt; Bootstrap fallback for SE/t/p</span></span>
<span id="cb20-214"><a href="#cb20-214"></a><span class="co"># ======================================================</span></span>
<span id="cb20-215"><a href="#cb20-215"></a></span>
<span id="cb20-216"><a href="#cb20-216"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression, GeneralizedLinearRegression</span>
<span id="cb20-217"><a href="#cb20-217"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorSlicer</span>
<span id="cb20-218"><a href="#cb20-218"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb20-219"><a href="#cb20-219"></a><span class="im">from</span> pyspark.ml.stat <span class="im">import</span> Summarizer</span>
<span id="cb20-220"><a href="#cb20-220"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb20-221"><a href="#cb20-221"></a><span class="im">import</span> math, numpy <span class="im">as</span> np</span>
<span id="cb20-222"><a href="#cb20-222"></a></span>
<span id="cb20-223"><a href="#cb20-223"></a><span class="co"># ---- Speed / stability toggles ----</span></span>
<span id="cb20-224"><a href="#cb20-224"></a>DO_BOOTSTRAP <span class="op">=</span> <span class="va">False</span>       <span class="co"># turn ON only if you really need SEs; this saves lots of time</span></span>
<span id="cb20-225"><a href="#cb20-225"></a>B <span class="op">=</span> <span class="dv">8</span>                      <span class="co"># bootstrap iterations if enabled</span></span>
<span id="cb20-226"><a href="#cb20-226"></a>BOOTSTRAP_FRACTION <span class="op">=</span> <span class="fl">0.85</span>  <span class="co"># subsample per bootstrap to speed up</span></span>
<span id="cb20-227"><a href="#cb20-227"></a>RIDGE <span class="op">=</span> <span class="fl">1e-4</span>               <span class="co"># tiny L2 to avoid singularities</span></span>
<span id="cb20-228"><a href="#cb20-228"></a>MAXITER_LR <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb20-229"><a href="#cb20-229"></a>MAXITER_GLR <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb20-230"><a href="#cb20-230"></a>TOL <span class="op">=</span> <span class="fl">1e-5</span></span>
<span id="cb20-231"><a href="#cb20-231"></a></span>
<span id="cb20-232"><a href="#cb20-232"></a><span class="co"># -----------------------------</span></span>
<span id="cb20-233"><a href="#cb20-233"></a><span class="co"># Helpers</span></span>
<span id="cb20-234"><a href="#cb20-234"></a><span class="co"># -----------------------------</span></span>
<span id="cb20-235"><a href="#cb20-235"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb20-236"><a href="#cb20-236"></a>    <span class="co">"""Read feature names from Vector metadata; fallback to generic names."""</span></span>
<span id="cb20-237"><a href="#cb20-237"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb20-238"><a href="#cb20-238"></a>    <span class="cf">try</span>:</span>
<span id="cb20-239"><a href="#cb20-239"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb20-240"><a href="#cb20-240"></a>        names <span class="op">=</span> []</span>
<span id="cb20-241"><a href="#cb20-241"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb20-242"><a href="#cb20-242"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb20-243"><a href="#cb20-243"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb20-244"><a href="#cb20-244"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb20-245"><a href="#cb20-245"></a>        <span class="cf">return</span> names</span>
<span id="cb20-246"><a href="#cb20-246"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-247"><a href="#cb20-247"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).head().n</span>
<span id="cb20-248"><a href="#cb20-248"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb20-249"><a href="#cb20-249"></a></span>
<span id="cb20-250"><a href="#cb20-250"></a><span class="kw">def</span> normal_pvalue_from_t(t):</span>
<span id="cb20-251"><a href="#cb20-251"></a>    <span class="co">"""Two-sided p-value from z/t using normal approx."""</span></span>
<span id="cb20-252"><a href="#cb20-252"></a>    <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> t <span class="op">!=</span> t:</span>
<span id="cb20-253"><a href="#cb20-253"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-254"><a href="#cb20-254"></a>    <span class="cf">return</span> <span class="fl">2.0</span> <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> math.erf(<span class="bu">abs</span>(<span class="bu">float</span>(t))<span class="op">/</span>math.sqrt(<span class="dv">2</span>))))</span>
<span id="cb20-255"><a href="#cb20-255"></a></span>
<span id="cb20-256"><a href="#cb20-256"></a><span class="kw">def</span> safe_ci(beta, se, z<span class="op">=</span><span class="fl">1.96</span>):</span>
<span id="cb20-257"><a href="#cb20-257"></a>    <span class="cf">try</span>:</span>
<span id="cb20-258"><a href="#cb20-258"></a>        <span class="cf">if</span> se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> se <span class="op">!=</span> se:</span>
<span id="cb20-259"><a href="#cb20-259"></a>            <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>), <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-260"><a href="#cb20-260"></a>        <span class="cf">return</span> <span class="bu">float</span>(beta <span class="op">-</span> z<span class="op">*</span>se), <span class="bu">float</span>(beta <span class="op">+</span> z<span class="op">*</span>se)</span>
<span id="cb20-261"><a href="#cb20-261"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-262"><a href="#cb20-262"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>), <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-263"><a href="#cb20-263"></a></span>
<span id="cb20-264"><a href="#cb20-264"></a><span class="kw">def</span> build_table(coefs, ses, names, intercept<span class="op">=</span><span class="va">None</span>, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>)):</span>
<span id="cb20-265"><a href="#cb20-265"></a>    <span class="co"># Align lengths</span></span>
<span id="cb20-266"><a href="#cb20-266"></a>    <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">!=</span> <span class="bu">len</span>(coefs):</span>
<span id="cb20-267"><a href="#cb20-267"></a>        <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">&gt;</span> <span class="bu">len</span>(coefs):</span>
<span id="cb20-268"><a href="#cb20-268"></a>            names <span class="op">=</span> names[:<span class="bu">len</span>(coefs)]</span>
<span id="cb20-269"><a href="#cb20-269"></a>        <span class="cf">else</span>:</span>
<span id="cb20-270"><a href="#cb20-270"></a>            names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(names), <span class="bu">len</span>(coefs))]</span>
<span id="cb20-271"><a href="#cb20-271"></a></span>
<span id="cb20-272"><a href="#cb20-272"></a>    rows <span class="op">=</span> []</span>
<span id="cb20-273"><a href="#cb20-273"></a>    <span class="cf">for</span> n, b, se <span class="kw">in</span> <span class="bu">zip</span>(names, coefs, ses):</span>
<span id="cb20-274"><a href="#cb20-274"></a>        t <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>) <span class="cf">if</span> (se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> se <span class="op">!=</span> se <span class="kw">or</span> se <span class="op">==</span> <span class="fl">0.0</span>) <span class="cf">else</span> <span class="bu">float</span>(b <span class="op">/</span> se)</span>
<span id="cb20-275"><a href="#cb20-275"></a>        p <span class="op">=</span> normal_pvalue_from_t(t)</span>
<span id="cb20-276"><a href="#cb20-276"></a>        lo, hi <span class="op">=</span> safe_ci(b, se)</span>
<span id="cb20-277"><a href="#cb20-277"></a>        rows.append((n, <span class="bu">float</span>(b), <span class="bu">float</span>(se) <span class="cf">if</span> se <span class="op">==</span> se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>), t, p, lo, hi))</span>
<span id="cb20-278"><a href="#cb20-278"></a></span>
<span id="cb20-279"><a href="#cb20-279"></a>    coef_df <span class="op">=</span> spark.createDataFrame(rows, [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>])</span>
<span id="cb20-280"><a href="#cb20-280"></a></span>
<span id="cb20-281"><a href="#cb20-281"></a>    <span class="co"># Intercept row (if provided)</span></span>
<span id="cb20-282"><a href="#cb20-282"></a>    <span class="cf">if</span> intercept <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb20-283"><a href="#cb20-283"></a>        t_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>) <span class="cf">if</span> (intercept_se <span class="op">!=</span> intercept_se <span class="kw">or</span> intercept_se <span class="op">==</span> <span class="fl">0.0</span>) <span class="cf">else</span> <span class="bu">float</span>(intercept <span class="op">/</span> intercept_se)</span>
<span id="cb20-284"><a href="#cb20-284"></a>        p_i <span class="op">=</span> normal_pvalue_from_t(t_i)</span>
<span id="cb20-285"><a href="#cb20-285"></a>        lo_i, hi_i <span class="op">=</span> safe_ci(intercept, intercept_se)</span>
<span id="cb20-286"><a href="#cb20-286"></a>        irow <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb20-287"><a href="#cb20-287"></a>            [(<span class="st">"Intercept"</span>, <span class="bu">float</span>(intercept), <span class="bu">float</span>(intercept_se), t_i, p_i, lo_i, hi_i)],</span>
<span id="cb20-288"><a href="#cb20-288"></a>            [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>]</span>
<span id="cb20-289"><a href="#cb20-289"></a>        )</span>
<span id="cb20-290"><a href="#cb20-290"></a>        coef_df <span class="op">=</span> irow.unionByName(coef_df)</span>
<span id="cb20-291"><a href="#cb20-291"></a></span>
<span id="cb20-292"><a href="#cb20-292"></a>    <span class="cf">return</span> coef_df</span>
<span id="cb20-293"><a href="#cb20-293"></a></span>
<span id="cb20-294"><a href="#cb20-294"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-295"><a href="#cb20-295"></a><span class="co"># 1) Zero-variance pruning on TRAIN (robust)</span></span>
<span id="cb20-296"><a href="#cb20-296"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-297"><a href="#cb20-297"></a>feat_names_full <span class="op">=</span> extract_feature_names(train_df, <span class="st">"features"</span>)</span>
<span id="cb20-298"><a href="#cb20-298"></a></span>
<span id="cb20-299"><a href="#cb20-299"></a>var_row <span class="op">=</span> train_df.select(</span>
<span id="cb20-300"><a href="#cb20-300"></a>    Summarizer.variance(train_df[<span class="st">"features"</span>]).alias(<span class="st">"var"</span>)</span>
<span id="cb20-301"><a href="#cb20-301"></a>).first()</span>
<span id="cb20-302"><a href="#cb20-302"></a></span>
<span id="cb20-303"><a href="#cb20-303"></a><span class="co"># Convert variance vector to 1-D numpy safely</span></span>
<span id="cb20-304"><a href="#cb20-304"></a>variances <span class="op">=</span> var_row[<span class="st">"var"</span>].toArray() <span class="cf">if</span> <span class="bu">hasattr</span>(var_row[<span class="st">"var"</span>], <span class="st">"toArray"</span>) <span class="cf">else</span> np.array(var_row[<span class="st">"var"</span>]).ravel()</span>
<span id="cb20-305"><a href="#cb20-305"></a></span>
<span id="cb20-306"><a href="#cb20-306"></a>keep_idx <span class="op">=</span> [<span class="bu">int</span>(i) <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(variances) <span class="cf">if</span> (v <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>) <span class="kw">and</span> <span class="kw">not</span> np.isnan(v) <span class="kw">and</span> v <span class="op">&gt;</span> <span class="fl">1e-12</span>]</span>
<span id="cb20-307"><a href="#cb20-307"></a><span class="cf">if</span> <span class="kw">not</span> keep_idx:  <span class="co"># safety fallback</span></span>
<span id="cb20-308"><a href="#cb20-308"></a>    keep_idx <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(variances)))</span>
<span id="cb20-309"><a href="#cb20-309"></a></span>
<span id="cb20-310"><a href="#cb20-310"></a>removed <span class="op">=</span> <span class="bu">len</span>(variances) <span class="op">-</span> <span class="bu">len</span>(keep_idx)</span>
<span id="cb20-311"><a href="#cb20-311"></a><span class="bu">print</span>(<span class="ss">f"ℹ️ Removed </span><span class="sc">{</span>removed<span class="sc">}</span><span class="ss"> zero-variance feature(s)."</span> <span class="cf">if</span> removed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"ℹ️ No zero-variance features found."</span>)</span>
<span id="cb20-312"><a href="#cb20-312"></a></span>
<span id="cb20-313"><a href="#cb20-313"></a>slicer <span class="op">=</span> VectorSlicer(inputCol<span class="op">=</span><span class="st">"features"</span>, outputCol<span class="op">=</span><span class="st">"features_nz"</span>, indices<span class="op">=</span>keep_idx)</span>
<span id="cb20-314"><a href="#cb20-314"></a>train_nz <span class="op">=</span> slicer.transform(train_df).drop(<span class="st">"features"</span>).withColumnRenamed(<span class="st">"features_nz"</span>, <span class="st">"features"</span>)</span>
<span id="cb20-315"><a href="#cb20-315"></a>test_nz  <span class="op">=</span> slicer.transform(test_df ).drop(<span class="st">"features"</span>).withColumnRenamed(<span class="st">"features_nz"</span>, <span class="st">"features"</span>)</span>
<span id="cb20-316"><a href="#cb20-316"></a></span>
<span id="cb20-317"><a href="#cb20-317"></a>feat_names <span class="op">=</span> [feat_names_full[i] <span class="cf">for</span> i <span class="kw">in</span> keep_idx] <span class="cf">if</span> keep_idx <span class="cf">else</span> feat_names_full</span>
<span id="cb20-318"><a href="#cb20-318"></a></span>
<span id="cb20-319"><a href="#cb20-319"></a><span class="co"># Cache &amp; materialize once to avoid recomputation across fits</span></span>
<span id="cb20-320"><a href="#cb20-320"></a>train_nz <span class="op">=</span> train_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb20-321"><a href="#cb20-321"></a>test_nz  <span class="op">=</span> test_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb20-322"><a href="#cb20-322"></a>_ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb20-323"><a href="#cb20-323"></a></span>
<span id="cb20-324"><a href="#cb20-324"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-325"><a href="#cb20-325"></a><span class="co"># 2) Fit Linear Regression (fast/stable) + </span><span class="al">TEST</span><span class="co"> metrics</span></span>
<span id="cb20-326"><a href="#cb20-326"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-327"><a href="#cb20-327"></a>lr <span class="op">=</span> LinearRegression(</span>
<span id="cb20-328"><a href="#cb20-328"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb20-329"><a href="#cb20-329"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb20-330"><a href="#cb20-330"></a>    predictionCol<span class="op">=</span><span class="st">"prediction"</span>,</span>
<span id="cb20-331"><a href="#cb20-331"></a>    fitIntercept<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-332"><a href="#cb20-332"></a>    regParam<span class="op">=</span>RIDGE,             <span class="co"># tiny L2 prevents singularities</span></span>
<span id="cb20-333"><a href="#cb20-333"></a>    elasticNetParam<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb20-334"><a href="#cb20-334"></a>    solver<span class="op">=</span><span class="st">"l-bfgs"</span>,            <span class="co"># faster &amp; avoids Cholesky path</span></span>
<span id="cb20-335"><a href="#cb20-335"></a>    maxIter<span class="op">=</span>MAXITER_LR,</span>
<span id="cb20-336"><a href="#cb20-336"></a>    tol<span class="op">=</span>TOL,</span>
<span id="cb20-337"><a href="#cb20-337"></a>    standardization<span class="op">=</span><span class="va">True</span></span>
<span id="cb20-338"><a href="#cb20-338"></a>)</span>
<span id="cb20-339"><a href="#cb20-339"></a>lr_model <span class="op">=</span> lr.fit(train_nz)</span>
<span id="cb20-340"><a href="#cb20-340"></a>lr_sum   <span class="op">=</span> lr_model.summary</span>
<span id="cb20-341"><a href="#cb20-341"></a></span>
<span id="cb20-342"><a href="#cb20-342"></a>e_rmse <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"rmse"</span>)</span>
<span id="cb20-343"><a href="#cb20-343"></a>e_r2   <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb20-344"><a href="#cb20-344"></a>e_mae  <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"mae"</span>)</span>
<span id="cb20-345"><a href="#cb20-345"></a></span>
<span id="cb20-346"><a href="#cb20-346"></a>pred_test <span class="op">=</span> lr_model.transform(test_nz).cache()</span>
<span id="cb20-347"><a href="#cb20-347"></a>rmse_test <span class="op">=</span> e_rmse.evaluate(pred_test)</span>
<span id="cb20-348"><a href="#cb20-348"></a>r2_test   <span class="op">=</span> e_r2.evaluate(pred_test)</span>
<span id="cb20-349"><a href="#cb20-349"></a>mae_test  <span class="op">=</span> e_mae.evaluate(pred_test)</span>
<span id="cb20-350"><a href="#cb20-350"></a></span>
<span id="cb20-351"><a href="#cb20-351"></a><span class="bu">print</span>(<span class="ss">f"✅ Test RMSE: </span><span class="sc">{</span>rmse_test<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-352"><a href="#cb20-352"></a><span class="bu">print</span>(<span class="ss">f"✅ Test MAE : </span><span class="sc">{</span>mae_test<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-353"><a href="#cb20-353"></a><span class="bu">print</span>(<span class="ss">f"✅ Test R²  : </span><span class="sc">{</span>r2_test<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-354"><a href="#cb20-354"></a></span>
<span id="cb20-355"><a href="#cb20-355"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Training Metrics (reference) ---"</span>)</span>
<span id="cb20-356"><a href="#cb20-356"></a><span class="bu">print</span>(<span class="ss">f"RMSE: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>rootMeanSquaredError<span class="sc">:,.2f}</span><span class="ss"> | MAE: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>meanAbsoluteError<span class="sc">:,.2f}</span><span class="ss"> | R²: </span><span class="sc">{</span>lr_sum<span class="sc">.</span>r2<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-357"><a href="#cb20-357"></a></span>
<span id="cb20-358"><a href="#cb20-358"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-359"><a href="#cb20-359"></a><span class="co"># 3) Inference: LR -&gt; GLR -&gt; Bootstrap fallback</span></span>
<span id="cb20-360"><a href="#cb20-360"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb20-361"><a href="#cb20-361"></a>coef_df_out <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-362"><a href="#cb20-362"></a>got_inference <span class="op">=</span> <span class="va">False</span></span>
<span id="cb20-363"><a href="#cb20-363"></a></span>
<span id="cb20-364"><a href="#cb20-364"></a><span class="co"># (a) Try LR analytic inference (may be unavailable)</span></span>
<span id="cb20-365"><a href="#cb20-365"></a><span class="cf">try</span>:</span>
<span id="cb20-366"><a href="#cb20-366"></a>    ses_lr   <span class="op">=</span> <span class="bu">list</span>(lr_sum.coefficientStandardErrors)</span>
<span id="cb20-367"><a href="#cb20-367"></a>    coefs_lr <span class="op">=</span> <span class="bu">list</span>(lr_model.coefficients.toArray())</span>
<span id="cb20-368"><a href="#cb20-368"></a>    coef_df_out <span class="op">=</span> build_table(coefs_lr, ses_lr, feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb20-369"><a href="#cb20-369"></a>    got_inference <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-370"><a href="#cb20-370"></a>    <span class="bu">print</span>(<span class="st">"ℹ️ Using LR analytic standard errors."</span>)</span>
<span id="cb20-371"><a href="#cb20-371"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-372"><a href="#cb20-372"></a>    <span class="cf">pass</span></span>
<span id="cb20-373"><a href="#cb20-373"></a></span>
<span id="cb20-374"><a href="#cb20-374"></a><span class="co"># (b) GLR fallback (Gaussian/identity) with tiny ridge and L-BFGS</span></span>
<span id="cb20-375"><a href="#cb20-375"></a><span class="cf">if</span> <span class="kw">not</span> got_inference:</span>
<span id="cb20-376"><a href="#cb20-376"></a>    <span class="cf">try</span>:</span>
<span id="cb20-377"><a href="#cb20-377"></a>        glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb20-378"><a href="#cb20-378"></a>            featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_glr"</span>,</span>
<span id="cb20-379"><a href="#cb20-379"></a>            family<span class="op">=</span><span class="st">"gaussian"</span>, link<span class="op">=</span><span class="st">"identity"</span>,</span>
<span id="cb20-380"><a href="#cb20-380"></a>            fitIntercept<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-381"><a href="#cb20-381"></a>            regParam<span class="op">=</span>RIDGE,</span>
<span id="cb20-382"><a href="#cb20-382"></a>            maxIter<span class="op">=</span>MAXITER_GLR,</span>
<span id="cb20-383"><a href="#cb20-383"></a>            tol<span class="op">=</span>TOL</span>
<span id="cb20-384"><a href="#cb20-384"></a>        )</span>
<span id="cb20-385"><a href="#cb20-385"></a>        glr_model <span class="op">=</span> glr.fit(train_nz)</span>
<span id="cb20-386"><a href="#cb20-386"></a>        glr_sum   <span class="op">=</span> glr_model.summary</span>
<span id="cb20-387"><a href="#cb20-387"></a></span>
<span id="cb20-388"><a href="#cb20-388"></a>        ses_all <span class="op">=</span> <span class="bu">list</span>(glr_sum.coefficientStandardErrors)  <span class="co"># may include intercept as last element</span></span>
<span id="cb20-389"><a href="#cb20-389"></a>        coefs_g <span class="op">=</span> <span class="bu">list</span>(glr_model.coefficients.toArray())</span>
<span id="cb20-390"><a href="#cb20-390"></a></span>
<span id="cb20-391"><a href="#cb20-391"></a>        <span class="co"># Intercept SE often appears as the last element</span></span>
<span id="cb20-392"><a href="#cb20-392"></a>        intercept_se <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-393"><a href="#cb20-393"></a>        <span class="cf">if</span> <span class="bu">len</span>(ses_all) <span class="op">==</span> <span class="bu">len</span>(coefs_g) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb20-394"><a href="#cb20-394"></a>            intercept_se <span class="op">=</span> <span class="bu">float</span>(ses_all[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb20-395"><a href="#cb20-395"></a>            ses_g <span class="op">=</span> ses_all[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb20-396"><a href="#cb20-396"></a>        <span class="cf">else</span>:</span>
<span id="cb20-397"><a href="#cb20-397"></a>            ses_g <span class="op">=</span> ses_all</span>
<span id="cb20-398"><a href="#cb20-398"></a></span>
<span id="cb20-399"><a href="#cb20-399"></a>        coef_df_out <span class="op">=</span> build_table(coefs_g, ses_g, feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span>intercept_se)</span>
<span id="cb20-400"><a href="#cb20-400"></a>        got_inference <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-401"><a href="#cb20-401"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Using GLR analytic standard errors."</span>)</span>
<span id="cb20-402"><a href="#cb20-402"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-403"><a href="#cb20-403"></a>        <span class="cf">pass</span></span>
<span id="cb20-404"><a href="#cb20-404"></a></span>
<span id="cb20-405"><a href="#cb20-405"></a><span class="co"># (c) Bootstrap fallback (lightweight) if analytic SEs are unavailable</span></span>
<span id="cb20-406"><a href="#cb20-406"></a><span class="cf">if</span> <span class="kw">not</span> got_inference:</span>
<span id="cb20-407"><a href="#cb20-407"></a>    <span class="cf">if</span> DO_BOOTSTRAP:</span>
<span id="cb20-408"><a href="#cb20-408"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Analytic SE unavailable — running bootstrap (B=</span><span class="sc">{</span>B<span class="sc">}</span><span class="ss">)."</span>)</span>
<span id="cb20-409"><a href="#cb20-409"></a>        coef_mat <span class="op">=</span> []</span>
<span id="cb20-410"><a href="#cb20-410"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(B):</span>
<span id="cb20-411"><a href="#cb20-411"></a>            samp <span class="op">=</span> train_nz.sample(withReplacement<span class="op">=</span><span class="va">True</span>, fraction<span class="op">=</span>BOOTSTRAP_FRACTION, seed<span class="op">=</span><span class="dv">2025</span> <span class="op">+</span> b)</span>
<span id="cb20-412"><a href="#cb20-412"></a>            m <span class="op">=</span> lr.fit(samp)</span>
<span id="cb20-413"><a href="#cb20-413"></a>            coef_mat.append(m.coefficients.toArray())</span>
<span id="cb20-414"><a href="#cb20-414"></a>        coef_mat <span class="op">=</span> np.array(coef_mat)  <span class="co"># [B, p]</span></span>
<span id="cb20-415"><a href="#cb20-415"></a>        coefs <span class="op">=</span> lr_model.coefficients.toArray()</span>
<span id="cb20-416"><a href="#cb20-416"></a>        ses   <span class="op">=</span> np.std(coef_mat, axis<span class="op">=</span><span class="dv">0</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-417"><a href="#cb20-417"></a>        coef_df_out <span class="op">=</span> build_table(<span class="bu">list</span>(coefs), <span class="bu">list</span>(ses), feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb20-418"><a href="#cb20-418"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Bootstrap SE computed."</span>)</span>
<span id="cb20-419"><a href="#cb20-419"></a>    <span class="cf">else</span>:</span>
<span id="cb20-420"><a href="#cb20-420"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Skipping bootstrap; reporting coefficients without SE."</span>)</span>
<span id="cb20-421"><a href="#cb20-421"></a>        coefs <span class="op">=</span> lr_model.coefficients.toArray()</span>
<span id="cb20-422"><a href="#cb20-422"></a>        ses   <span class="op">=</span> [<span class="bu">float</span>(<span class="st">"nan"</span>)] <span class="op">*</span> <span class="bu">len</span>(coefs)</span>
<span id="cb20-423"><a href="#cb20-423"></a>        coef_df_out <span class="op">=</span> build_table(<span class="bu">list</span>(coefs), ses, feat_names, intercept<span class="op">=</span>lr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb20-424"><a href="#cb20-424"></a></span>
<span id="cb20-425"><a href="#cb20-425"></a><span class="co"># Order and display</span></span>
<span id="cb20-426"><a href="#cb20-426"></a>coef_df_out <span class="op">=</span> coef_df_out.withColumn(<span class="st">"abs_t"</span>, F.<span class="bu">abs</span>(F.col(<span class="st">"t"</span>))).orderBy(F.desc_nulls_last(<span class="st">"abs_t"</span>))</span>
<span id="cb20-427"><a href="#cb20-427"></a></span>
<span id="cb20-428"><a href="#cb20-428"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 25 coefficients by |t| ---"</span>)</span>
<span id="cb20-429"><a href="#cb20-429"></a>coef_df_out.select(<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>).show(<span class="dv">25</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-430"><a href="#cb20-430"></a></span>
<span id="cb20-431"><a href="#cb20-431"></a><span class="co"># save the full table</span></span>
<span id="cb20-432"><a href="#cb20-432"></a>coef_df_out.coalesce(<span class="dv">1</span>).write.mode(<span class="st">"overwrite"</span>).option(<span class="st">"header"</span>, <span class="va">True</span>).csv(<span class="st">"output/linear_coef_table"</span>)</span>
<span id="cb20-433"><a href="#cb20-433"></a></span>
<span id="cb20-434"><a href="#cb20-434"></a><span class="in">```</span></span>
<span id="cb20-435"><a href="#cb20-435"></a></span>
<span id="cb20-436"><a href="#cb20-436"></a></span>
<span id="cb20-437"><a href="#cb20-437"></a></span>
<span id="cb20-438"><a href="#cb20-438"></a><span class="fu">## Generalized Linear Regression Summary</span></span>
<span id="cb20-439"><a href="#cb20-439"></a></span>
<span id="cb20-442"><a href="#cb20-442"></a><span class="in">```{python}</span></span>
<span id="cb20-443"><a href="#cb20-443"></a><span class="co"># ======================================================</span></span>
<span id="cb20-444"><a href="#cb20-444"></a><span class="co"># GLR SUMMARY (defensive, with bootstrap fallback)</span></span>
<span id="cb20-445"><a href="#cb20-445"></a><span class="co"># ======================================================</span></span>
<span id="cb20-446"><a href="#cb20-446"></a></span>
<span id="cb20-447"><a href="#cb20-447"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GeneralizedLinearRegression</span>
<span id="cb20-448"><a href="#cb20-448"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb20-449"><a href="#cb20-449"></a><span class="im">import</span> math, numpy <span class="im">as</span> np</span>
<span id="cb20-450"><a href="#cb20-450"></a></span>
<span id="cb20-451"><a href="#cb20-451"></a><span class="co"># ---------- safety: cache the pruned datasets ----------</span></span>
<span id="cb20-452"><a href="#cb20-452"></a><span class="cf">try</span>:</span>
<span id="cb20-453"><a href="#cb20-453"></a>    train_nz <span class="op">=</span> train_nz.cache()<span class="op">;</span> test_nz <span class="op">=</span> test_nz.cache()</span>
<span id="cb20-454"><a href="#cb20-454"></a>    _ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb20-455"><a href="#cb20-455"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb20-456"><a href="#cb20-456"></a>    <span class="co"># If you haven't run the train/test split + pruning cells yet</span></span>
<span id="cb20-457"><a href="#cb20-457"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the Train/Test Split cell first."</span>)</span>
<span id="cb20-458"><a href="#cb20-458"></a></span>
<span id="cb20-459"><a href="#cb20-459"></a><span class="co"># ---------- settings (tweakable) ----------</span></span>
<span id="cb20-460"><a href="#cb20-460"></a>DO_BOOTSTRAP <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-461"><a href="#cb20-461"></a>B <span class="op">=</span> <span class="dv">8</span>                    <span class="co"># keep modest for speed</span></span>
<span id="cb20-462"><a href="#cb20-462"></a>BOOTSTRAP_FRACTION <span class="op">=</span> <span class="fl">0.85</span></span>
<span id="cb20-463"><a href="#cb20-463"></a>Z_95 <span class="op">=</span> <span class="fl">1.96</span></span>
<span id="cb20-464"><a href="#cb20-464"></a></span>
<span id="cb20-465"><a href="#cb20-465"></a><span class="co"># ---------- helpers ----------</span></span>
<span id="cb20-466"><a href="#cb20-466"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb20-467"><a href="#cb20-467"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb20-468"><a href="#cb20-468"></a>    <span class="cf">try</span>:</span>
<span id="cb20-469"><a href="#cb20-469"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb20-470"><a href="#cb20-470"></a>        names <span class="op">=</span> []</span>
<span id="cb20-471"><a href="#cb20-471"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb20-472"><a href="#cb20-472"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb20-473"><a href="#cb20-473"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb20-474"><a href="#cb20-474"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb20-475"><a href="#cb20-475"></a>        <span class="cf">return</span> names</span>
<span id="cb20-476"><a href="#cb20-476"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-477"><a href="#cb20-477"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb20-478"><a href="#cb20-478"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb20-479"><a href="#cb20-479"></a></span>
<span id="cb20-480"><a href="#cb20-480"></a><span class="kw">def</span> normal_pvalue_from_t(t):</span>
<span id="cb20-481"><a href="#cb20-481"></a>    <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> (<span class="bu">isinstance</span>(t, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(t)):</span>
<span id="cb20-482"><a href="#cb20-482"></a>        <span class="cf">return</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-483"><a href="#cb20-483"></a>    z <span class="op">=</span> <span class="bu">abs</span>(<span class="bu">float</span>(t))</span>
<span id="cb20-484"><a href="#cb20-484"></a>    <span class="cf">return</span> <span class="fl">2.0</span> <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> math.erf(z <span class="op">/</span> math.sqrt(<span class="dv">2</span>))))</span>
<span id="cb20-485"><a href="#cb20-485"></a></span>
<span id="cb20-486"><a href="#cb20-486"></a><span class="kw">def</span> build_table(coefs, ses, names, intercept<span class="op">=</span><span class="va">None</span>, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>)):</span>
<span id="cb20-487"><a href="#cb20-487"></a>    <span class="co"># align lengths</span></span>
<span id="cb20-488"><a href="#cb20-488"></a>    <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">!=</span> <span class="bu">len</span>(coefs):</span>
<span id="cb20-489"><a href="#cb20-489"></a>        <span class="cf">if</span> <span class="bu">len</span>(names) <span class="op">&gt;</span> <span class="bu">len</span>(coefs):</span>
<span id="cb20-490"><a href="#cb20-490"></a>            names <span class="op">=</span> names[:<span class="bu">len</span>(coefs)]</span>
<span id="cb20-491"><a href="#cb20-491"></a>        <span class="cf">else</span>:</span>
<span id="cb20-492"><a href="#cb20-492"></a>            names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(names), <span class="bu">len</span>(coefs))]</span>
<span id="cb20-493"><a href="#cb20-493"></a></span>
<span id="cb20-494"><a href="#cb20-494"></a>    rows <span class="op">=</span> []</span>
<span id="cb20-495"><a href="#cb20-495"></a>    <span class="cf">for</span> n, b, se <span class="kw">in</span> <span class="bu">zip</span>(names, coefs, ses):</span>
<span id="cb20-496"><a href="#cb20-496"></a>        <span class="cf">if</span> se <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> (<span class="bu">isinstance</span>(se, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(se)) <span class="kw">or</span> se <span class="op">==</span> <span class="fl">0.0</span>:</span>
<span id="cb20-497"><a href="#cb20-497"></a>            t <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> p <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> lo <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> hi <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-498"><a href="#cb20-498"></a>        <span class="cf">else</span>:</span>
<span id="cb20-499"><a href="#cb20-499"></a>            t <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">/</span> <span class="bu">float</span>(se)</span>
<span id="cb20-500"><a href="#cb20-500"></a>            p <span class="op">=</span> normal_pvalue_from_t(t)</span>
<span id="cb20-501"><a href="#cb20-501"></a>            lo <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">-</span> Z_95<span class="op">*</span><span class="bu">float</span>(se)</span>
<span id="cb20-502"><a href="#cb20-502"></a>            hi <span class="op">=</span> <span class="bu">float</span>(b) <span class="op">+</span> Z_95<span class="op">*</span><span class="bu">float</span>(se)</span>
<span id="cb20-503"><a href="#cb20-503"></a>        rows.append((n, <span class="bu">float</span>(b), <span class="bu">float</span>(se) <span class="cf">if</span> se <span class="op">==</span> se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>), t, p, lo, hi))</span>
<span id="cb20-504"><a href="#cb20-504"></a></span>
<span id="cb20-505"><a href="#cb20-505"></a>    coef_df <span class="op">=</span> spark.createDataFrame(rows, [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>])</span>
<span id="cb20-506"><a href="#cb20-506"></a></span>
<span id="cb20-507"><a href="#cb20-507"></a>    <span class="co"># intercept row (optional)</span></span>
<span id="cb20-508"><a href="#cb20-508"></a>    <span class="cf">if</span> intercept <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb20-509"><a href="#cb20-509"></a>        <span class="cf">if</span> (intercept_se <span class="kw">is</span> <span class="va">None</span>) <span class="kw">or</span> (<span class="bu">isinstance</span>(intercept_se, <span class="bu">float</span>) <span class="kw">and</span> math.isnan(intercept_se)) <span class="kw">or</span> intercept_se <span class="op">==</span> <span class="fl">0.0</span>:</span>
<span id="cb20-510"><a href="#cb20-510"></a>            t_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> p_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> lo_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)<span class="op">;</span> hi_i <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-511"><a href="#cb20-511"></a>        <span class="cf">else</span>:</span>
<span id="cb20-512"><a href="#cb20-512"></a>            t_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">/</span> <span class="bu">float</span>(intercept_se)</span>
<span id="cb20-513"><a href="#cb20-513"></a>            p_i <span class="op">=</span> normal_pvalue_from_t(t_i)</span>
<span id="cb20-514"><a href="#cb20-514"></a>            lo_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">-</span> Z_95<span class="op">*</span><span class="bu">float</span>(intercept_se)</span>
<span id="cb20-515"><a href="#cb20-515"></a>            hi_i <span class="op">=</span> <span class="bu">float</span>(intercept) <span class="op">+</span> Z_95<span class="op">*</span><span class="bu">float</span>(intercept_se)</span>
<span id="cb20-516"><a href="#cb20-516"></a>        irow <span class="op">=</span> spark.createDataFrame(</span>
<span id="cb20-517"><a href="#cb20-517"></a>            [(<span class="st">"Intercept"</span>, <span class="bu">float</span>(intercept), <span class="bu">float</span>(intercept_se) <span class="cf">if</span> intercept_se<span class="op">==</span>intercept_se <span class="cf">else</span> <span class="bu">float</span>(<span class="st">"nan"</span>),</span>
<span id="cb20-518"><a href="#cb20-518"></a>              t_i, p_i, lo_i, hi_i)],</span>
<span id="cb20-519"><a href="#cb20-519"></a>            [<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>]</span>
<span id="cb20-520"><a href="#cb20-520"></a>        )</span>
<span id="cb20-521"><a href="#cb20-521"></a>        coef_df <span class="op">=</span> irow.unionByName(coef_df)</span>
<span id="cb20-522"><a href="#cb20-522"></a></span>
<span id="cb20-523"><a href="#cb20-523"></a>    <span class="cf">return</span> coef_df</span>
<span id="cb20-524"><a href="#cb20-524"></a></span>
<span id="cb20-525"><a href="#cb20-525"></a><span class="co"># ---------- 1) Fit GLR and print model metrics (all getattr-guarded) ----------</span></span>
<span id="cb20-526"><a href="#cb20-526"></a>glr <span class="op">=</span> GeneralizedLinearRegression(</span>
<span id="cb20-527"><a href="#cb20-527"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_glr"</span>,</span>
<span id="cb20-528"><a href="#cb20-528"></a>    family<span class="op">=</span><span class="st">"gaussian"</span>, link<span class="op">=</span><span class="st">"identity"</span>, fitIntercept<span class="op">=</span><span class="va">True</span>, regParam<span class="op">=</span><span class="fl">0.0</span>, maxIter<span class="op">=</span><span class="dv">100</span></span>
<span id="cb20-529"><a href="#cb20-529"></a>)</span>
<span id="cb20-530"><a href="#cb20-530"></a>glr_model <span class="op">=</span> glr.fit(train_nz)</span>
<span id="cb20-531"><a href="#cb20-531"></a>glr_sum   <span class="op">=</span> glr_model.summary</span>
<span id="cb20-532"><a href="#cb20-532"></a></span>
<span id="cb20-533"><a href="#cb20-533"></a><span class="bu">print</span>(<span class="st">"✅ GLR Model Summary"</span>)</span>
<span id="cb20-534"><a href="#cb20-534"></a><span class="bu">print</span>(<span class="ss">f"AIC: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'aic'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-535"><a href="#cb20-535"></a><span class="bu">print</span>(<span class="ss">f"Deviance: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'deviance'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-536"><a href="#cb20-536"></a><span class="bu">print</span>(<span class="ss">f"Dispersion: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'dispersion'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-537"><a href="#cb20-537"></a><span class="bu">print</span>(<span class="ss">f"Null Deviance: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'nullDeviance'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-538"><a href="#cb20-538"></a><span class="bu">print</span>(<span class="ss">f"Residual DF: </span><span class="sc">{</span><span class="bu">getattr</span>(glr_sum, <span class="st">'residualDegreeOfFreedom'</span>, <span class="bu">float</span>(<span class="st">'nan'</span>))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-539"><a href="#cb20-539"></a></span>
<span id="cb20-540"><a href="#cb20-540"></a>feat_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb20-541"><a href="#cb20-541"></a>coefs <span class="op">=</span> <span class="bu">list</span>(glr_model.coefficients.toArray())</span>
<span id="cb20-542"><a href="#cb20-542"></a></span>
<span id="cb20-543"><a href="#cb20-543"></a><span class="co"># ---------- 2) Try analytic SE; else bootstrap; else NA ----------</span></span>
<span id="cb20-544"><a href="#cb20-544"></a>coef_df_glr <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-545"><a href="#cb20-545"></a>intercept_se <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb20-546"><a href="#cb20-546"></a></span>
<span id="cb20-547"><a href="#cb20-547"></a><span class="cf">try</span>:</span>
<span id="cb20-548"><a href="#cb20-548"></a>    ses_all <span class="op">=</span> <span class="bu">list</span>(glr_sum.coefficientStandardErrors)  <span class="co"># may include intercept as last element</span></span>
<span id="cb20-549"><a href="#cb20-549"></a>    <span class="cf">if</span> <span class="bu">len</span>(ses_all) <span class="op">==</span> <span class="bu">len</span>(coefs) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb20-550"><a href="#cb20-550"></a>        intercept_se <span class="op">=</span> <span class="bu">float</span>(ses_all[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span> ses <span class="op">=</span> ses_all[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb20-551"><a href="#cb20-551"></a>    <span class="cf">else</span>:</span>
<span id="cb20-552"><a href="#cb20-552"></a>        ses <span class="op">=</span> ses_all</span>
<span id="cb20-553"><a href="#cb20-553"></a>    coef_df_glr <span class="op">=</span> build_table(coefs, ses, feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span>intercept_se)</span>
<span id="cb20-554"><a href="#cb20-554"></a>    <span class="bu">print</span>(<span class="st">"ℹ️ Using GLR analytic standard errors."</span>)</span>
<span id="cb20-555"><a href="#cb20-555"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-556"><a href="#cb20-556"></a>    <span class="bu">print</span>(<span class="st">"⚠️ GLR analytic SE unavailable."</span>)</span>
<span id="cb20-557"><a href="#cb20-557"></a>    <span class="cf">if</span> DO_BOOTSTRAP:</span>
<span id="cb20-558"><a href="#cb20-558"></a>        <span class="bu">print</span>(<span class="ss">f"⚠️ Running GLR bootstrap (B=</span><span class="sc">{</span>B<span class="sc">}</span><span class="ss">)."</span>)</span>
<span id="cb20-559"><a href="#cb20-559"></a>        coef_mat <span class="op">=</span> []</span>
<span id="cb20-560"><a href="#cb20-560"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(B):</span>
<span id="cb20-561"><a href="#cb20-561"></a>            samp <span class="op">=</span> train_nz.sample(withReplacement<span class="op">=</span><span class="va">True</span>, fraction<span class="op">=</span>BOOTSTRAP_FRACTION, seed<span class="op">=</span><span class="dv">4100</span> <span class="op">+</span> b)</span>
<span id="cb20-562"><a href="#cb20-562"></a>            m <span class="op">=</span> glr.fit(samp)</span>
<span id="cb20-563"><a href="#cb20-563"></a>            coef_mat.append(m.coefficients.toArray())</span>
<span id="cb20-564"><a href="#cb20-564"></a>        coef_mat <span class="op">=</span> np.array(coef_mat)</span>
<span id="cb20-565"><a href="#cb20-565"></a>        ses_bs   <span class="op">=</span> np.std(coef_mat, axis<span class="op">=</span><span class="dv">0</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-566"><a href="#cb20-566"></a>        coef_df_glr <span class="op">=</span> build_table(coefs, <span class="bu">list</span>(ses_bs), feat_names, intercept<span class="op">=</span>glr_model.intercept, intercept_se<span class="op">=</span><span class="bu">float</span>(<span class="st">"nan"</span>))</span>
<span id="cb20-567"><a href="#cb20-567"></a>        <span class="bu">print</span>(<span class="st">"ℹ️ Bootstrap SE computed."</span>)</span>
<span id="cb20-568"><a href="#cb20-568"></a>    <span class="cf">else</span>:</span>
<span id="cb20-569"><a href="#cb20-569"></a>        <span class="co"># As a last resort, output coefficients with NA SE (still a valid table)</span></span>
<span id="cb20-570"><a href="#cb20-570"></a>        coef_df_glr <span class="op">=</span> build_table(coefs, [<span class="bu">float</span>(<span class="st">"nan"</span>)]<span class="op">*</span><span class="bu">len</span>(coefs), feat_names, intercept<span class="op">=</span>glr_model.intercept)</span>
<span id="cb20-571"><a href="#cb20-571"></a></span>
<span id="cb20-572"><a href="#cb20-572"></a><span class="co"># ---------- 3) Order and show ----------</span></span>
<span id="cb20-573"><a href="#cb20-573"></a>coef_df_glr <span class="op">=</span> coef_df_glr.withColumn(<span class="st">"abs_t"</span>, F.<span class="bu">abs</span>(F.col(<span class="st">"t"</span>))).orderBy(F.desc_nulls_last(<span class="st">"abs_t"</span>))</span>
<span id="cb20-574"><a href="#cb20-574"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 25 GLR coefficients by |t| ---"</span>)</span>
<span id="cb20-575"><a href="#cb20-575"></a>coef_df_glr.select(<span class="st">"feature"</span>, <span class="st">"coef"</span>, <span class="st">"se"</span>, <span class="st">"t"</span>, <span class="st">"p"</span>, <span class="st">"ci_lo"</span>, <span class="st">"ci_hi"</span>).show(<span class="dv">25</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-576"><a href="#cb20-576"></a></span>
<span id="cb20-577"><a href="#cb20-577"></a><span class="co"># Optional: save</span></span>
<span id="cb20-578"><a href="#cb20-578"></a>coef_df_glr.coalesce(<span class="dv">1</span>).write.mode(<span class="st">"overwrite"</span>).option(<span class="st">"header"</span>, <span class="va">True</span>).csv(<span class="st">"output/glr_coef_table"</span>)</span>
<span id="cb20-579"><a href="#cb20-579"></a></span>
<span id="cb20-580"><a href="#cb20-580"></a></span>
<span id="cb20-581"><a href="#cb20-581"></a><span class="in">```</span></span>
<span id="cb20-582"><a href="#cb20-582"></a></span>
<span id="cb20-583"><a href="#cb20-583"></a></span>
<span id="cb20-584"><a href="#cb20-584"></a><span class="fu">### Interpretation</span></span>
<span id="cb20-585"><a href="#cb20-585"></a></span>
<span id="cb20-586"><a href="#cb20-586"></a>The Generalized Linear Regression model produced an AIC of approximately 71,000, and the dispersion parameter aligns well with the salary scale. According to bootstrap-based standard errors, employment type and education level have the most significant impact on salary. Specifically, full-time positions and advanced degrees, such as Master’s and Ph.D., considerably increase the predicted salary, while part-time roles and lower education levels lead to a decrease. Geographic factors also play an important role, highlighting the variations in labor markets at the state level. Overall, the model effectively identifies and interprets key relationships while ensuring numerical stability through bootstrapped inference.</span>
<span id="cb20-587"><a href="#cb20-587"></a></span>
<span id="cb20-588"><a href="#cb20-588"></a></span>
<span id="cb20-589"><a href="#cb20-589"></a></span>
<span id="cb20-590"><a href="#cb20-590"></a></span>
<span id="cb20-591"><a href="#cb20-591"></a></span>
<span id="cb20-592"><a href="#cb20-592"></a><span class="fu"># Random Forest Regressor</span></span>
<span id="cb20-593"><a href="#cb20-593"></a></span>
<span id="cb20-596"><a href="#cb20-596"></a><span class="in">```{python}</span></span>
<span id="cb20-597"><a href="#cb20-597"></a><span class="co"># ======================================================</span></span>
<span id="cb20-598"><a href="#cb20-598"></a><span class="co"># RANDOM FOREST REGRESSOR </span></span>
<span id="cb20-599"><a href="#cb20-599"></a><span class="co">#   - trains on train_nz, evaluates on test_nz</span></span>
<span id="cb20-600"><a href="#cb20-600"></a><span class="co">#   - robust feature-name handling for importances</span></span>
<span id="cb20-601"><a href="#cb20-601"></a><span class="co">#   - caches data to avoid recomputation</span></span>
<span id="cb20-602"><a href="#cb20-602"></a><span class="co"># ======================================================</span></span>
<span id="cb20-603"><a href="#cb20-603"></a></span>
<span id="cb20-604"><a href="#cb20-604"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb20-605"><a href="#cb20-605"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb20-606"><a href="#cb20-606"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb20-607"><a href="#cb20-607"></a></span>
<span id="cb20-608"><a href="#cb20-608"></a><span class="co"># ----------- Hyperparameters (edit here) -----------</span></span>
<span id="cb20-609"><a href="#cb20-609"></a>NUM_TREES <span class="op">=</span> <span class="dv">200</span>        <span class="co"># 100–500 per instructions</span></span>
<span id="cb20-610"><a href="#cb20-610"></a>MAX_DEPTH <span class="op">=</span> <span class="dv">6</span>          <span class="co"># 4–10 per instructions</span></span>
<span id="cb20-611"><a href="#cb20-611"></a>FEATURE_SUBSET <span class="op">=</span> <span class="st">"sqrt"</span></span>
<span id="cb20-612"><a href="#cb20-612"></a>SUBSAMPLE <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb20-613"><a href="#cb20-613"></a>MAX_BINS <span class="op">=</span> <span class="dv">64</span></span>
<span id="cb20-614"><a href="#cb20-614"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb20-615"><a href="#cb20-615"></a></span>
<span id="cb20-616"><a href="#cb20-616"></a><span class="co"># ----------- Safety: ensure train/test exist, cache once -----------</span></span>
<span id="cb20-617"><a href="#cb20-617"></a><span class="cf">try</span>:</span>
<span id="cb20-618"><a href="#cb20-618"></a>    train_nz  <span class="co"># noqa: F401</span></span>
<span id="cb20-619"><a href="#cb20-619"></a>    test_nz   <span class="co"># noqa: F401</span></span>
<span id="cb20-620"><a href="#cb20-620"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb20-621"><a href="#cb20-621"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the train/test split + feature steps first."</span>)</span>
<span id="cb20-622"><a href="#cb20-622"></a></span>
<span id="cb20-623"><a href="#cb20-623"></a><span class="co"># Cache &amp; materialize to prevent long DAG recomputes</span></span>
<span id="cb20-624"><a href="#cb20-624"></a>train_nz <span class="op">=</span> train_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb20-625"><a href="#cb20-625"></a>test_nz  <span class="op">=</span> test_nz.repartition(<span class="dv">4</span>).cache()</span>
<span id="cb20-626"><a href="#cb20-626"></a>_ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb20-627"><a href="#cb20-627"></a></span>
<span id="cb20-628"><a href="#cb20-628"></a><span class="co"># ----------- Helper: robust feature names -----------</span></span>
<span id="cb20-629"><a href="#cb20-629"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb20-630"><a href="#cb20-630"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb20-631"><a href="#cb20-631"></a>    <span class="cf">try</span>:</span>
<span id="cb20-632"><a href="#cb20-632"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb20-633"><a href="#cb20-633"></a>        names <span class="op">=</span> []</span>
<span id="cb20-634"><a href="#cb20-634"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb20-635"><a href="#cb20-635"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb20-636"><a href="#cb20-636"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb20-637"><a href="#cb20-637"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb20-638"><a href="#cb20-638"></a>        <span class="cf">return</span> names</span>
<span id="cb20-639"><a href="#cb20-639"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-640"><a href="#cb20-640"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb20-641"><a href="#cb20-641"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb20-642"><a href="#cb20-642"></a></span>
<span id="cb20-643"><a href="#cb20-643"></a>feature_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb20-644"><a href="#cb20-644"></a></span>
<span id="cb20-645"><a href="#cb20-645"></a><span class="co"># ----------- 1) Train RF -----------</span></span>
<span id="cb20-646"><a href="#cb20-646"></a>rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb20-647"><a href="#cb20-647"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb20-648"><a href="#cb20-648"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb20-649"><a href="#cb20-649"></a>    predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>,</span>
<span id="cb20-650"><a href="#cb20-650"></a>    numTrees<span class="op">=</span>NUM_TREES,</span>
<span id="cb20-651"><a href="#cb20-651"></a>    maxDepth<span class="op">=</span>MAX_DEPTH,</span>
<span id="cb20-652"><a href="#cb20-652"></a>    featureSubsetStrategy<span class="op">=</span>FEATURE_SUBSET,</span>
<span id="cb20-653"><a href="#cb20-653"></a>    subsamplingRate<span class="op">=</span>SUBSAMPLE,</span>
<span id="cb20-654"><a href="#cb20-654"></a>    minInstancesPerNode<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb20-655"><a href="#cb20-655"></a>    maxBins<span class="op">=</span>MAX_BINS,</span>
<span id="cb20-656"><a href="#cb20-656"></a>    seed<span class="op">=</span>SEED</span>
<span id="cb20-657"><a href="#cb20-657"></a>)</span>
<span id="cb20-658"><a href="#cb20-658"></a>rf_model <span class="op">=</span> rf.fit(train_nz)</span>
<span id="cb20-659"><a href="#cb20-659"></a></span>
<span id="cb20-660"><a href="#cb20-660"></a><span class="co"># ----------- 2) Evaluate on </span><span class="al">TEST</span><span class="co"> -----------</span></span>
<span id="cb20-661"><a href="#cb20-661"></a>pred_rf <span class="op">=</span> rf_model.transform(test_nz).cache()</span>
<span id="cb20-662"><a href="#cb20-662"></a>_ <span class="op">=</span> pred_rf.count()  <span class="co"># materialize once</span></span>
<span id="cb20-663"><a href="#cb20-663"></a></span>
<span id="cb20-664"><a href="#cb20-664"></a>e_rmse <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"rmse"</span>)</span>
<span id="cb20-665"><a href="#cb20-665"></a>e_mae  <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"mae"</span>)</span>
<span id="cb20-666"><a href="#cb20-666"></a>e_r2   <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb20-667"><a href="#cb20-667"></a></span>
<span id="cb20-668"><a href="#cb20-668"></a>rmse_rf <span class="op">=</span> e_rmse.evaluate(pred_rf)</span>
<span id="cb20-669"><a href="#cb20-669"></a>mae_rf  <span class="op">=</span> e_mae.evaluate(pred_rf)</span>
<span id="cb20-670"><a href="#cb20-670"></a>r2_rf   <span class="op">=</span> e_r2.evaluate(pred_rf)</span>
<span id="cb20-671"><a href="#cb20-671"></a></span>
<span id="cb20-672"><a href="#cb20-672"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test RMSE: </span><span class="sc">{</span>rmse_rf<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-673"><a href="#cb20-673"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test MAE : </span><span class="sc">{</span>mae_rf<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-674"><a href="#cb20-674"></a><span class="bu">print</span>(<span class="ss">f"🌲 RF Test R²  : </span><span class="sc">{</span>r2_rf<span class="sc">:,.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-675"><a href="#cb20-675"></a></span>
<span id="cb20-676"><a href="#cb20-676"></a><span class="co"># ----------- 3) Feature Importances (robust) -----------</span></span>
<span id="cb20-677"><a href="#cb20-677"></a>imp_vec <span class="op">=</span> rf_model.featureImportances  <span class="co"># SparseVector</span></span>
<span id="cb20-678"><a href="#cb20-678"></a><span class="co"># Convert to dense Python list aligned to the actual vector length</span></span>
<span id="cb20-679"><a href="#cb20-679"></a><span class="cf">try</span>:</span>
<span id="cb20-680"><a href="#cb20-680"></a>    vec_len <span class="op">=</span> pred_rf.selectExpr(<span class="st">"size(features) as n"</span>).first().n</span>
<span id="cb20-681"><a href="#cb20-681"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-682"><a href="#cb20-682"></a>    vec_len <span class="op">=</span> <span class="bu">len</span>(feature_names)</span>
<span id="cb20-683"><a href="#cb20-683"></a></span>
<span id="cb20-684"><a href="#cb20-684"></a>importances <span class="op">=</span> [<span class="fl">0.0</span>] <span class="op">*</span> vec_len</span>
<span id="cb20-685"><a href="#cb20-685"></a><span class="cf">for</span> idx, val <span class="kw">in</span> <span class="bu">zip</span>(imp_vec.indices, imp_vec.values):</span>
<span id="cb20-686"><a href="#cb20-686"></a>    <span class="cf">if</span> idx <span class="op">&lt;</span> vec_len:</span>
<span id="cb20-687"><a href="#cb20-687"></a>        importances[<span class="bu">int</span>(idx)] <span class="op">=</span> <span class="bu">float</span>(val)</span>
<span id="cb20-688"><a href="#cb20-688"></a></span>
<span id="cb20-689"><a href="#cb20-689"></a><span class="co"># Align names to the vector length</span></span>
<span id="cb20-690"><a href="#cb20-690"></a><span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">!=</span> vec_len:</span>
<span id="cb20-691"><a href="#cb20-691"></a>    <span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">&gt;</span> vec_len:</span>
<span id="cb20-692"><a href="#cb20-692"></a>        feature_names <span class="op">=</span> feature_names[:vec_len]</span>
<span id="cb20-693"><a href="#cb20-693"></a>    <span class="cf">else</span>:</span>
<span id="cb20-694"><a href="#cb20-694"></a>        feature_names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feature_names), vec_len)]</span>
<span id="cb20-695"><a href="#cb20-695"></a></span>
<span id="cb20-696"><a href="#cb20-696"></a>imp_rows <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(feature_names, importances))</span>
<span id="cb20-697"><a href="#cb20-697"></a>imp_df <span class="op">=</span> spark.createDataFrame(imp_rows, [<span class="st">"feature"</span>, <span class="st">"rf_importance"</span>]).orderBy(F.desc(<span class="st">"rf_importance"</span>))</span>
<span id="cb20-698"><a href="#cb20-698"></a></span>
<span id="cb20-699"><a href="#cb20-699"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">--- Top 20 Random Forest feature importances ---"</span>)</span>
<span id="cb20-700"><a href="#cb20-700"></a>imp_df.show(<span class="dv">20</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-701"><a href="#cb20-701"></a></span>
<span id="cb20-702"><a href="#cb20-702"></a><span class="co"># Optional: save importances</span></span>
<span id="cb20-703"><a href="#cb20-703"></a><span class="co"># imp_df.coalesce(1).write.mode("overwrite").option("header", True).csv("output/rf_feature_importances")</span></span>
<span id="cb20-704"><a href="#cb20-704"></a><span class="in">```</span></span>
<span id="cb20-705"><a href="#cb20-705"></a></span>
<span id="cb20-706"><a href="#cb20-706"></a></span>
<span id="cb20-707"><a href="#cb20-707"></a></span>
<span id="cb20-708"><a href="#cb20-708"></a></span>
<span id="cb20-709"><a href="#cb20-709"></a></span>
<span id="cb20-710"><a href="#cb20-710"></a><span class="fu">## Feature Importance Plot</span></span>
<span id="cb20-711"><a href="#cb20-711"></a></span>
<span id="cb20-714"><a href="#cb20-714"></a><span class="in">```{python}</span></span>
<span id="cb20-715"><a href="#cb20-715"></a><span class="co"># ======================================================</span></span>
<span id="cb20-716"><a href="#cb20-716"></a><span class="co"># Random Forest Feature Importance — Interactive + PNG</span></span>
<span id="cb20-717"><a href="#cb20-717"></a><span class="co">#  - Robust vector length detection (Vector UDT safe)</span></span>
<span id="cb20-718"><a href="#cb20-718"></a><span class="co">#  - Interactive Plotly bar chart</span></span>
<span id="cb20-719"><a href="#cb20-719"></a><span class="co">#  - Static PNG saved to ./_output/rf_feature_importance.png</span></span>
<span id="cb20-720"><a href="#cb20-720"></a><span class="co"># ======================================================</span></span>
<span id="cb20-721"><a href="#cb20-721"></a></span>
<span id="cb20-722"><a href="#cb20-722"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb20-723"><a href="#cb20-723"></a><span class="im">from</span> pyspark.ml.functions <span class="im">import</span> vector_to_array</span>
<span id="cb20-724"><a href="#cb20-724"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb20-725"><a href="#cb20-725"></a><span class="im">import</span> os</span>
<span id="cb20-726"><a href="#cb20-726"></a></span>
<span id="cb20-727"><a href="#cb20-727"></a><span class="co"># ---------- 0) Safety: ensure train/test exist ----------</span></span>
<span id="cb20-728"><a href="#cb20-728"></a><span class="cf">try</span>:</span>
<span id="cb20-729"><a href="#cb20-729"></a>    _ <span class="op">=</span> train_nz.count()<span class="op">;</span> _ <span class="op">=</span> test_nz.count()</span>
<span id="cb20-730"><a href="#cb20-730"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb20-731"><a href="#cb20-731"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"train_nz/test_nz not found. Run the RF training cell first."</span>)</span>
<span id="cb20-732"><a href="#cb20-732"></a></span>
<span id="cb20-733"><a href="#cb20-733"></a><span class="co"># ---------- 1) Get (or fit) RF model ----------</span></span>
<span id="cb20-734"><a href="#cb20-734"></a><span class="cf">try</span>:</span>
<span id="cb20-735"><a href="#cb20-735"></a>    rf_model  <span class="co"># reuse if already trained</span></span>
<span id="cb20-736"><a href="#cb20-736"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb20-737"><a href="#cb20-737"></a>    rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb20-738"><a href="#cb20-738"></a>        featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction_rf"</span>,</span>
<span id="cb20-739"><a href="#cb20-739"></a>        numTrees<span class="op">=</span><span class="dv">200</span>, maxDepth<span class="op">=</span><span class="dv">6</span>, featureSubsetStrategy<span class="op">=</span><span class="st">"sqrt"</span>,</span>
<span id="cb20-740"><a href="#cb20-740"></a>        subsamplingRate<span class="op">=</span><span class="fl">0.8</span>, minInstancesPerNode<span class="op">=</span><span class="dv">2</span>, maxBins<span class="op">=</span><span class="dv">64</span>, seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb20-741"><a href="#cb20-741"></a>    )</span>
<span id="cb20-742"><a href="#cb20-742"></a>    rf_model <span class="op">=</span> rf.fit(train_nz)</span>
<span id="cb20-743"><a href="#cb20-743"></a></span>
<span id="cb20-744"><a href="#cb20-744"></a><span class="co"># ---------- 2) Robust feature-name extraction ----------</span></span>
<span id="cb20-745"><a href="#cb20-745"></a><span class="kw">def</span> extract_feature_names(df, features_col<span class="op">=</span><span class="st">"features"</span>):</span>
<span id="cb20-746"><a href="#cb20-746"></a>    meta <span class="op">=</span> df.schema[features_col].metadata</span>
<span id="cb20-747"><a href="#cb20-747"></a>    <span class="cf">try</span>:</span>
<span id="cb20-748"><a href="#cb20-748"></a>        attrs <span class="op">=</span> meta[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb20-749"><a href="#cb20-749"></a>        names <span class="op">=</span> []</span>
<span id="cb20-750"><a href="#cb20-750"></a>        <span class="cf">for</span> typ <span class="kw">in</span> (<span class="st">"binary"</span>, <span class="st">"numeric"</span>):</span>
<span id="cb20-751"><a href="#cb20-751"></a>            <span class="cf">if</span> typ <span class="kw">in</span> attrs:</span>
<span id="cb20-752"><a href="#cb20-752"></a>                <span class="cf">for</span> a <span class="kw">in</span> attrs[typ]:</span>
<span id="cb20-753"><a href="#cb20-753"></a>                    names.append(a.get(<span class="st">"name"</span>, <span class="ss">f"f_</span><span class="sc">{</span>a<span class="sc">.</span>get(<span class="st">'idx'</span>, <span class="bu">len</span>(names))<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb20-754"><a href="#cb20-754"></a>        <span class="cf">return</span> names</span>
<span id="cb20-755"><a href="#cb20-755"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-756"><a href="#cb20-756"></a>        size <span class="op">=</span> df.selectExpr(<span class="ss">f"size(</span><span class="sc">{</span>features_col<span class="sc">}</span><span class="ss">) as n"</span>).first().n</span>
<span id="cb20-757"><a href="#cb20-757"></a>        <span class="cf">return</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size)]</span>
<span id="cb20-758"><a href="#cb20-758"></a></span>
<span id="cb20-759"><a href="#cb20-759"></a><span class="cf">try</span>:</span>
<span id="cb20-760"><a href="#cb20-760"></a>    feature_names <span class="op">=</span> feat_names  <span class="co"># reuse from earlier if available</span></span>
<span id="cb20-761"><a href="#cb20-761"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb20-762"><a href="#cb20-762"></a>    feature_names <span class="op">=</span> extract_feature_names(train_nz, <span class="st">"features"</span>)</span>
<span id="cb20-763"><a href="#cb20-763"></a></span>
<span id="cb20-764"><a href="#cb20-764"></a><span class="co"># ---------- 3) Vector length (no AnalysisException) ----------</span></span>
<span id="cb20-765"><a href="#cb20-765"></a><span class="cf">try</span>:</span>
<span id="cb20-766"><a href="#cb20-766"></a>    <span class="co"># Convert Vector UDT -&gt; array, then size()</span></span>
<span id="cb20-767"><a href="#cb20-767"></a>    vec_len <span class="op">=</span> train_nz.select(</span>
<span id="cb20-768"><a href="#cb20-768"></a>        F.size(vector_to_array(F.col(<span class="st">"features"</span>))).alias(<span class="st">"n"</span>)</span>
<span id="cb20-769"><a href="#cb20-769"></a>    ).first().n</span>
<span id="cb20-770"><a href="#cb20-770"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-771"><a href="#cb20-771"></a>    <span class="co"># Fallback to the trained model’s importances size</span></span>
<span id="cb20-772"><a href="#cb20-772"></a>    vec_len <span class="op">=</span> <span class="bu">int</span>(<span class="bu">getattr</span>(rf_model.featureImportances, <span class="st">"size"</span>, <span class="bu">len</span>(feature_names)))</span>
<span id="cb20-773"><a href="#cb20-773"></a></span>
<span id="cb20-774"><a href="#cb20-774"></a><span class="co"># Align names to actual vector size</span></span>
<span id="cb20-775"><a href="#cb20-775"></a><span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">!=</span> vec_len:</span>
<span id="cb20-776"><a href="#cb20-776"></a>    <span class="cf">if</span> <span class="bu">len</span>(feature_names) <span class="op">&gt;</span> vec_len:</span>
<span id="cb20-777"><a href="#cb20-777"></a>        feature_names <span class="op">=</span> feature_names[:vec_len]</span>
<span id="cb20-778"><a href="#cb20-778"></a>    <span class="cf">else</span>:</span>
<span id="cb20-779"><a href="#cb20-779"></a>        feature_names <span class="op">+=</span> [<span class="ss">f"feature_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(feature_names), vec_len)]</span>
<span id="cb20-780"><a href="#cb20-780"></a></span>
<span id="cb20-781"><a href="#cb20-781"></a><span class="co"># ---------- 4) Build importances table ----------</span></span>
<span id="cb20-782"><a href="#cb20-782"></a>imp_vec <span class="op">=</span> rf_model.featureImportances  <span class="co"># SparseVector</span></span>
<span id="cb20-783"><a href="#cb20-783"></a>importances <span class="op">=</span> [<span class="fl">0.0</span>] <span class="op">*</span> vec_len</span>
<span id="cb20-784"><a href="#cb20-784"></a><span class="cf">for</span> idx, val <span class="kw">in</span> <span class="bu">zip</span>(imp_vec.indices, imp_vec.values):</span>
<span id="cb20-785"><a href="#cb20-785"></a>    <span class="cf">if</span> <span class="bu">int</span>(idx) <span class="op">&lt;</span> vec_len:</span>
<span id="cb20-786"><a href="#cb20-786"></a>        importances[<span class="bu">int</span>(idx)] <span class="op">=</span> <span class="bu">float</span>(val)</span>
<span id="cb20-787"><a href="#cb20-787"></a></span>
<span id="cb20-788"><a href="#cb20-788"></a>imp_rows <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(feature_names, importances))</span>
<span id="cb20-789"><a href="#cb20-789"></a>imp_df <span class="op">=</span> spark.createDataFrame(imp_rows, [<span class="st">"feature"</span>, <span class="st">"rf_importance"</span>]) <span class="op">\</span></span>
<span id="cb20-790"><a href="#cb20-790"></a>              .orderBy(F.desc(<span class="st">"rf_importance"</span>))</span>
<span id="cb20-791"><a href="#cb20-791"></a></span>
<span id="cb20-792"><a href="#cb20-792"></a>topN <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb20-793"><a href="#cb20-793"></a>top_df <span class="op">=</span> imp_df.limit(topN)</span>
<span id="cb20-794"><a href="#cb20-794"></a>top_pd <span class="op">=</span> top_df.toPandas()</span>
<span id="cb20-795"><a href="#cb20-795"></a></span>
<span id="cb20-796"><a href="#cb20-796"></a><span class="co"># ---------- 5) Interactive bar (Plotly) ----------</span></span>
<span id="cb20-797"><a href="#cb20-797"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb20-798"><a href="#cb20-798"></a></span>
<span id="cb20-799"><a href="#cb20-799"></a>fig <span class="op">=</span> px.bar(</span>
<span id="cb20-800"><a href="#cb20-800"></a>    top_pd.sort_values(<span class="st">"rf_importance"</span>, ascending<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb20-801"><a href="#cb20-801"></a>    x<span class="op">=</span><span class="st">"rf_importance"</span>, y<span class="op">=</span><span class="st">"feature"</span>,</span>
<span id="cb20-802"><a href="#cb20-802"></a>    orientation<span class="op">=</span><span class="st">"h"</span>,</span>
<span id="cb20-803"><a href="#cb20-803"></a>    title<span class="op">=</span><span class="ss">f"Top </span><span class="sc">{</span>topN<span class="sc">}</span><span class="ss"> Random Forest Feature Importances"</span>,</span>
<span id="cb20-804"><a href="#cb20-804"></a>    labels<span class="op">=</span>{<span class="st">"rf_importance"</span>: <span class="st">"Importance"</span>, <span class="st">"feature"</span>: <span class="st">"Feature"</span>},</span>
<span id="cb20-805"><a href="#cb20-805"></a>)</span>
<span id="cb20-806"><a href="#cb20-806"></a>fig.update_layout(yaxis<span class="op">=</span><span class="bu">dict</span>(dtick<span class="op">=</span><span class="dv">1</span>), margin<span class="op">=</span><span class="bu">dict</span>(l<span class="op">=</span><span class="dv">10</span>, r<span class="op">=</span><span class="dv">10</span>, t<span class="op">=</span><span class="dv">40</span>, b<span class="op">=</span><span class="dv">10</span>))</span>
<span id="cb20-807"><a href="#cb20-807"></a>fig.show()</span>
<span id="cb20-808"><a href="#cb20-808"></a></span>
<span id="cb20-809"><a href="#cb20-809"></a><span class="co"># ---------- 6) Save static PNG to ./_output/ ----------</span></span>
<span id="cb20-810"><a href="#cb20-810"></a><span class="co"># Use matplotlib (and seaborn if available) to avoid Plotly/kaleido dependency.</span></span>
<span id="cb20-811"><a href="#cb20-811"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb20-812"><a href="#cb20-812"></a><span class="cf">try</span>:</span>
<span id="cb20-813"><a href="#cb20-813"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb20-814"><a href="#cb20-814"></a>    use_sns <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-815"><a href="#cb20-815"></a><span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-816"><a href="#cb20-816"></a>    use_sns <span class="op">=</span> <span class="va">False</span></span>
<span id="cb20-817"><a href="#cb20-817"></a></span>
<span id="cb20-818"><a href="#cb20-818"></a>os.makedirs(<span class="st">"_output"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-819"><a href="#cb20-819"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb20-820"><a href="#cb20-820"></a>plot_data <span class="op">=</span> top_pd.sort_values(<span class="st">"rf_importance"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-821"><a href="#cb20-821"></a></span>
<span id="cb20-822"><a href="#cb20-822"></a><span class="cf">if</span> use_sns:</span>
<span id="cb20-823"><a href="#cb20-823"></a>    ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>plot_data, x<span class="op">=</span><span class="st">"rf_importance"</span>, y<span class="op">=</span><span class="st">"feature"</span>)</span>
<span id="cb20-824"><a href="#cb20-824"></a><span class="cf">else</span>:</span>
<span id="cb20-825"><a href="#cb20-825"></a>    ax <span class="op">=</span> plt.barh(plot_data[<span class="st">"feature"</span>], plot_data[<span class="st">"rf_importance"</span>])</span>
<span id="cb20-826"><a href="#cb20-826"></a></span>
<span id="cb20-827"><a href="#cb20-827"></a>plt.xlabel(<span class="st">"Importance"</span>)</span>
<span id="cb20-828"><a href="#cb20-828"></a>plt.ylabel(<span class="st">"Feature"</span>)</span>
<span id="cb20-829"><a href="#cb20-829"></a>plt.title(<span class="ss">f"Top </span><span class="sc">{</span>topN<span class="sc">}</span><span class="ss"> Random Forest Feature Importances"</span>)</span>
<span id="cb20-830"><a href="#cb20-830"></a>plt.tight_layout()</span>
<span id="cb20-831"><a href="#cb20-831"></a>plt.savefig(<span class="st">"_output/rf_feature_importance.png"</span>, dpi<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb20-832"><a href="#cb20-832"></a>plt.close()</span>
<span id="cb20-833"><a href="#cb20-833"></a></span>
<span id="cb20-834"><a href="#cb20-834"></a><span class="bu">print</span>(<span class="st">"✅ Saved static plot to: _output/rf_feature_importance.png"</span>)</span>
<span id="cb20-835"><a href="#cb20-835"></a></span>
<span id="cb20-836"><a href="#cb20-836"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>